// JayData 1.3.0
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
(function(d,h){function k(a,b){"undefined"===typeof b&&(b=b||m++);var c=a.cacheKey;if("undefined"===typeof c)c=a.cacheKey=n++,d.displayCache[a.cacheKey]={value:a,references:[b]};else{var e=d.displayCache[c];0>e.references.indexOf(b)&&e.references.push(b)}return{cacheKey:c,clientId:b}}var l=d.Entity.inheritedTypeProcessor,j={templateResolvers:[function(a,b){if(b)return(b=b.trim())?"<"===b[0]||"{"===b[0]?b:void 0:void 0},function(){},function(a,b){if(!b)var c=d.Container.resolveName(a).split("."),b=
c[c.length-1];return $("#"+b).html()}],templateCompiler:function(a){return h.compile(a)},templateCache:{},getTemplate:function(a,b){var c,e,d=a.fullName+"::"+b;e=c=this.templateCache[d];for(i=0;!c&&i<this.templateResolvers.length;)c=this.templateResolvers[i++](a,b);c&&!e&&(c=this.templateCache[d]=this.templateCompiler(c));c||console.log("Can not find template: "+b);return c}};d.templateEngine=j;d.render=function(a,b){if(a instanceof d.Entity)return a.render(b);var c,e=Array.isArray(a)?a[0]:a,f;for(f in e)e.hasOwnProperty(f)&&
(c+=f+"::");return j.getTemplate({fullName:c},b)(a)};d.renderItems=function(a,b){for(var c="",e=0;e<a.length;e++)c+=d.render(a[e],b);return c};d.renderTo=function(a,b,c){c=c||"replaceContent";return function(e){"replaceContent"===c&&$(a).empty();var f;f=d.render(e,b);switch(c){case "append":case "replaceContent":$(a).append(f);break;case "replace":$(a).replaceWith(f);break;case "after":$(a).after(f);break;case "before":$(a).before(f)}return e}};d.renderItemsTo=function(a,b,c){c=c||"replaceContent";
return function(e){"replaceContent"===c&&$(a).empty();var f;f=d.renderItems(e,b);switch(c){case "append":case "replaceContent":$(a).append(f);break;case "replace":$(a).replaceWith(f);break;case "after":$(a).after(f);break;case "before":$(a).before(f)}return e}};d.Entity.inheritedTypeProcessor=function(a){function b(c,b){var f=j.getTemplate(a,b);c instanceof d.Entity||(c=new a(c));return f(c)}l&&l(a);a.render=b;a.renderItems=function(a,e){for(var d="",g=0;g<a.length;g++)d+=b(a[g],e);return d};a.addCommand=
function(c,b,f,g){g=g||document;"function"===typeof b&&(f=b,b="click");var h=a.fullName.split("."),c="[data-command='"+c+"'][data-type='"+h[h.length-1]+"']";$(g).delegate(c,b,function(){var a=$(this).data("cache-item"),a=d.displayCache[a].value;$(this).data("id");f.apply(a,[a,this,$(this).data("id")])})};a.renderTo=function(c,b,f,g){if("object"!==typeof c)return replaceMode=f,f=b,b=c,a.readAll().then(d.renderTo(b,f,g));throw Error("Not implemented");};a.renderItemsTo=function(b,e,f,g){if(!Array.isArray(b))return replaceMode=
f,f=e,e=b,a.readAll().then(d.renderItemsTo(e,f,g));throw Error("Not implemented");}};d.Entity.prototype.render=function(a){return this.getType().render(this,a)};d.Entity.prototype.renderTo=function(a,b,c){return d.renderTo(a,b,c)(this)};d.Queryable.prototype.renderTo=function(a,b,c){return this.toArray().then(function(e){return d.renderTo(a,b,c)(e)})};d.Queryable.prototype.renderItemsTo=function(a,b,c){return this.toArray().then(function(e){return d.renderItemsTo(a,b,c)(e)})};Object.defineProperty(d.Entity.prototype,
"fields",{get:function(){var a=this,b=[];this.getType().memberDefinitions.getPublicMappedProperties().forEach(function(c){var d=c.name;"property"===c.kind&&(c={name:c.name,metadata:c},Object.defineProperty(c,"value",{get:function(){return a[d]}}),b.push(c))});return b}});h.registerHelper("renderEntity",function(a){2>arguments.length&&(a=void 0);return new h.SafeString(d.render(this,a))});d.displayCache={};var n=0,m=0;h.registerHelper("entityScope",function(){var a=d.Container.resolveName(this.getType()).split("."),
a=a[a.length-1],b=this[this.getType().memberDefinitions.getKeyProperties()[0].name],a="data-"+a.toLowerCase()+"-"+b,b=k(this),a=a+(" data-cache-client="+b.clientId);return a+=" data-cache-item="+b.cacheKey});h.registerHelper("entityCommand",function(a){d.entityCache=d.entityCache||{};var b=d.Container.resolveName(this.getType()).split("."),b=b[b.length-1],c=this[this.getType().memberDefinitions.getKeyProperties()[0].name],e=b+":"+c;d.entityCache[e]||(d.entityCache[e]=this);a="data-command="+a+" data-type="+
b+" data-id="+c;b=k(this);a+=" data-cache-client="+b.clientId;return a+=" data-cache-item="+b.cacheKey});d.setCommandHandler=function(a,b){$(b||document).delegate("[data-command]","click",function(){$(this).data("type");$(this).data("id");var b=a[$(this).data("command")+$(this).data("type")],e=$(this).data("cache-item"),e=[d.displayCache[e].value,$(this).data("id")];b.apply(a,e)})};$(document).delegate(".single-select","click",function(a){a=$(a.srcElement).parentsUntil(this);$(this).children().removeClass("active");
a.addClass("active")})})($data,Handlebars);
