// JayData 1.3.0
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
(function(g){var l=g.Entity.inheritedTypeProcessor;g.kendo={};g.kendo.BaseModelType=kendo.data.Model.define({init:function(a){kendo.data.Model.fn.init.call(this,a)}});var o={"$data.Blob":"string","$data.String":"string","$data.Boolean":"boolean","$data.Integer":"number","$data.Number":"number","$data.Date":"date"};g.Entity.inheritedTypeProcessor=function(a){function f(c){var d=a.memberDefinitions,e={};d.getPublicMappedProperties().forEach(function(a){var b=g.Container.resolveName(a.type);e[a.name]=
{type:o[b]||"object",nullable:"$data.Boolean"===b?!0:!0!==a.required,defaultValue:a.defaultValue,editable:!a.computed,validation:{required:"$data.Boolean"===b?!1:a.required||"nullable"in a?!a.nullable:!1}}});var b={fields:e,init:function(b){var d=[];c&&c.owningContextType&&(d=c.owningContextType.memberDefinitions.getPublicMappedProperties().filter(function(a){return g.Container.resolveType(a.type)===g.EntitySet}).map(function(a){return g.Container.resolveType(a.elementType)}));var e={entityBuilder:function(a,
c){c.forEach(function(c){if(!0!==c.key&&(!0===c.required||!1===c.nullable)){var h=g.Container.resolveType(c.type);if(h.isAssignableTo&&h.isAssignableTo(g.Entity)&&-1===d.indexOf(h)){var f;b&&(f=b[c.name]);a[c.name]=new h(f,e)}}})}},h=b instanceof a?b:new a(b,e),f=h.initData,k={},j;for(j in f){var p=a.getMemberDefinition(j),i=f[j];if(i instanceof g.Entity)i=i.asKendoObservable(),k[j]=i;else if(p&&g.Container.resolveType(p.type)===Array){var l=i=g.Container.resolveType(p.elementType);i.asKendoModel&&
(l=i.asKendoModel());i=new kendo.data.ObservableArray(f[j],l);k[j]=i;k[j].bind("change",function(){h.changeFromKendo=!0;this.parent().dirty=!0;h[p.name]=this.toJSON();delete h.changeFromKendo})}else k[j]=i}i=a.memberDefinitions.getPublicMappedProperties().filter(function(a){return g.Container.resolveType(a.dataType)===Array&&!g.Container.resolveType(a.elementType).asKendoModel});for(j=0;j<i.length;j++){var m=i[j];if(null===f[m.name]||void 0===f[m.name])k[m.name]=new kendo.data.ObservableArray([],
g.Container.resolveType(m.elementType)),k[m.name].bind("change",function(){h.changeFromKendo=!0;this.parent().dirty=!0;h[m.name]=this.toJSON();delete h.changeFromKendo})}var o=this;this.innerInstance=function(){return h};g.kendo.BaseModelType.fn.init.call(this,k);h.propertyChanged.attach(function(a,b){var c=b.newValue;this.changeFromKendo||(c&&c.asKendoObservable&&c.asKendoObservable(),h.changeFromJay=!0,o.set(b.propertyName,b.newValue),delete h.changeFromJay)});this.bind("set",function(a){var b=
a.field,d=b.split(".");h.changeFromKendo=!0;1==d.length?(d=a.value,h.changeFromJay||(d=d.innerInstance?d.innerInstance():d,h[b]=d,c&&c.autoSave&&h.save())):(b=h[d[0]],b instanceof g.Entity&&(h[d[0]]=b));delete h.changeFromKendo});c&&c.newInstanceCallback&&c.newInstanceCallback(h)},save:function(){return this.innerInstance().save()},remove:function(){return this.innerInstance().remove()}},d=d.getKeyProperties();switch(d.length){case 0:break;case 1:b.id=d[0].name;break;default:console.warn("entity with multiple keys not supported")}console.log("md",
b);return kendo.data.Model.define(g.kendo.BaseModelType,b)}function e(a,d){if(d.provider){var e=(d.databaseName||"")+(d.tableName||"")+(d.url||"")+(d.apiUrl||"")+(d.oDataServiceHost||""),b={provider:d.provider,databaseName:d.databaseName,tableName:d.tableName,dataSource:d.url,apiUrl:d.apiUrl,oDataServiceHost:d.oDataServiceHost};Object.keys(b).forEach(function(a){delete d[a]});a.setStore(e,b);return e}}a.asKendoModel=function(c){var d=c||a;return d.kendoModelType||(d.kendoModelType=f(c))};a.prototype.asKendoObservable=
function(c){return new (a.asKendoModel(c))(this)};a.asKendoDataSource=function(c,d,f){c=c||{};d=d||{};f=e(a,c)||f;f=g.ItemStore._getStoreAlias(a,f);return g.ItemStore._getContextPromise(f,a).getEntitySetFromElementType(a).asKendoDataSource(c,d)};l&&l(a)};g.Queryable.addMember("asKendoColumns",function(a){function f(a){a=Array.isArray(a)?a:[a];a=this.concat(a);return d(a)}function e(a){a=Array.isArray(a)?a:[a];a=a.concat(this);return d(a)}function c(a,b){var c=this.filter(function(b){return b.field==
a})[0];$.extend(c,b);return this}function d(a){a.prepend=e;a.append=f;a.setColumn=c;return a}var k=[],a=a||{},b=!0===a.$showComplexFields;delete a.$showComplexFields;this.defaultType.memberDefinitions.getPublicMappedProperties().forEach(function(c){if(b||o[g.Container.resolveName(c.type)]){var d={field:c.name};$.extend(d,a[c.name]||{});k.push(d)}});return d(k)});g.EntityContext.addProperty("EntitySetNames",function(){var a=this;return Object.keys(a._entitySetReferences).map(function(f){return a._entitySetReferences[f].tableName})});
g.Queryable.addMember("asKendoModel",function(a){a.owningContextType=a.owningContextType||this.entityContext.getType();return this.defaultType.asKendoModel(a)});g.Queryable.addMember("asKendoRemoteTransportClass",function(){var a=this,f=a.entityContext;return kendo.data.RemoteTransport.extend({init:function(){this.items=[]},read:function(e){a.entityContext.onReady().then(function(){var c=a,d=a.entityContext.storageProvider.supportedSetOperations.withInlineCount,f=!d&&a.entityContext.storageProvider.supportedSetOperations.length;
d&&(c=c.withInlineCount());if(e.data.filter){var b="",g={};e.data.filter.filters.forEach(function(a,c){0<c&&(b+="or"==e.data.filter.logic?" || ":" && ");switch(a.operator){case "eq":b+="it."+a.field;b+=" == this."+a.field;break;case "neq":b+="it."+a.field;b+=" != this."+a.field;break;case "startswith":b+="it."+a.field;b+=".startsWith(this."+a.field+")";break;case "contains":b+="it."+a.field;b+=".contains(this."+a.field+")";break;case "doesnotcontain":b+="!";b+="it."+a.field;b+=".contains(this."+a.field+
")";break;case "endswith":b+="it."+a.field;b+=".endsWith(this."+a.field+")";break;case "gte":b+="it."+a.field;b+=" >= this."+a.field;break;case "gt":b+="it."+a.field;b+=" > this."+a.field;break;case "lte":b+="it."+a.field;b+=" <= this."+a.field;break;case "lt":b+="it."+a.field;b+=" < this."+a.field;break;default:console.log("unknown operator",a.operator)}g[a.field]=a.value});c=c.filter(b,g)}var l=c;e.data.sort&&e.data.sort.forEach(function(a){c=c.order(("desc"==a.dir?"-":"")+a.field)});e.data.skip&&
(c=c.skip(e.data.skip));e.data.take&&(c=c.take(e.data.take));var n=[];n.push(c.toArray());f?n.push(l.length()):d||n.push(l.toArray());console.log(n);jQuery.when.apply(this,n).then(function(a,b){console.dir(arguments);var c={data:a.map(function(a){return a.asKendoObservable()}),total:d?a.totalCount:f?b:b.length};console.log(c);e.success(c)}).fail(function(){console.log("error in create");e.error({},arguments)})})},create:function(e,c){a.entityContext.onReady().then(function(){if(1<c.length){var a=
[];c.forEach(function(c){a.push(c.innerInstance())});f.addMany(a);f.saveChanges().then(function(){var c=[];a.forEach(function(a){c.push(a.initData)});e.success({data:c})}).fail(function(){console.log("error in create");e.error({},arguments);f.stateManager.reset()})}else console.dir(f.storeToken),c[0].innerInstance().save(f.storeToken).then(function(){e.success({data:c[0].innerInstance().initData})}).fail(function(){console.log("error in create");e.error({},arguments)})})},update:function(e,c){a.entityContext.onReady().then(function(){1<
c.length?(c.map(function(a){return a.innerInstance()}).forEach(function(a){f.attach(a,!0)}),f.saveChanges().then(function(){e.success()}).fail(function(){f.stateManager.reset();e.error({},arguments)})):c[0].innerInstance().save().then(function(){e.success()}).fail(function(){e.error({},arguments)})})},destroy:function(e,c){a.entityContext.onReady().then(function(){1<c.length?(c.forEach(function(a){f.remove(a.innerInstance())}),f.saveChanges().then(function(){e.success({data:e.data})}).fail(function(){f.stateManager.reset();
e.error({},"error",e.data)})):c[0].innerInstance().remove().then(function(){e.success({data:e.data})}).fail(function(){f.stateManager.reset();e.error({},"error",e.data)})})},setup:function(){console.log("setup");console.dir(arguments)}})});var q=kendo.data.DataSource.extend({init:function(){kendo.data.DataSource.fn.init.apply(this,arguments)},createItem:function(a){return new this.options.schema.model(a)},_promise:function(a,f,e){var c=this,d=$.extend,g=c.transport;return $.Deferred(function(b){g[e].call(g,
d({success:function(a){b.resolve({response:a,models:f,type:e})},error:function(a,d,e){b.reject(a);c.error(a,d,e)}},a),f)}).promise()}});g.kendo=g.kendo||{};g.kendo.defaultPageSize=25;g.Queryable.addMember("asKendoDataSource",function(a,f){var f=f||{},e=this.asKendoModel(f),a=a||{};a.serverPaging=a.serverPaging||!0;a.serverFiltering=a.serverFiltering||!0;a.serverSorting=a.serverSorting||!0;a.pageSize=void 0===a.pageSize?g.kendo.defaultPageSize:a.pageSize;var c=this.asKendoRemoteTransportClass(e);a.transport=
new c;a.schema={model:e,data:"data",total:"total"};return new q(a)});kendo.data.binders.submit=kendo.data.Binder.extend({init:function(a,f,e){kendo.data.Binder.fn.init.call(this,a,f,e);$(a).bind("submit",function(){var a=f.submit.source,d=a[f.submit.path];if("function"===typeof d)return d.apply(a,arguments),!1})},refresh:function(){}})})($data);
