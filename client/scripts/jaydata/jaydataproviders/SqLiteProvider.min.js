// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$data.Class.define("$data.dbClient.DbCommand",null,null,{connection:{},parameters:{},execute:function(){Guard.raise("Pure class")}},null);$data.Class.define("$data.dbClient.DbConnection",null,null,{connectionParams:{},database:{},isOpen:function(){Guard.raise("Pure class")},open:function(){Guard.raise("Pure class")},close:function(){Guard.raise("Pure class")},createCommand:function(){Guard.raise("Pure class")}},null);
$data.Class.define("$data.dbClient.openDatabaseClient.OpenDbCommand",$data.dbClient.DbCommand,null,{constructor:function(a,b,c){this.query=b;this.connection=a;this.parameters=c},executeNonQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},executeQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},exec:function(a,b,c,d){this.connection.open({success:function(e){function f(){0==
--i&&c(g?h[0]:h)}var g=!1;a instanceof Array||(g=!0,a=[a],b=[b]);var h=[],i=0;a.forEach(function(c,g){i++;if(c)e.executeSql(a[g],b[g],function(a,b){var d={rows:[]};try{d.insertId=b.insertId}catch(c){d.rowsAffected=b.rowsAffected;for(var e=b.rows.length,i=0;i<e;i++)d.rows.push(b.rows.item(i))}h[g]=d;f()},function(a,b){d&&d(b)});else{h[g]=null;f()}})}})}},null);
$data.Class.define("$data.dbClient.openDatabaseClient.OpenDbConnection",$data.dbClient.DbConnection,null,{constructor:function(a){this.connectionParams=a},isOpen:function(){return null!==this.database&&void 0!==this.database&&null!==this.transaction&&void 0!==this.transaction},open:function(a){if(!this.database){var b=this.connectionParams;this.database=openDatabase(b.fileName,b.version,b.displayName,b.maxSize)}this.database.transaction(function(b){a.success(b)})},close:function(){this.database=this.transaction=
void 0},createCommand:function(a,b){return new $data.dbClient.openDatabaseClient.OpenDbCommand(this,a,b)}},null);
$data.Class.define("$data.dbClient.jayStorageClient.JayStorageCommand",$data.dbClient.DbCommand,null,{constructor:function(a,b,c){this.query=b;this.connection=a;this.parameters=c},executeNonQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},executeQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},exec:function(a,b,c,d){if(null==b||void 0==b)b={};var e=!1;a instanceof
Array||(e=!0,a=[a],b=[b]);var f=[],g=a.length,h=function(){--g==0&&c(e?f[0]:f)};a.forEach(function(a,c){if(a)$data.ajax({url:"http"+(this.connection.connectionParams.storage.ssl?"s":"")+"://"+this.connection.connectionParams.storage.src.replace("http://","").replace("https://","")+"?db="+this.connection.connectionParams.storage.key,type:"POST",headers:{"X-PINGOTHER":"pingpong"},data:{query:a,parameters:b[c]},dataType:"json",contentType:"application/json;charset=UTF-8",success:function(a){if(a&&a.error){console.log("JayStorage error",
a.error);d(a.error)}else{f[c]=this.lastID?{insertId:this.lastID,rows:(a||{rows:[]}).rows}:{rows:(a||{rows:[]}).rows};h()}}});else{f[c]=null;h()}},this)}},null);$data.Class.define("$data.dbClient.jayStorageClient.JayStorageConnection",$data.dbClient.DbConnection,null,{constructor:function(a){this.connectionParams=a},isOpen:function(){return!0},open:function(){},close:function(){},createCommand:function(a,b){return new $data.dbClient.jayStorageClient.JayStorageCommand(this,a,b)}},null);
$data.Class.define("$data.dbClient.sqLiteNJClient.SqLiteNjCommand",$data.dbClient.DbCommand,null,{constructor:function(a,b,c){this.query=b;this.connection=a;this.parameters=c},executeNonQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},executeQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},exec:function(a,b,c,d){this.connection.isOpen()||this.connection.open();
if(null==b||void 0==b)b={};var e=!1;a instanceof Array||(e=!0,a=[a],b=[b]);var f=this,g=[],h=0,i=function(){if(--h==0){f.connection.database.exec("COMMIT");c(e?g[0]:g)}};f.connection.database.exec("BEGIN");a.forEach(function(a,c){h++;if(a){var e=function(a,b){if(a!=null)d(a);else{g[c]=this.lastID?{insertId:this.lastID,rows:[]}:{rows:b};i()}},k=f.connection.database.prepare(a,b[c]);a.indexOf("SELECT")==0?k.all(e):k.run(e);k.finalize()}else{g[c]=null;i()}},this)}},null);
$data.Class.define("$data.dbClient.sqLiteNJClient.SqLiteNjConnection",$data.dbClient.DbConnection,null,{constructor:function(a){this.connectionParams=a},isOpen:function(){return null!==this.database&&void 0!==this.database},open:function(){null==this.database&&(this.database=new sqLiteModule.Database(this.connectionParams.fileName))},close:function(){},createCommand:function(a,b){return new $data.dbClient.sqLiteNJClient.SqLiteNjCommand(this,a,b)}},null);
$data.Class.define("$data.storageProviders.sqLite.SqLiteStorageProvider",$data.StorageProviderBase,null,{constructor:function(a,b){this.SqlCommands=[];this.context=b;this.providerConfiguration=$data.typeSystem.extend({databaseName:"JayDataDemo",version:"",displayName:"JayData demo db",maxSize:1048576,dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged},a);this.context&&this.context._buildDbType_generateConvertToFunction&&this.buildDbType_generateConvertToFunction&&(this.context._buildDbType_generateConvertToFunction=
this.buildDbType_generateConvertToFunction);this.context&&this.context._buildDbType_modifyInstanceDefinition&&this.buildDbType_modifyInstanceDefinition&&(this.context._buildDbType_modifyInstanceDefinition=this.buildDbType_modifyInstanceDefinition)},_createSqlConnection:function(){var a={fileName:this.providerConfiguration.databaseName,version:"",displayName:this.providerConfiguration.displayName,maxSize:this.providerConfiguration.maxSize,storage:this.providerConfiguration.storage};if(this.connection)return this.connection;
var b=null;return this.connection=b=this.providerConfiguration.storage?new $data.dbClient.jayStorageClient.JayStorageConnection(a):"undefined"!==typeof sqLiteModule?new $data.dbClient.sqLiteNJClient.SqLiteNjConnection(a):new $data.dbClient.openDatabaseClient.OpenDbConnection(a)},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date],writable:!1},fieldConverter:{value:{fromDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},
"$data.Date":function(a){return new Date(a)},"$data.String":function(a){return a},"$data.Boolean":function(a){return 1===a?!0:!1},"$data.Blob":function(a){return a}},toDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},"$data.Date":function(a){return a?a.valueOf():null},"$data.String":function(a){return a},"$data.Boolean":function(a){return a?1:0},"$data.Blob":function(a){return a}}}},supportedFieldOperations:{value:{length:{dataType:"number",allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.ProjectionExpression]},substr:{dataType:"string",allowedIn:$data.Expressions.FilterExpression,parameters:[{name:"startFrom",dataType:"number"},{name:"length",dataType:"number"}]},toLowerCase:{dataType:"string",mapTo:"lower"},toUpperCase:{dataType:"string",mapTo:"upper"},contains:{mapTo:"like",dataType:"boolean",allowedIn:$data.Expressions.FilterExpression,parameters:[{name:"strFragment",dataType:"string",prefix:"%",suffix:"%"}]},startsWith:{mapTo:"like",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.ProjectionExpression],parameters:[{name:"strFragment",dataType:"string",suffix:"%"}]},endsWith:{mapTo:"like",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],parameters:[{name:"strFragment",dataType:"string",prefix:"%"}]},trim:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"trim",parameters:[{name:"@expression",dataType:$data.String},{name:"chars",dataType:$data.String}]},
ltrim:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"ltrim",parameters:[{name:"@expression",dataType:$data.String},{name:"chars",dataType:$data.String}]},rtrim:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"rtrim",parameters:[{name:"@expression",dataType:$data.String},{name:"chars",dataType:$data.String}]}},enumerable:!0,writable:!0},supportedBinaryOperators:{value:{equal:{mapTo:"=",
dataType:"boolean"},notEqual:{mapTo:"!=",dataType:"boolean"},equalTyped:{mapTo:"=",dataType:"boolean"},notEqualTyped:{mapTo:"!=",dataType:"boolean"},greaterThan:{mapTo:">",dataType:"boolean"},greaterThanOrEqual:{mapTo:">=",dataType:"boolean"},lessThan:{mapTo:"<",dataType:"boolean"},lessThenOrEqual:{mapTo:"<=",dataType:"boolean"},or:{mapTo:"OR",dataType:"boolean"},and:{mapTo:"AND",dataType:"boolean"},add:{mapTo:"+",dataType:"number"},divide:{mapTo:"/"},multiply:{mapTo:"*"},subtract:{mapTo:"-"},modulo:{mapTo:"%"},
orBitwise:{maptTo:"|"},andBitwsise:{mapTo:"&"},"in":{mapTo:"in",dataType:"boolean"}}},supportedUnaryOperators:{value:{not:{mapTo:"not"},positive:{mapTo:"+"},negative:{maptTo:"-"}}},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{},include:{}},enumerable:!0,writable:!0},buildDbType_modifyInstanceDefinition:function(a,b){var c=function(a){var b=JSON.parse(JSON.stringify(a));b.dataType=Container.resolveType(a.dataType);
b.key=!1;b.computed=!1;return b},d=function(a,b,d,c){var i={};i[a.name]=d;i[b.name]=c+"__"+d;return i};b.Associations&&b.Associations.forEach(function(b){var f=!1,g=b.FromType,h=b.ToType,i=b.ToPropertyName;b.ReferentialConstraint=b.ReferentialConstraint||[];if("*"==b.FromMultiplicity&&"0..1"==b.ToMultiplicity||"0..1"==b.FromMultiplicity&&"1"==b.ToMultiplicity)g=b.ToType,h=b.FromType,i=b.FromPropertyName,f=!0;g.memberDefinitions.getPublicMappedProperties().filter(function(a){return a.key}).forEach(function(j){f&&
(a[i+"__"+j.name]=c(j));b.ReferentialConstraint.push(d(g,h,j.name,i))},this)},this);b.ComplexTypes&&b.ComplexTypes.forEach(function(b){b.ReferentialConstraint=b.ReferentialConstraint||[];b.ToType.memberDefinitions.getPublicMappedProperties().forEach(function(f){a[b.FromPropertyName+"__"+f.name]=c(f);b.ReferentialConstraint.push(d(b.ToType,b.FromType,f.name,b.FromPropertyName))},this)},this)},buildDbType_generateConvertToFunction:function(a){return function(b){var c=new a.PhysicalType;c.entityState=
b.entityState;a.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a){c[a.name]=b[a.name]},this);a.Associations&&a.Associations.forEach(function(a){if("*"==a.FromMultiplicity&&"0..1"==a.ToMultiplicity||"0..1"==a.FromMultiplicity&&"1"==a.ToMultiplicity){var e=b[a.FromPropertyName];void 0!==e&&a.ReferentialConstraint.forEach(function(b){c[b[a.From]]=null!==e?e[b[a.To]]:null},this)}},this);a.ComplexTypes&&a.ComplexTypes.forEach(function(a){var e=b[a.FromPropertyName];void 0!==
e&&a.ReferentialConstraint.forEach(function(b){c[b[a.From]]=null!==e?e[b[a.To]]:null},this)},this);return c}},initializeStore:function(a){a=$data.typeSystem.createCallbackSetting(a);this.context._storageModel.forEach(function(a){this.SqlCommands.push(this.createSqlFromStorageModel(a)+" ")},this);var b=this._createSqlConnection(),c=this;b.createCommand("SELECT * FROM sqlite_master WHERE type = 'table'",null).executeQuery({success:function(d){for(var e={},f=0;f<d.rows.length;f++){var g=d.rows[f];e[g.tbl_name]=
g}switch(c.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.Merge:Guard.raise(new Exception("Not supported db creation type"));break;case $data.storageProviders.DbCreationType.DropTableIfChanged:d=[];for(f=0;f<c.SqlCommands.length;f++)if(""!=c.SqlCommands[f]){var g=/^CREATE TABLE IF NOT EXISTS ([^ ]*) (\(.*\))/g,h=g.exec(c.SqlCommands[f]);if(h){if(g=h[1],h=h[2],e[g.slice(1,g.length-1)]){var i=/^CREATE TABLE ([^ ]*) (\(.*\))/g.exec(e[g.slice(1,g.length-1)].sql)[2];h.toLowerCase()!=
i.toLowerCase()&&d.push("DROP TABLE IF EXISTS ["+e[g.slice(1,g.length-1)].tbl_name+"];")}}else console.dir(g),console.dir(c.SqlCommands[f])}c.SqlCommands=c.SqlCommands.concat(d);console.log(d);break;case $data.storageProviders.DbCreationType.DropAllExistingTables:for(h in e)h&&!h.match("^__")&&!h.match("^sqlite_")&&c.SqlCommands.push("DROP TABLE IF EXISTS ["+e[h].tbl_name+"];")}c._runSqlCommands(b,{success:a.success,error:a.error})},error:a.error})},executeQuery:function(a,b){var b=$data.typeSystem.createCallbackSetting(b),
c=this._createSqlConnection(),d=this._compile(a);a.actionPack=d.actions;a.sqlConvertMetadata=d.converter;a.modelBinderConfig=d.modelBinderConfig;c.createCommand(d.sqlText,d.params).executeQuery({success:function(c){b.success&&(a.rawDataList=c.rows,b.success(a))},error:b.error})},_compile:function(a){var b=new $data.storageProviders.sqLite.SQLiteCompiler,a=b.compile(a);a.hasSelect=null!=b.select;return a},getTraceString:function(a){return this._compile(a)},_runSqlCommands:function(a,b){if(this.SqlCommands&&
0<this.SqlCommands.length){var c=this.SqlCommands.pop(),d=this;a.createCommand(c,null).executeQuery({success:function(){d._runSqlCommands.apply(d,[a,b])},error:b.error})}else b.success(this.context)},setContext:function(a){this.context=a},saveChanges:function(a,b){var c=this._createSqlConnection(),d=this.buildIndependentBlocks(b);this.saveIndependentBlocks(b,d,c,a)},saveIndependentBlocks:function(a,b,c,d){function e(){if(0===g.length)d.success();else{var a=g.shift().map(function(a){var b=f.context._storageModel.getStorageModel(a.data.getType()).PhysicalType;
a.physicalData=b.convertTo(a.data);return a},this);f.saveIndependentItems(a,c,{success:function(){f.postProcessItems(a);e()},error:d.error})}}var f=this,g=[].concat(b);e()},saveIndependentItems:function(a,b,c){function d(a,b){var c=[],d=[];b.forEach(function(a,b){if(a&&(a.query&&(c[b]=a.query),a.param))d[b]=a.param});return a.createCommand(c,d)}var e=this,f=a.map(function(a){return e.saveEntitySet(a)}),f=f.filter(function(a){return a});0===f.length?c.success(a):d(b,f).executeQuery({success:function(f){f=
f.map(function(c,d){return c&&c.insertId?e.save_reloadSavedEntity(c.insertId,a[d].entitySet.tableName,b):null});f=d(b,f);0<f.query.length?f.executeQuery(function(b){b.forEach(function(b,c){b&&b.rows&&(a[c].physicalData.initData=b.rows[0])});c.success(a)}):c.success(0)},error:c.error})},postProcessItems:function(a){function b(a){var b=a.name;if(c.hasOwnProperty(b))return c[b];a=a.memberDefinitions.getPublicMappedProperties().filter(function(a){return a.computed});return c[b]=a}var c={};a.forEach(function(a){a.physicalData&&
b(a.data.getType()).forEach(function(b){a.data[b.name]=a.physicalData[b.name]},this)},this)},saveEntitySet:function(a){switch(a.data.entityState){case $data.EntityState.Added:return this.save_NewEntity(a);case $data.EntityState.Deleted:return this.save_DeleteEntity(a);case $data.EntityState.Modified:return this.save_UpdateEntity(a);case $data.EntityState.Unchanged:break;default:Guard.raise(new Exception("Not supported entity state"))}},save_DeleteEntity:function(a){for(var b="DELETE FROM ["+a.entitySet.name+
"] WHERE(",c=!1,d=!1,e=[];!c;)a.physicalData.constructor.memberDefinitions.getPublicMappedProperties().forEach(function(f){c&&!b.match(" AND $")&&(b+=" AND ");if(f.key||d)b+="(["+f.name+"] == ?)",e.push(this.fieldConverter.toDb[Container.resolveName(f.dataType)](a.data[f.name])),c=!0},this),c||(d=!0);b.match(" AND $")&&(b=b.slice(0,b.length-5));b+=");";return{query:b,param:e}},save_UpdateEntity:function(a){var b=" SET ",c="WHERE(",d=!1,e=[],f=[];a.physicalData.constructor.memberDefinitions.getPublicMappedProperties().forEach(function(g){void 0!==
a.physicalData[g.name]&&(d&&!c.match(" AND $")&&(c+=" AND "),5<b.length&&!b.match(",$")&&(b+=","),g.key?(c+="(["+g.name+"] == ?)",e.push(this.fieldConverter.toDb[Container.resolveName(g.dataType)](a.physicalData[g.name])),d=!0):(b+="["+g.name+"] = ?",f.push(this.fieldConverter.toDb[Container.resolveName(g.dataType)](a.physicalData[g.name]))))},this);d||Guard.raise(new Exception("Not supported UPDATE function without primary key!"));c.match(" AND $")&&(c=c.slice(0,c.length-5));b.match(",$")&&(b=b.slice(0,
b.length-1));return{query:"UPDATE ["+a.entitySet.tableName+"]"+b+" "+c+");",param:f.concat(e)}},save_NewEntity:function(a){var b="INSERT INTO ["+a.entitySet.tableName+"](",c="",d="",e=[];a.physicalData.constructor.memberDefinitions.getPublicMappedProperties().forEach(function(b){0<c.length&&","!=c[c.length-1]&&(c+=",",d+=",");var g=b.name;if(void 0!==a.physicalData[g]&&b.dataType&&(!b.dataType.isAssignableTo||b.dataType.isAssignableTo&&!b.dataType.isAssignableTo($data.EntitySet)))d+="?",c+="["+g+
"]",e.push(this.fieldConverter.toDb[Container.resolveName(b.dataType)](a.physicalData[g]))},this);1>e.length&&Guard.raise(new Exception("None of the fields contain values in the entity to be saved."));","==c[c.length-1]&&(c=c.slice(0,c.length-1));","==d[d.length-1]&&(d=d.slice(0,d.length-1));return{query:b+(c+") VALUES("+d+");"),param:e}},save_reloadSavedEntity:function(a,b){return{query:"SELECT * FROM "+b+" WHERE rowid=?",param:[a]}},createSqlFromStorageModel:function(a){(void 0===a||null===a||void 0===
a.PhysicalType)&&Guard.raise("StorageModel not contains physical entity definition");var b=0,c=0;a.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a){a.key&&b++;a.computed&&c++},this);1===c&&1<b&&Guard.raise(new Exception("Do not use computed field with multiple primary key!"));1<c&&1<b&&Guard.raise(new Exception("Do not use multiple computed field!"));var d="CREATE TABLE IF NOT EXISTS ["+a.TableName+"] (",e=",PRIMARY KEY (";a.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(b,
g){0<g&&!d.match(", $")&&!d.match("\\($")&&(d+=", ");d+=this.createSqlFragmentFromField(b,1===c,a);0===c&&b.key&&(14<e.length&&!e.match(", $")&&(e+=", "),e+="["+b.name+"]")},this);d.match(", $")&&(d=d.substr(0,d.length-2));0===c&&14<e.length&&(d+=e+")");return d+=");"},createSqlFragmentFromField:function(a,b,c){return"schemaCreate"in a&&a.schemaCreate?a.schemaCreate(a):(new this.FieldTypeBuilder(a,this,b,c)).build()},FieldTypeBuilder:function(a,b,c,d){this.fieldDef="";this.fld=a;this.provider=b;this.parsePk=
c;this.entitySet=d;this.build=function(){switch(Container.resolveType(this.fld.dataType)){case $data.String:case "text":case "string":this.buildFieldNameAndType("TEXT");break;case $data.Boolean:case $data.Integer:case "bool":case "boolean":case "int":case "integer":this.buildFieldNameAndType("INTEGER");break;case $data.Number:case $data.Date:case "number":case "datetime":case "date":this.buildFieldNameAndType("REAL");break;case $data.Blob:case "blob":this.buildFieldNameAndType("BLOB");break;default:this.buildRelations()}return this.fieldDef};
this.buildFieldNameAndType=function(a){this.fieldDef="["+this.fld.name+"] "+a;this.parsePk?this.buildPrimaryKey():this.buildNotNull()};this.buildPrimaryKey=function(){this.fld.key?(this.fieldDef+=" PRIMARY KEY",this.buildAutoIncrement()):this.buildNotNull()};this.buildNotNull=function(){this.fld.required&&(this.fieldDef+=" NOT NULL")};this.buildAutoIncrement=function(){this.fld.computed&&(this.fieldDef+=" AUTOINCREMENT")}}},{isSupported:{get:function(){return"openDatabase"in window},set:function(){}}});
$data.storageProviders.sqLite.SqLiteStorageProvider.isSupported&&($data.StorageProviderBase.registerProvider("webSql",$data.storageProviders.sqLite.SqLiteStorageProvider),$data.StorageProviderBase.registerProvider("sqLite",$data.storageProviders.sqLite.SqLiteStorageProvider),$data.webSqlProvider=$data.storageProviders.sqLite.SqLiteStorageProvider);
var SqlStatementBlocks={beginGroup:"(",endGroup:")",nameSeparator:".",valueSeparator:", ",select:"SELECT ",where:" WHERE ",from:" FROM ",skip:" OFFSET ",take:" LIMIT ",parameter:"?",order:" ORDER BY ",as:" AS ",scalarFieldName:"d",rowIdName:"rowid$$",count:"select count(*) cnt from ("};$C("$data.sqLite.SqlBuilder",$data.queryBuilder,null,{constructor:function(a,b){this.sets=a;this.entityContext=b},getExpressionAlias:function(a){var b=this.sets.indexOf(a);b==-1&&(b=this.sets.push(a)-1);return"T"+b}});
$C("$data.sqLite.SqlCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a,b){this.queryExpression=a;this.sets=b.sets;this.infos=b.infos;this.entityContext=b.entityContext;this.associations=[];this.filters=[];this.newFilters={};this.sortedFilterPart=["projection","from","filter","order","take","skip"]},compile:function(){var a=Container.createSqlBuilder(this.sets,this.entityContext);this.Visit(this.queryExpression,a);a.getTextPart("projection")===void 0&&this.VisitDefaultProjection(a);
a.selectTextPart("result");this.sortedFilterPart.forEach(function(b){if(b=a.getTextPart(b)){a.addText(b.text);a.selectedFragment.params=a.selectedFragment.params.concat(b.params)}},this);var b=a.getTextPart("count");if(b!==void 0){a.selectedFragment.text=b.text+a.selectedFragment.text;a.addText(SqlStatementBlocks.endGroup);a.selectedFragment.params=a.selectedFragment.params.concat(b.params)}a.resetModelBinderProperty();this.filters.push(a)},VisitToArrayExpression:function(a,b){this.Visit(a.source,
b)},VisitCountExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("count");b.addText(SqlStatementBlocks.count)},VisitFilterExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("filter");b.addText(SqlStatementBlocks.where);Container.createSqlFilterCompiler().Visit(a.selector,b);return a},VisitOrderExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("order");if(this.addOrders)b.addText(SqlStatementBlocks.valueSeparator);else{this.addOrders=true;b.addText(SqlStatementBlocks.order)}Container.createSqlOrderCompiler().Visit(a,
b);return a},VisitPagingExpression:function(a,b){this.Visit(a.source,b);switch(a.nodeType){case $data.Expressions.ExpressionType.Skip:b.selectTextPart("skip");b.addText(SqlStatementBlocks.skip);break;case $data.Expressions.ExpressionType.Take:b.selectTextPart("take");b.addText(SqlStatementBlocks.take);break;default:Guard.raise("Not supported nodeType")}Container.createSqlPagingCompiler().Visit(a,b);return a},VisitProjectionExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("projection");
this.hasProjection=true;b.addText(SqlStatementBlocks.select);Container.createSqlProjectionCompiler().Visit(a,b)},VisitIncludeExpression:function(a){var b=Container.createSqlBuilder(this.sets,this.entityContext);this.Visit(a.source,b);this.newFilters.include=projectionBuilder},VisitEntitySetExpression:function(a,b){b.selectTextPart("from");b.addText(SqlStatementBlocks.from);b.sets.forEach(function(a,d){d>0&&b.addText(" \n\tLEFT OUTER JOIN ");var e=b.getExpressionAlias(a);b.addText(a.instance.tableName+
" ");b.addText(e);if(d>0){b.addText(" ON (");var f=this.infos[d],g="T"+f.AliasNumber,h=f.NavigationPath.substring(0,f.NavigationPath.lastIndexOf(".")),e=this.infos.filter(function(a){return a.NavigationPath==h},this),i="T0";e.length>0&&(i="T"+e[0].AliasNumber);f.Association.associationInfo.ReferentialConstraint.forEach(function(a){b.addText(i+"."+a[f.Association.associationInfo.From]);b.addText(" = ");b.addText(g+"."+a[f.Association.associationInfo.To])},this);b.addText(")")}},this)},VisitDefaultProjection:function(a){a.selectTextPart("projection");
if(a.sets.length>1){a.addText(SqlStatementBlocks.select);a.sets[0].storageModel.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(b,c){c>0&&a.addText(SqlStatementBlocks.valueSeparator);a.addText("T0.");a.addText(b.name)},this)}else a.addText("SELECT *")}});$data.Expressions.ExpressionNode.prototype.monitor=function(a,b){return Container.createExpressionMonitor(a).Visit(this,b)};
$C("$data.storageProviders.sqLite.SQLiteCompiler",null,null,{compile:function(a){var b={sets:[],infos:[],entityContext:a.context},c=a.expression.monitor({MonitorEntitySetExpression:function(a,b){if(a.source instanceof $data.Expressions.EntityContextExpression&&b.sets.indexOf(a)==-1){b.sets.push(a);b.infos.push({AliasNumber:0,Association:null,FromType:null,FromPropertyName:null})}},MutateEntitySetExpression:function(a,b){if(a.source instanceof $data.Expressions.EntityContextExpression){this.backupContextExpression=
a.source;this.path="";return a}a.selector.associationInfo.FromMultiplicity=="0..1"&&a.selector.associationInfo.FromMultiplicity=="*"&&Guard.raise("Not supported query on this navigation property: "+a.selector.associationInfo.From+" "+a.selector.associationInfo.FromPropertyName);this.path=this.path+("."+a.selector.associationInfo.FromPropertyName);var c=b.infos.filter(function(a){return a.NavigationPath==this.path},this);if(c.length>0)return b.sets[c[0].AliasNumber];(c=this.backupContextExpression.instance.getType().memberDefinitions.getMember(a.storageModel.EntitySetReference.name))||
Guard.raise("Context schema error");c=Container.createMemberInfoExpression(c);c=Container.createEntitySetExpression(this.backupContextExpression,c);c.instance=this.backupContextExpression.instance[a.storageModel.EntitySetReference.name];var g=b.sets.push(c);b.infos.push({AliasNumber:g-1,Association:a.selector,NavigationPath:this.path});return c}},b),b=Container.createSqlCompiler(c,b);b.compile();Container.createSqlBuilder(this.sets,this.entityContext);a.modelBinderConfig={};Container.createsqLite_ModelBinderCompiler(a,
[]).Visit(c);return{sqlText:b.filters[0].selectedFragment.text,params:b.filters[0].selectedFragment.params,modelBinderConfig:a.modelBinderConfig}}},null);$C("$data.sqLite.SqlPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitPagingExpression:function(a,b){this.Visit(a.amount,b)},VisitConstantExpression:function(a,b){b.addParameter(a.value);b.addText(SqlStatementBlocks.parameter)}});
$C("$data.sqLite.SqlOrderCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitEntitySetExpression:function(a,b){var c=b.getExpressionAlias(a);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator)},VisitOrderExpression:function(a,b){this.Visit(a.selector,b);a.nodeType==$data.Expressions.ExpressionType.OrderByDescending?b.addText(" DESC"):b.addText(" ASC")},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,
b)},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitMemberInfoExpression:function(a,b){b.addText(a.memberName)},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b);b.addText("__")}});
$C("$data.sqLite.SqlProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.anonymFiledPrefix="";this.currentObjectLiteralName=null},VisitProjectionExpression:function(a,b){this.Visit(a.selector,b)},VisitParametricQueryExpression:function(a,b){if(a.expression instanceof $data.Expressions.EntityExpression)this.VisitEntityExpressionAsProjection(a,b);else if(a.expression instanceof $data.Expressions.ObjectLiteralExpression)this.Visit(a.expression,b);else{this.VisitEntitySetExpression(b.sets[0],
b);b.addText("rowid");b.addText(SqlStatementBlocks.as);b.addText(SqlStatementBlocks.rowIdName);b.addText(", ");b.addKeyField(SqlStatementBlocks.rowIdName);this.Visit(a.expression,b);b.addText(SqlStatementBlocks.as);b.addText(SqlStatementBlocks.scalarFieldName)}},VisitEntityExpressionAsProjection:function(a,b){var c=a.expression,d=b.getExpressionAlias(c.source),e=this.anonymFiledPrefix+(a.fieldName?a.fieldName:""),e=e?e+"__":"";c.storageModel.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a,
c){c>0&&b.addText(SqlStatementBlocks.valueSeparator);var h=e+a.name;b.addText(d);b.addText(SqlStatementBlocks.nameSeparator);b.addText(a.name);b.addText(SqlStatementBlocks.as);b.addText(h)},this)},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition,d=c.mapTo||c.name;b.addText(d);b.addText(SqlStatementBlocks.beginGroup);if(d==="like"){d=Container.createSqlBuilder();this.Visit(a.parameters[0],
d);d.params.forEach(function(a){var d=c.parameters[0],a=d.prefix?d.prefix+a:a,a=d.suffix?a+d.suffix:a;b.addParameter(a)});b.addText(d.sql);b.addText(" , ");this.Visit(a.source,b)}else{this.Visit(a.source,b);a.parameters.forEach(function(a){b.addText(" , ");this.Visit(a,b)},this)}b.addText(SqlStatementBlocks.endGroup)},VisitUnaryExpression:function(a,b){b.addText(a.resolution.mapTo);b.addText(SqlStatementBlocks.beginGroup);this.Visit(a.operand,b);b.addText(SqlStatementBlocks.endGroup)},VisitSimpleBinaryExpression:function(a,
b){b.addText(SqlStatementBlocks.beginGroup);this.Visit(a.left,b);var c=this;b.addText(" "+a.resolution.mapTo+" ");if(a.nodeType=="in"){Guard.requireType("expression.right",a.right,$data.Expressions.ConstantExpression);var d=a.right.value;if(d instanceof Array){b.addText(SqlStatementBlocks.beginGroup);d.forEach(function(a,d){d>0&&b.addText(SqlStatementBlocks.valueSeparator);var g=Container.createConstantExpression(a);c.Visit(g,b)});b.addText(SqlStatementBlocks.endGroup)}else d instanceof $data.Queryable?
Guard.raise("not yet... but coming"):Guard.raise(new Exception("Only constant arrays and Queryables can be on the right side of 'in' operator","UnsupportedType"))}else this.Visit(a.right,b);b.addText(SqlStatementBlocks.endGroup)},VisitConstantExpression:function(a,b){b.addParameter(a.value);b.addText(SqlStatementBlocks.parameter)},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitEntitySetExpression:function(a,b){var c=b.getExpressionAlias(a);b.addText(c);
b.addText(SqlStatementBlocks.nameSeparator)},VisitComplexTypeExpression:function(a,b){var c=b.getExpressionAlias(a.source.source),d=a.source.storageModel.ComplexTypes[a.selector.memberName];d.ReferentialConstraint.forEach(function(a,f){f>0&&b.addText(SqlStatementBlocks.valueSeparator);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator);b.addText(a[d.From]);b.addText(SqlStatementBlocks.as);b.addText(this.anonymFiledPrefix+a[d.To])},this)},VisitMemberInfoExpression:function(a,b){b.addText(a.memberName)},
VisitObjectLiteralExpression:function(a,b){this.VisitEntitySetExpression(b.sets[0],b);b.addText("rowid AS "+this.anonymFiledPrefix+SqlStatementBlocks.rowIdName+", ");for(var c=a.members.length,d=0;d<c;d++){d!=0&&b.addText(SqlStatementBlocks.valueSeparator);this.Visit(a.members[d],b)}},VisitObjectFieldExpression:function(a,b){var c=this.currentObjectLiteralName;this.currentObjectLiteralName=this.currentObjectLiteralName?this.currentObjectLiteralName+("."+a.fieldName):a.fieldName;if(a.expression instanceof
$data.Expressions.EntityExpression)this.VisitEntityExpressionAsProjection(a,b);else{var d=this.anonymFiledPrefix;this.anonymFiledPrefix=this.anonymFiledPrefix+(a.fieldName+"__");this.Visit(a.expression,b);this.anonymFiledPrefix=d;if(!(a.expression instanceof $data.Expressions.ObjectLiteralExpression)&&!(a.expression instanceof $data.Expressions.ComplexTypeExpression)){b.addText(SqlStatementBlocks.as);b.addText(this.anonymFiledPrefix+a.fieldName)}}this.currentObjectLiteralName=c}},null);
$C("$data.sqLite.ExpressionMonitor",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.Visit=function(b,c){var d=b,e;if(this.canVisit(b)){a.VisitExpressionNode&&a.VisitExpressionNode.apply(a,arguments);e="Visit"+b.getType().name;e in a&&(d=a[e].apply(a,arguments))}var f=arguments;d!==b&&(f=[d,c]);d=$data.Expressions.EntityExpressionVisitor.prototype.Visit.apply(this,f);f=[d,c];if(this.canVisit(d)){var g=d.getType().name;a.MonitorExpressionNode&&a.MonitorExpressionNode.apply(a,
f);e="Monitor"+g;e in a&&a[e].apply(a,f);a.MutateExpressionNode&&a.MutateExpressionNode.apply(a,f);e="Mutate"+g;e in a&&(d=a[e].apply(a,f))}return d}}});
$C("$data.sqLite.SqlFilterCompiler",$data.Expressions.EntityExpressionVisitor,null,{VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b)},VisitUnaryExpression:function(a,b){b.addText(a.resolution.mapTo);b.addText(SqlStatementBlocks.beginGroup);this.Visit(a.operand,b);b.addText(SqlStatementBlocks.endGroup)},VisitSimpleBinaryExpression:function(a,b){var c=this;if(a.nodeType=="arrayIndex")this.Visit(a.left,b);else{b.addText(SqlStatementBlocks.beginGroup);this.Visit(a.left,b);b.addText(" "+
a.resolution.mapTo+" ");if(a.nodeType=="in"){Guard.requireType("expression.right",a.right,$data.Expressions.ConstantExpression);var d=a.right.value;if(d instanceof Array){b.addText(SqlStatementBlocks.beginGroup);d.forEach(function(a,d){d>0&&b.addText(SqlStatementBlocks.valueSeparator);var g=Container.createConstantExpression(a);c.Visit(g,b)});b.addText(SqlStatementBlocks.endGroup)}else d instanceof $data.Queryable?b.addText("(SELECT d FROM ("+d.toTraceString().sqlText+"))"):Guard.raise(new Exception("Only constant arrays and Queryables can be on the right side of 'in' operator",
"UnsupportedType"))}else this.Visit(a.right,b);b.addText(SqlStatementBlocks.endGroup)}},VisitEntitySetExpression:function(a,b){var c=b.getExpressionAlias(a);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator)},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition,d=c.mapTo||c.name;b.addText(d);b.addText(SqlStatementBlocks.beginGroup);if(d==="like"){d=Container.createSqlBuilder([],
b.entityContext);d.selectTextPart("fragment");this.Visit(a.parameters[0],d);d=d.getTextPart("fragment");d.params.forEach(function(a){var d=c.parameters[0],a=d.prefix?d.prefix+a:a,a=d.suffix?a+d.suffix:a;b.addParameter(a)});b.addText(d.text);b.addText(" , ");this.Visit(a.source,b)}else{this.Visit(a.source,b);a.parameters.forEach(function(a){b.addText(" , ");this.Visit(a,b)},this)}b.addText(SqlStatementBlocks.endGroup)},VisitMemberInfoExpression:function(a,b){b.addText(a.memberName)},VisitQueryParameterExpression:function(a,
b){var c=null,c=a.type=="array"?a.value[a.index]:a.value;b.addParameter(c);b.addText(SqlStatementBlocks.parameter)},VisitConstantExpression:function(a,b){var c=Container.getTypeName(a.value),c=b.entityContext.storageProvider.fieldConverter.toDb[Container.resolveName(Container.resolveType(c))](a.value);b.addParameter(c);b.addText(SqlStatementBlocks.parameter)},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,
b);this.Visit(a.selector,b);b.addText("__")}});
$C("$data.sqLite.sqLite_ModelBinderCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a,b){this._query=a;this._includes=b},VisitSingleExpression:function(a){this._defaultModelBinder(a)},VisitSomeExpression:function(a){this._defaultModelBinder(a)},VisitEveryExpression:function(a){this._defaultModelBinder(a)},VisitToArrayExpression:function(a){this._defaultModelBinder(a)},VisitFirstExpression:function(a){this._defaultModelBinder(a)},VisitForEachExpression:function(a){this._defaultModelBinder(a)},
VisitCountExpression:function(){var a=Container.createqueryBuilder();a.modelBinderConfig.$type=$data.Array;a.selectModelBinderProperty("$item");a.modelBinderConfig.$type=$data.Integer;a.modelBinderConfig.$source="cnt";a.resetModelBinderProperty();this._query.modelBinderConfig=a.modelBinderConfig},VisitExpression:function(a,b){var c=Container.createFindProjectionVisitor();c.Visit(a);c.projectionExpression?this.Visit(c.projectionExpression,b):this.DefaultSelection(b)},_defaultModelBinder:function(a){var b=
Container.createqueryBuilder();b.modelBinderConfig.$type=$data.Array;b.modelBinderConfig.$item={};b.selectModelBinderProperty("$item");this.VisitExpression(a,b);b.resetModelBinderProperty();this._query.modelBinderConfig=b.modelBinderConfig},_addPropertyToModelBinderConfig:function(a,b){var c=this._query.context._storageModel.getStorageModel(a);a.memberDefinitions.getPublicMappedProperties().forEach(function(a){if(!c||c&&!c.Associations[a.name]&&!c.ComplexTypes[a.name]){a.key&&(this.currentObjectFieldName?
b.addKeyField(this.currentObjectFieldName+"__"+a.name):b.addKeyField(a.name));b.modelBinderConfig[a.name]=this.currentObjectFieldName?this.currentObjectFieldName+"__"+a.name:a.name}},this);c&&this._addComplexTypeProperties(c.ComplexTypes,b)},_addComplexTypeProperties:function(a,b){a.forEach(function(a){b.selectModelBinderProperty(a.FromPropertyName);b.modelBinderConfig.$type=a.ToType;var d=this.currentObjectFieldName;this.currentObjectFieldName=this.currentObjectFieldName?this.currentObjectFieldName+
"__":"";this.currentObjectFieldName=this.currentObjectFieldName+a.FromPropertyName;this._addPropertyToModelBinderConfig(a.ToType,b);b.popModelBinderProperty();this.currentObjectFieldName=d},this)},DefaultSelection:function(a){a.modelBinderConfig.$type=this._query.defaultType;var b=this._query.context._storageModel.getStorageModel(this._query.defaultType);this._addPropertyToModelBinderConfig(this._query.defaultType,a);this._includes&&this._includes.forEach(function(c){for(var d=c.name.split("."),e=
null,f=b,g=0;g<d.length;g++){a.selectModelBinderProperty(d[g]);e=f.Associations[d[g]];f=this._query.context._storageModel.getStorageModel(e.ToType)}a.modelBinderConfig.$selector="json:"+c.name;if(e.ToMultiplicity==="*"){a.modelBinderConfig.$type=$data.Array;a.selectModelBinderProperty("$item");a.modelBinderConfig.$type=c.type;this._addPropertyToModelBinderConfig(c.type,a);a.popModelBinderProperty()}else{a.modelBinderConfig.$type=c.type;this._addPropertyToModelBinderConfig(c.type,a)}for(g=0;g<d.length;g++)a.popModelBinderProperty()},
this)},VisitProjectionExpression:function(a,b){this.hasProjection=true;this.Visit(a.selector,b)},VisitParametricQueryExpression:function(a,b){if(a.expression instanceof $data.Expressions.EntityExpression)this.VisitEntityAsProjection(a.expression,b);else{this.Visit(a.expression,b);if(a.expression instanceof $data.Expressions.EntityFieldExpression){b.modelBinderConfig.$source="d";b.modelBinderConfig.$keys=["rowid$$"]}}},VisitConstantExpression:function(a,b){b.modelBinderConfig.$type=a.type;b.modelBinderConfig.$source=
this.currentObjectFieldName},VisitEntityAsProjection:function(a,b){this.Visit(a.source,b);b.modelBinderConfig.$type=a.entityType;this._addPropertyToModelBinderConfig(a.entityType,b)},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitMemberInfoExpression:function(a,b){if(a.memberDefinition instanceof $data.MemberDefinition){b.modelBinderConfig.$type=a.memberDefinition.type;a.memberName in a.memberDefinition.storageModel.ComplexTypes?this._addPropertyToModelBinderConfig(Container.resolveType(a.memberDefinition.type),
b):b.modelBinderConfig.$source=this.currentObjectFieldName}},VisitEntitySetExpression:function(a,b){if(a.source instanceof $data.Expressions.EntityExpression){this.Visit(a.source,b);this.Visit(a.selector,b)}},VisitEntityExpression:function(a,b){this.Visit(a.source,b)},VisitAssociationInfoExpression:function(a,b){"$selector"in b.modelBinderConfig&&b.modelBinderConfig.$selector.length>0?b.modelBinderConfig.$selector=b.modelBinderConfig.$selector+".":b.modelBinderConfig.$selector="json:";b.modelBinderConfig.$selector=
b.modelBinderConfig.$selector+a.associationInfo.FromPropertyName},VisitSimpleBinaryExpression:function(a,b){this.Visit(a.left,b);this.Visit(a.right,b);b.modelBinderConfig.$type=void 0},VisitObjectLiteralExpression:function(a,b){b.modelBinderConfig.$keys=this.currentObjectFieldName?[this.currentObjectFieldName+"__rowid$$"]:["rowid$$"];b.modelBinderConfig.$type=$data.Object;a.members.forEach(function(a){this.Visit(a,b)},this)},VisitObjectFieldExpression:function(a,b){var c=this.currentObjectFieldName;
b.selectModelBinderProperty(a.fieldName);this.currentObjectFieldName=this.currentObjectFieldName?this.currentObjectFieldName+"__":"";this.currentObjectFieldName=this.currentObjectFieldName+a.fieldName;a.expression instanceof $data.Expressions.EntityExpression?this.VisitEntityAsProjection(a.expression,b):this.Visit(a.expression,b);this.currentObjectFieldName=c;b.popModelBinderProperty()}});
