// JayData 1.2.7
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
$data.Class.define("$data.storageProviders.Facebook.FacebookProvider",$data.StorageProviderBase,null,{constructor:function(a){this.SqlCommands=[];this.context={};this.providerConfiguration=$data.typeSystem.extend({FQLFormat:"format=json",FQLQueryUrl:"https://graph.facebook.com/fql?q=",Access_Token:""},a);this.initializeStore=function(a){a=$data.typeSystem.createCallbackSetting(a);a.success(this.context)}},AuthenticationProvider:{dataType:"$data.Authentication.AuthenticationBase",enumerable:!1},supportedDataTypes:{value:[$data.Integer,
$data.Number,$data.Date,$data.String,$data.Boolean,$data.Blob,$data.Array],writable:!1},supportedFieldOperations:{value:{contains:{dataType:$data.String,allowedIn:$data.Expressions.FilterExpression,mapTo:"strpos",parameters:[{name:"@expression",dataType:$data.String},{name:"strFragment",dataType:$data.String}],rigthValue:") >= 0"},startsWith:{dataType:$data.String,allowedIn:$data.Expressions.FilterExpression,mapTo:"strpos",parameters:[{name:"@expression",dataType:$data.String},{name:"strFragment",
dataType:$data.String}],rigthValue:") = 0"},strpos:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"strpos",parameters:[{name:"@expression",dataType:$data.String},{name:"strFragment",dataType:$data.String}]},substr:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"substr",parameters:[{name:"@expression",dataType:$data.String},{name:"startIdx",dataType:$data.Number},
{name:"length",dataType:$data.Number}]},strlen:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"strlen",parameters:[{name:"@expression",dataType:$data.String}]}},enumerable:!0,writable:!0},supportedBinaryOperators:{value:{equal:{mapTo:" = ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},notEqual:{mapTo:" != ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},equalTyped:{mapTo:" = ",dataType:$data.Boolean,
allowedIn:$data.Expressions.FilterExpression},notEqualTyped:{mapTo:" != ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},greaterThan:{mapTo:" > ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},greaterThanOrEqual:{mapTo:" >= ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},lessThan:{mapTo:" < ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},lessThenOrEqual:{mapTo:" <= ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},
or:{mapTo:" OR ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},and:{mapTo:" AND ",dataType:$data.Booleanv},"in":{mapTo:" IN ",dataType:$data.Boolean,resolvableType:[$data.Array,$data.Queryable],allowedIn:$data.Expressions.FilterExpression}}},supportedUnaryOperators:{value:{}},fieldConverter:{value:{fromDb:{"$data.Number":function(a){return"number"===typeof a?a:parseInt(a)},"$data.Integer":function(a){return"number"===typeof a?a:parseFloat(a)},"$data.String":function(a){return a},
"$data.Date":function(a){return new Date("string"===typeof a?parseInt(a):a)},"$data.Boolean":function(a){return!!a},"$data.Blob":function(a){return a},"$data.Array":function(a){return void 0===a?new $data.Array:a}},toDb:{"$data.Number":function(a){return a},"$data.Integer":function(a){return a},"$data.String":function(a){return"'"+a+"'"},"$data.Date":function(a){return a?a.valueOf():null},"$data.Boolean":function(a){return a},"$data.Blob":function(a){return a},"$data.Array":function(a){return"("+
a.join(", ")+")"}}}},supportedSetOperations:{value:{filter:{},length:{},map:{},forEach:{},toArray:{},single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},executeQuery:function(a,b){b=$data.typeSystem.createCallbackSetting(b);this.AuthenticationProvider||(this.AuthenticationProvider=new $data.Authentication.Anonymous({}));var c;try{c=this._compile(a)}catch(e){b.error(e);return}var d=a.defaultType,f=[];c.selectMapping||this._discoverType("",d,f);c=this.providerConfiguration.FQLQueryUrl+
encodeURIComponent(c.queryText)+"&"+this.providerConfiguration.FQLFormat;this.providerConfiguration.Access_Token&&(c+="&access_token="+this.providerConfiguration.Access_Token);c={url:c,dataType:"JSON",success:function(c){a.rawDataList=c.data;Container.createModelBinderConfigCompiler(a,[]).Visit(a.expression);if(a.expression instanceof $data.Expressions.CountExpression)a.rawDataList=[{cnt:c.data.length}];b.success(a)},error:function(a,c,e){c={};try{c=JSON.parse(a.responseText).error}catch(f){c=e+": "+
a.responseText}b.error(c)}};this.context.prepareRequest.call(this,c);this.AuthenticationProvider.CreateRequest(c)},_discoverType:function(a,b,c){b.memberDefinitions.getPublicMappedProperties().forEach(function(b){var d=Container.resolveType(b.dataType);if(d.isAssignableTo||d==Array){var f=a?a+"."+b.name:b.name;if(d==Array||d.isAssignableTo($data.EntitySet))if(b.inverseProperty)d=Container.resolveType(b.elementType);else return;c.push({name:f,type:d});this._discoverType(f,d,c)}},this)},_compile:function(a){return Container.createFacebookCompiler().compile(a)},
getTraceString:function(a){this.AuthenticationProvider||(this.AuthenticationProvider=new $data.Authentication.Anonymous({}));return this._compile(a)},setContext:function(a){this.context=a},saveChanges:function(){Guard.raise(new Exception("Not implemented","Not implemented"))}},null);$data.StorageProviderBase.registerProvider("Facebook",$data.storageProviders.Facebook.FacebookProvider);
$C("$data.storageProviders.Facebook.FacebookCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.provider={}},compile:function(a){this.provider=a.context.storageProvider;var b={filterSql:{sql:""},projectionSql:{sql:""},orderSql:{sql:""},skipSql:{sql:""},takeSql:{sql:""},tableName:""};this.Visit(a.expression,b);var c=!1;b.projectionSql.sql||(b.projectionSql=this.autoGenerateProjection(a),c=!0);""==b.filterSql.sql&&Guard.raise(new Exception("Filter/where statement is required",
"invalid operation"));return{queryText:b.projectionSql.sql+" FROM "+b.tableName+b.filterSql.sql+b.orderSql.sql+b.takeSql.sql+(b.takeSql.sql?b.skipSql.sql:""),selectMapping:!1==c?b.projectionSql.selectFields:null,params:[]}},autoGenerateProjection:function(a){var b=a.context.getEntitySetFromElementType(a.defaultType),b=new $data.Queryable(a.context,b.expression),c=Container.createCodeExpression(this.generateProjectionFunc(a)),c=Container.createProjectionExpression(b.expression,c),b=Container.createQueryable(b,
c).expression,b=Container.createQueryExpressionCreator(a.context).Visit(b),a={projectionSql:{sql:""}};this.Visit(b,a);return a.projectionSql},generateProjectionFunc:function(a){var b=this.provider.AuthenticationProvider.Authenticated||this.provider.providerConfiguration.Access_Token,a=a.defaultType.memberDefinitions.getPublicMappedProperties();!b&&a.some(function(a){return!0==a.isPublic})&&(a=a.filter(function(a){return!0==a.isPublic}));var c="function (s){ return {";a.forEach(function(a,b){0!=b&&
(c+=", ");c+=a.name+": s."+a.name});return c+="};"},VisitFilterExpression:function(a,b){this.Visit(a.source,b);b.filterSql.type=a.nodeType;b.filterSql.sql=""==b.filterSql.sql?" WHERE ":b.filterSql.sql+" AND ";this.Visit(a.selector,b.filterSql)},VisitProjectionExpression:function(a,b){this.Visit(a.source,b);b.projectionSql.type=a.nodeType;""==b.projectionSql.sql?b.projectionSql.sql="SELECT ":Guard.raise(new Exception("Multiple select error"));this.Visit(a.selector,b.projectionSql)},VisitOrderExpression:function(a,
b){this.Visit(a.source,b);b.orderSql.type=a.nodeType;""==b.orderSql.sql?b.orderSql.sql=" ORDER BY ":Guard.raise(new Exception("Multiple sorting not supported","not supported"));this.Visit(a.selector,b.orderSql);b.orderSql.sql+=a.nodeType==$data.Expressions.ExpressionType.OrderByDescending?" DESC":" ASC"},VisitPagingExpression:function(a,b){this.Visit(a.source,b);a.nodeType==$data.Expressions.ExpressionType.Skip?(b.skipSql.type=a.nodeType,b.skipSql.sql=" OFFSET ",this.Visit(a.amount,b.skipSql)):a.nodeType==
$data.Expressions.ExpressionType.Take&&(b.takeSql.type=a.nodeType,b.takeSql.sql=" LIMIT ",this.Visit(a.amount,b.takeSql))},VisitSimpleBinaryExpression:function(a,b){b.sql+="(";this.Visit(a.left,b);b.sql+=a.resolution.mapTo;a.resolution.resolvableType&&!Guard.requireType(a.resolution.mapTo+" expression.right.value",a.right.value,a.resolution.resolvableType)&&Guard.raise(new Exception(a.right.type+" not allowed in '"+a.resolution.mapTo+"' statement","invalid operation"));this.Visit(a.right,b);b.sql+=
")"},VisitEntityFieldExpression:function(a,b){this.Visit(a.selector,b)},VisitMemberInfoExpression:function(a,b){var c=a.memberName;b.sql+=c;b.fieldData={name:c,dataType:a.memberDefinition.dataType};"Projection"==b.type&&!b.selectFields&&(b.selectFields=!0===b.fieldOperation?[{from:"anon"}]:[{from:c,dataType:a.memberDefinition.dataType}])},VisitConstantExpression:function(a,b){"Projection"==b.type&&Guard.raise(new Exception("Constant value is not supported in Projection.","Not supported!"));this.VisitQueryParameterExpression(a,
b)},VisitQueryParameterExpression:function(a,b){var c=Container.resolveType(Container.getTypeName(a.value));if(-1!=this.provider.supportedDataTypes.indexOf(c))b.sql+=this.provider.fieldConverter.toDb[Container.resolveName(c)](a.value);else switch(c){case $data.Queryable:b.sql+="("+a.value.toTraceString().queryText+")";break;default:b.sql+=""+a.value+""}},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b);b.parameters=a.parameters},VisitEntitySetExpression:function(a,b){b.tableName=
a.instance.tableName},VisitObjectLiteralExpression:function(a,b){var c=this;b.selectFields=b.selectFields||[];a.members.forEach(function(a){a.expression instanceof $data.Expressions.ObjectLiteralExpression?(b.mappingPrefix=b.mappingPrefix||[],b.mappingPrefix.push(a.fieldName),c.Visit(a,b),b.mappingPrefix.pop()):(0<b.selectFields.length&&(b.sql+=", "),c.Visit(a,b),a=b.mappingPrefix instanceof Array?b.mappingPrefix.join(".")+"."+a.fieldName:a.fieldName,b.selectFields.push({from:b.fieldData.name,to:a,
dataType:b.fieldData.dataType}))})},VisitObjectFieldExpression:function(a,b){return this.Visit(a.expression,b)},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition,e=c.mapTo||c.name;b.sql+="(";!1==c.expressionInParameter&&this.Visit(a.source,b);b.sql+=e;b.sql+="(";var d=0;(c.parameters||[]).map(function(b){var c={dataType:b.dataType};b.value?c.value=b.value:"@expression"===
b.name?c.value=a.source:(c.value=a.parameters[d],c.itemType=a.parameters[d++].type);return c}).forEach(function(c,d){var e=c.itemType?Container.resolveType(c.itemType):null;if(!e||c.dataType instanceof Array&&-1!=c.dataType.indexOf(e)||c.dataType==e){if(0<d&&(b.sql+=", "),"Projection"==b.type&&(b.fieldOperation=!0),this.Visit(c.value,b),"Projection"==b.type)b.fieldOperation=void 0}else Guard.raise(new Exception(parameter.type+" not allowed in '"+a.operation.memberName+"' statement","invalid operation"))},
this);b.fieldData&&b.fieldData.name&&(b.fieldData.name="anon");b.sql=c.rigthValue?b.sql+c.rigthValue:b.sql+")";b.sql+=")"}},null);
$data.Class.define("$data.Facebook.types.FbUser",$data.Entity,null,{uid:{type:"int",key:!0,isPublic:!0,searchable:!0},username:{type:"string",isPublic:!0,searchable:!0},first_name:{type:"string",isPublic:!0},middle_name:{type:"string",isPublic:!0},last_name:{type:"string",isPublic:!0},name:{type:"string",isPublic:!0,searchable:!0},pic_small:{type:"string"},pic_big:{type:"string"},pic_square:{type:"string"},pic:{type:"string"},affiliations:{type:"Array",elementType:"Object"},profile_update_time:{type:"datetime"},
timezone:{type:"int"},religion:{type:"string"},birthday:{type:"string"},birthday_date:{type:"string"},sex:{type:"string",isPublic:!0},hometown_location:{type:"Array",elementType:"Object"},meeting_sex:{type:"Array",elementType:"Object"},meeting_for:{type:"Array",elementType:"Object"},relationship_status:{type:"string"},significant_other_id:{type:"int"},political:{type:"string"},current_location:{type:"Array",elementType:"Object"},activities:{type:"string"},interests:{type:"string"},is_app_user:{type:"bool"},
music:{type:"string"},tv:{type:"string"},movies:{type:"string"},books:{type:"string"},quotes:{type:"string"},about_me:{type:"string"},hs_info:{type:"Array",elementType:"Object"},education_history:{type:"Array",elementType:"Object"},work_history:{type:"Array",elementType:"Object"},notes_count:{type:"int"},wall_count:{type:"int"},status:{type:"string"},has_added_app:{type:"bool"},online_presence:{type:"string"},locale:{type:"string",isPublic:!0},proxied_email:{type:"string"},profile_url:{type:"string"},
email_hashes:{type:"Array",elementType:"Object"},pic_small_with_logo:{type:"string",isPublic:!0},pic_big_with_logo:{type:"string",isPublic:!0},pic_square_with_logo:{type:"string",isPublic:!0},pic_with_logo:{type:"string",isPublic:!0},allowed_restrictions:{type:"string"},verified:{type:"bool"},profile_blurb:{type:"string"},family:{type:"Array",elementType:"Object"},website:{type:"string"},is_blocked:{type:"bool"},contact_email:{type:"string"},email:{type:"string"},third_party_id:{type:"string",searchable:!0},
name_format:{type:"string"},video_upload_limits:{type:"Array",elementType:"Object"},games:{type:"string"},work:{type:"Array",elementType:"Object"},education:{type:"Array",elementType:"Object"},sports:{type:"Array",elementType:"Object"},favorite_athletes:{type:"Array",elementType:"Object"},favorite_teams:{type:"Array",elementType:"Object"},inspirational_people:{type:"Array",elementType:"Object"},languages:{type:"Array",elementType:"Object"},likes_count:{type:"int"},friend_count:{type:"int"},mutual_friend_count:{type:"int"},
can_post:{type:"bool"}},null);$data.Class.define("$data.Facebook.types.FbFriend",$data.Entity,null,{uid1:{type:"int",key:!0,searchable:!0},uid2:{type:"int",key:!0,searchable:!0}},null);
$data.Class.define("$data.Facebook.types.FbPage",$data.Entity,null,{page_id:{type:"int",key:!0,isPublic:!0,searchable:!0},name:{type:"string",isPublic:!0,searchable:!0},username:{type:"string",isPublic:!0,searchable:!0},description:{type:"string",isPublic:!0},categories:{type:"string",isPublic:!0},is_community_page:{type:"bool",isPublic:!0},pic_small:{type:"string",isPublic:!0},pic_big:{type:"string",isPublic:!0},pic_square:{type:"string",isPublic:!0},pic:{type:"string",isPublic:!0},pic_large:{type:"string",
isPublic:!0},pic_cover:{type:"string",isPublic:!0},unread_notif_count:{type:"int",isPublic:!1},new_like_count:{type:"int",isPublic:!1},fan_count:{type:"int",isPublic:!0},type:{type:"string",isPublic:!0},website:{type:"string",isPublic:!0},has_added_app:{type:"bool",isPublic:!0},general_info:{type:"string",isPublic:!0},can_post:{type:"bool",isPublic:!0},checkins:{type:"int",isPublic:!0},is_published:{type:"bool",isPublic:!0},founded:{type:"string",isPublic:!0},company_overview:{type:"string",isPublic:!0},
mission:{type:"string",isPublic:!0},products:{type:"string",isPublic:!0},location:{type:"string",isPublic:!0},parking:{type:"string",isPublic:!0},hours:{type:"string",isPublic:!0},pharma_safety_info:{type:"string",isPublic:!0},public_transit:{type:"string",isPublic:!0},attire:{type:"string",isPublic:!0},payment_options:{type:"string",isPublic:!0},culinary_team:{type:"string",isPublic:!0},general_manager:{type:"string",isPublic:!0},price_range:{type:"string",isPublic:!0},restaurant_services:{type:"string",
isPublic:!0},restaurant_specialties:{type:"string",isPublic:!0},phone:{type:"string",isPublic:!0},release_date:{type:"string",isPublic:!0},genre:{type:"string",isPublic:!0},starring:{type:"string",isPublic:!0},screenplay_by:{type:"string",isPublic:!0},directed_by:{type:"string",isPublic:!0},produced_by:{type:"string",isPublic:!0},studio:{type:"string",isPublic:!0},awards:{type:"string",isPublic:!0},plot_outline:{type:"string",isPublic:!0},season:{type:"string",isPublic:!0},network:{type:"string",
isPublic:!0},schedule:{type:"string",isPublic:!0},written_by:{type:"string",isPublic:!0},band_members:{type:"string",isPublic:!0},hometown:{type:"string",isPublic:!0},current_location:{type:"string",isPublic:!0},record_label:{type:"string",isPublic:!0},booking_agent:{type:"string",isPublic:!0},press_contact:{type:"string",isPublic:!0},artists_we_like:{type:"string",isPublic:!0},influences:{type:"string",isPublic:!0},band_interests:{type:"string",isPublic:!0},bio:{type:"string",isPublic:!0},affiliation:{type:"string",
isPublic:!0},birthday:{type:"string",isPublic:!0},personal_info:{type:"string",isPublic:!0},personal_interests:{type:"string",isPublic:!0},built:{type:"string",isPublic:!0},features:{type:"string",isPublic:!0},mpg:{type:"string",isPublic:!0}},null);$data.Class.define("$data.storageProviders.Facebook.EntitySets.Command",null,null,{constructor:function(a){this.Config=$data.typeSystem.extend({CommandValue:""},a)},toString:function(){return this.Config.CommandValue},Config:{}},null);
$data.Class.define("$data.Facebook.FQLContext",$data.EntityContext,null,{constructor:function(){this.MyFriends=this.Users.where(function(a){return a.uid in this.friends},{friends:this.Friends.where(function(a){return a.uid1==this.me},{me:$data.Facebook.FQLCommands.me}).select(function(a){return a.uid2})})},Users:{dataType:$data.EntitySet,tableName:"user",elementType:$data.Facebook.types.FbUser},Friends:{dataType:$data.EntitySet,tableName:"friend",elementType:$data.Facebook.types.FbFriend},Pages:{dataType:$data.EntitySet,
tableName:"page",elementType:$data.Facebook.types.FbPage}},null);$data.Facebook.FQLCommands={__namespace:!0,me:new $data.storageProviders.Facebook.EntitySets.Command({CommandValue:"me()"}),now:new $data.storageProviders.Facebook.EntitySets.Command({CommandValue:"now()"})};
