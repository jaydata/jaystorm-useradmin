// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.modelBinder.mongoDBModelBinderConfigCompiler",$data.modelBinder.ModelBinderConfigCompiler,null,{_addPropertyToModelBinderConfig:function(b,a){var c=this._query.context._storageModel.getStorageModel(b);b.memberDefinitions?b.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(!c||c&&!c.Associations[b.name]&&!c.ComplexTypes[b.name])if(!c&&0>this._query.context.storageProvider.supportedDataTypes.indexOf(Container.resolveType(b.dataType)))a.selectModelBinderProperty(b.name),
a.modelBinderConfig.$type=Container.resolveType(b.dataType),a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.name+".results","json:"+b.name]:"json:"+b.name,this._addPropertyToModelBinderConfig(Container.resolveType(b.dataType),a),a.popModelBinderProperty();else if(b.key&&a.addKeyField(b.computed?"_id":b.name),b.concurrencyMode===$data.ConcurrencyMode.Fixed)a.modelBinderConfig[b.name]={$selector:"json:__metadata",$source:"etag"};else{var h=Container.resolveType(b.dataType);a.modelBinderConfig[b.name]=
h===$data.Array||h===$data.Object?{$type:h,$source:b.name}:b.computed?"_id":b.name}},this):(a._binderConfig.$item=a._binderConfig.$item||{},a.modelBinderConfig=a._binderConfig.$item);c&&this._addComplexTypeProperties(c.ComplexTypes,a)},_addComplexType:function(b,a){if(b.ToType!==$data.Array)a.modelBinderConfig.$type=b.ToType,a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.FromPropertyName+".results","json:"+b.FromPropertyName]:"json:"+b.FromPropertyName,this._addPropertyToModelBinderConfig(b.ToType,
a);else{var c=b.ToType,d=Container.resolveType(b.FromType.memberDefinitions.getMember(b.FromPropertyName).elementType);if(c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity)){config={$type:$data.Array,$selector:"json:"+b.FromPropertyName,$item:{$type:d}};c=d.memberDefinitions.getPublicMappedProperties();for(d=0;d<c.length;d++)config.$item[c[d].name]={$type:c[d].type,$source:c[d].name};$data.typeSystem.extend(a.modelBinderConfig,config)}else $data.typeSystem.extend(a.modelBinderConfig,
{$type:b.ToType,$source:b.FromPropertyName})}},_addComplexTypeProperties:function(b,a){var c=this;b.forEach(function(b){a.selectModelBinderProperty(b.FromPropertyName);c._addComplexType(b,a);a.popModelBinderProperty()},this)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a);if("$selector"in a.modelBinderConfig&&0<a.modelBinderConfig.$selector.length)if(a.modelBinderConfig.$selector instanceof $data.Array){var c=a.modelBinderConfig.$selector[1];a.modelBinderConfig.$selector[0]=
c+"."+b.selector.memberName+".results";a.modelBinderConfig.$selector[1]=c+"."+b.selector.memberName}else{var c=Container.resolveType(b.selector.memberDefinition.type),d=c===$data.Array&&b.selector.memberDefinition.elementType?Container.resolveType(b.selector.memberDefinition.elementType):c;d.memberDefinitions.getMember(b.selector.memberName)&&(a.modelBinderConfig.$selector+="."+b.selector.memberName)}else if(c=Container.resolveType(b.selector.memberDefinition.type),d=c===$data.Array&&b.selector.memberDefinition.elementType?
Container.resolveType(b.selector.memberDefinition.elementType):void 0,c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity))this._addComplexType(b.selector.memberDefinition.storageModel.ComplexTypes[b.selector.memberDefinition.name],a);else if(a.modelBinderConfig.$source=b.selector.memberName,c!==$data.Array&&(a.modelBinderConfig.$selector="json:"+b.selector.memberDefinition.name),a._binderConfig.$item===a.modelBinderConfig&&b.selector.memberDefinition.storageModel&&b.selector.memberDefinition.storageModel.ComplexTypes[b.selector.memberDefinition.name])a.modelBinderConfig.$selectorMemberInfo=
a.modelBinderConfig.$selector,delete a.modelBinderConfig.$selector},VisitMemberInfoExpression:function(b,a){var c=Container.resolveType(b.memberDefinition.type),d=c===$data.Array&&b.memberDefinition.elementType?Container.resolveType(b.memberDefinition.elementType):void 0;a.modelBinderConfig.$type=c;c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity)?this._addComplexType(b.memberDefinition.storageModel.ComplexTypes[b.memberName],a):b.memberDefinition.storageModel&&b.memberName in b.memberDefinition.storageModel.ComplexTypes?
this._addPropertyToModelBinderConfig(Container.resolveType(b.memberDefinition.type),a):a._binderConfig.$item===a.modelBinderConfig?a._binderConfig.$item={$type:a.modelBinderConfig.$type,$selector:a.modelBinderConfig.$selectorMemberInfo,$source:b.memberDefinition.computed?"_id":b.memberName}:a.modelBinderConfig.$source=b.memberDefinition.computed?"_id":b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){},compile:function(b,a){this.Visit(b,a);delete a.current;delete a.complexType},VisitProjectionExpression:function(b,a){this.Visit(b.selector,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitObjectLiteralExpression:function(b,a){this.hasObjectLiteral=!0;b.members.forEach(function(b){this.Visit(b,a)},this)},VisitObjectFieldExpression:function(b,
a){this.Visit(b.expression,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityExpression:function(b,a){this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){b.source instanceof $data.Expressions.EntityExpression&&this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(){},
VisitMemberInfoExpression:function(b,a){a.options.fields||(a.options.fields={_id:1});a.current=b.memberName;a.complexType?(delete a.options.fields[a.complexType],a.options.fields[a.complexType+"."+a.current]=1,delete a.complexType):a.options.fields[b.memberName]||(a.options.fields[b.memberName]=1)},VisitConstantExpression:function(){}});
$C("$data.storageProviders.mongoDB.mongoDBWhereCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a){this.provider=b;this.lambdaPrefix=a},compile:function(b,a){this.Visit(b,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitUnaryExpression:function(b,a){a.unary=b.nodeType;this.Visit(b.operand,a)},VisitSimpleBinaryExpression:function(b,a){a.cursor||(a.query={},a.cursor=a.query);var c=a.cursor;switch(b.nodeType){case $data.Expressions.ExpressionType.Or:if(a.cursor instanceof
Array){var d={$or:[]};a.cursor.push(d);a.cursor=d.$or}else a.cursor.$or=[],a.cursor=a.cursor.$or;this.Visit(b.left,a);this.Visit(b.right,a);a.cursor=c;break;case $data.Expressions.ExpressionType.And:a.cursor instanceof Array?(d={$and:[]},a.cursor.push(d),a.cursor=d.$and):(a.cursor.$and=[],a.cursor=a.cursor.$and);this.Visit(b.left,a);this.Visit(b.right,a);a.cursor=c;break;case $data.Expressions.ExpressionType.Equal:case $data.Expressions.ExpressionType.EqualTyped:this.Visit(b.left,a);this.Visit(b.right,
a);a.queryField=a.field;!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;a.entityType&&a.entityType.memberDefinitions?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?a.lastField:a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c));a.value=
c;a.cursor instanceof Array?(c={},c[a.queryField]=a.value,a.cursor.push(c)):a.cursor[a.queryField]=a.value;break;case $data.Expressions.ExpressionType.In:this.Visit(b.left,a);this.Visit(b.right,a);a.queryField=a.field;!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;if(c instanceof Array)for(d=0;d<c.length;d++)a.entityType&&a.entityType.memberDefinitions?c[d]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?
a.lastField:a.field).type))](c[d]):a.valueType&&(c[d]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c[d]));a.value=c;a.cursor instanceof Array?(c={},c[a.queryField]={},a.entityType&&a.entityType===$data.Array?c[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$not:a.value}:a.value:c[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?"$nin":b.resolution.mapTo]=a.value,a.cursor.push(c)):(a.cursor[a.queryField]={},a.entityType&&a.entityType===
$data.Array?a.cursor[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$not:a.value}:a.value:a.cursor[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?"$nin":b.resolution.mapTo]=a.value);a.unary===$data.Expressions.ExpressionType.Not&&(a.unary=void 0);break;default:(this.Visit(b.left,a),this.Visit(b.right,a),a.queryField=a.field,!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id"),c=a.value,a.entityType&&
a.entityType.memberDefinitions?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?a.lastField:a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c)),a.value=c,a.cursor instanceof Array)?(c={},c[a.queryField]={},c[a.queryField][b.resolution.mapTo]=a.value,a.cursor.push(c)):(a.cursor[a.queryField]={},a.cursor[a.queryField][b.resolution.mapTo]=
a.value)}delete a.complexType;delete a.field;delete a.value},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){a.data+=b.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(b,a){a.field=a.complexType&&a.field?a.field+"."+b.memberName:b.memberName;a.complexType&&(a.lastField=b.memberName)},VisitComplexTypeExpression:function(b,a){a.complexType=!0;this.Visit(b.source,a);this.Visit(b.selector,a);a.entityType=
b.entityType},VisitQueryParameterExpression:function(b,a){a.data+=this.provider.fieldConverter.toDb[b.type](b.value)},VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);this.Visit(b.source.selector,a);var c=b.operation.memberDefinition,d=c.mapTo||c.name,h=0;(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[h++]}).forEach(function(b){this.Visit(b,a)},this);
a.query[a.field]||(a.query[a.field]={});switch(d){case "contains":a.query[a.field].$regex=a.value;break;case "startsWith":a.query[a.field].$regex="^"+a.value;break;case "endsWith":a.query[a.field].$regex=a.value+"$"}},VisitConstantExpression:function(b,a){var c=Container.getTypeName(b.value);a.valueType=c;a.value=b.value},VisitEntityExpression:function(b,a){a.entityType=b.entityType;this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&
(this.Visit(b.selector,a),a.data+="/")},VisitFrameOperationExpression:function(b,a){this.Visit(b.source,a);Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition;a.data+=c.mapTo||c.name;a.data+="(";for(var d=0,h=(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[d++]}),f=0;f<h.length;f++){var g=h[f];if(g.value instanceof $data.Queryable){var e=new c.frameType(g.value.expression),
g=(new $data.Expressions.QueryExpressionCreator(g.value.entityContext)).Visit(e),e={data:""};(new $data.storageProviders.mongoDB.mongoDBWhereCompiler(this.provider,!0)).compile(g,e);a.data+=e.lambda+": "+e.data}}a.data+=")"}});
$C("$data.storageProviders.mongoDB.mongoDBOrderCompiler",$data.storageProviders.mongoDB.mongoDBWhereCompiler,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitOrderExpression:function(b,a){var c={data:""};this.Visit(b.selector,c);a.options.sort||(a.options.sort={});a.options.sort[c.data]=b.nodeType==$data.Expressions.ExpressionType.OrderByDescending?-1:1},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitEntityFieldExpression:function(b,
a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);a.data&&(a.data+=".");this.Visit(b.selector,a)},VisitEntitySetExpression:function(b,a){b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.source,a),this.Visit(b.selector,a))},VisitAssociationInfoExpression:function(){},VisitEntityExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitMemberInfoExpression:function(b,a){a.data+=b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitPagingExpression:function(b,a){var c={data:0};this.Visit(b.amount,c);switch(b.nodeType){case $data.Expressions.ExpressionType.Skip:a.options.skip=c.data;break;case $data.Expressions.ExpressionType.Take:a.options.limit=c.data;break;default:Guard.raise("Not supported nodeType")}},VisitConstantExpression:function(b,
a){a.data+=b.value}});
$C("$data.storageProviders.mongoDB.mongoDBCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.context={};this.provider={};this.mainEntitySet=this.includes=null},compile:function(b){this.provider=b.context.storageProvider;this.context=b.context;this.mainEntitySet=b.context.getEntitySetFromElementType(b.defaultType);b.find={query:{},options:{}};b.modelBinderConfig={};(new $data.modelBinder.mongoDBModelBinderConfigCompiler(b,this.includes,!1)).Visit(b.expression);this.Visit(b.expression,
b.find);delete b.find.field;delete b.find.value;delete b.find.data;delete b.find.stack;delete b.find.or;return b},VisitOrderExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBOrderCompiler(this.provider)).compile(b,a)},VisitPagingExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBPagingCompiler).compile(b,a)},VisitFilterExpression:function(b,a){this.Visit(b.source,a);var c=new $data.storageProviders.mongoDB.mongoDBWhereCompiler(this.provider);
a.data="";c.compile(b.selector,a)},VisitProjectionExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBProjectionCompiler(this.context)).compile(b,a)}});
$C("$data.storageProviders.mongoDB.mongoDBProvider",$data.StorageProviderBase,null,{constructor:function(b,a){this.driver=$data.mongoDBDriver;this.context=a;this.providerConfiguration=$data.typeSystem.extend({dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,address:"127.0.0.1",port:27017,serverOptions:{},databaseName:"test"},b)},_getServer:function(){return this.providerConfiguration.slave&&this.providerConfiguration.slave.address&&this.providerConfiguration.slave.port?new this.driver.ReplSetServers([new this.driver.Server(this.providerConfiguration.address,
this.providerConfiguration.port,this.providerConfiguration.serverOptions),new this.driver.Server(this.providerConfiguration.slave.address,this.providerConfiguration.slave.port,this.providerConfiguration.slave.serverOptions||{})]):this.driver.Server(this.providerConfiguration.address,this.providerConfiguration.port,this.providerConfiguration.serverOptions)},initializeStore:function(b){var a=this,b=$data.typeSystem.createCallbackSetting(b);switch(this.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.DropAllExistingTables:(new this.driver.Db(this.providerConfiguration.databaseName,
this._getServer(),{})).open(function(c,d){if(c)b.error(c);else{var h=function(c,d){var e=0,h;for(h in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(h)&&e++;for(h in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(h)&&d.dropCollection(a.context._entitySetReferences[h].tableName,function(){0==--e&&(b.success(a.context),d.close())})};a.providerConfiguration.username?d.authenticate(a.providerConfiguration.username,a.providerConfiguration.password||
"",function(a,c){a?b.error(a):c&&h(a,d)}):h(c,d)}});break;default:b.success(this.context)}},executeQuery:function(b,a){var c=this,a=$data.typeSystem.createCallbackSetting(a);this.entitySet=b.context.getEntitySetFromElementType(b.defaultType);(new $data.storageProviders.mongoDB.mongoDBCompiler).compile(b);(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{})).open(function(d,h){if(d)a.error(d);else{var f=new c.driver.Collection(h,c.entitySet.tableName),g=b.find,e=function(d,
e){d?a.error(d):(b.rawDataList=e instanceof Array?e:[{cnt:e}],b.context=c.context,a.success(b),h.close())},n=function(){switch(b.expression.nodeType){case $data.Expressions.ExpressionType.Count:f.find(g.query,g.options).count(e);break;case $data.Expressions.ExpressionType.BatchDelete:f.remove(g.query,{safe:!0},e);break;default:f.find(g.query,g.options).toArray(e)}};c.providerConfiguration.username?h.authenticate(c.providerConfiguration.username,c.providerConfiguration.password,function(b,c){b?a.error(b):
c&&n()}):n()}})},_typeFactory:function(b,a,c){b=Container.resolveName(b);return c&&c[b]?c[b](a):new (Container.resolveType(b))(a)},_saveCollections:function(b,a){var c=this,d=0,h=this._getServer(),f=0,g=function(a){0==--f&&a()},e=function(a,e,h){for(var g=[],f=0;f<e.insertAll.length;f++){for(var l=e.insertAll[f],j=Container.resolveType(l.type).memberDefinitions.getPublicMappedProperties(),i=0;i<j.length;i++){var m=j[i];m.computed||(l.data[m.name]=c._typeFactory(m.type,l.data[m.name],c.fieldConverter.toDb),
l.data[m.name]&&l.data[m.name].initData&&(l.data[m.name]=l.data[m.name].initData))}g.push(l.data)}h.insert(g,{safe:!0},function(g,f){if(g)b.error(g);else{for(var i=0;i<f.length;i++)for(var o=f[i],m=e.insertAll[i],l=Container.resolveType(m.type).memberDefinitions.getPublicMappedProperties(),k=0;k<l.length;k++){var j=l[k];m.entity[j.name]=c._typeFactory(j.type,o[j.computed?"_id":j.name],c.fieldConverter.fromDb)}d+=f.length;e.removeAll&&e.removeAll.length?q(a,e,h):e.updateAll&&e.updateAll.length?n(a,
e,h):p(a,d)}})},n=function(a,e,h){f=e.updateAll.length;for(var o=0;o<e.updateAll.length;o++){for(var k=e.updateAll[o],l={},j=Container.resolveType(k.type).memberDefinitions.getKeyProperties(),i=0;i<j.length;i++){var m=j[i];l[m.computed?"_id":m.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(m.type))](k.entity[m.name])}j={};m=Container.resolveType(k.type).memberDefinitions.getPublicMappedProperties();for(i=0;i<m.length;i++){var n=m[i];!n.computed&&"undefined"!==typeof k.entity[n.name]&&
(j[n.name]=c._typeFactory(n.type,k.entity[n.name],c.fieldConverter.toDb))}h.update(l,{$set:j},{safe:!0},function(c){c?b.error(c):(d++,g(function(){p(a,d)}))})}},q=function(a,e,h){f=e.removeAll.length;for(var o=0;o<e.removeAll.length;o++){for(var k=e.removeAll[o],l=Container.resolveType(k.type).memberDefinitions.getKeyProperties(),j=0;j<l.length;j++){var i=l[j];k.data[i.computed?"_id":i.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(i.type))](k.entity[i.name])}l=Container.resolveType(k.type).memberDefinitions.getPublicMappedProperties();
for(j=0;j<l.length;j++)i=l[j],i.computed||(k.data[i.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(i.type))](k.data[i.name]),"undefined"===typeof k.data[i.name]&&delete k.data[i.name]),delete k.data[i.name];h.remove(k.data,{safe:!0},function(c,f){c?b.error(c):(d+=f,g(function(){e.updateAll&&e.updateAll.length?n(a,e,h):p(a,d)}))})}},r=Object.keys(a),p=function(d,h){if(r.length){var f=r.pop();if(a.hasOwnProperty(f)){var g=a[f],f=new c.driver.Collection(d,f);g.insertAll&&g.insertAll.length?
e(d,g,f):g.removeAll&&g.removeAll.length?q(d,g,f):g.updateAll&&g.updateAll.length?n(d,g,f):(b.success(0),d.close())}}else b.success(h),d.close()};(new this.driver.Db(this.providerConfiguration.databaseName,h,{})).open(function(a,d){a?b.error(a):c.providerConfiguration.username?d.authenticate(c.providerConfiguration.username,c.providerConfiguration.password,function(a,c){a?b.error(a):c&&p(d)}):p(d)})},saveChanges:function(b,a){if(a.length){for(var c=this.buildIndependentBlocks(a),d=[],h={},f=0;f<c.length;f++)for(var g=
0;g<c[f].length;g++){d.push(c[f][g].data);var e=h[c[f][g].entitySet.name];e||(e={},h[c[f][g].entitySet.name]=e);var n={entity:c[f][g].data,data:this.save_getInitData(c[f][g],d),type:Container.resolveName(c[f][g].data.getType())};switch(c[f][g].data.entityState){case $data.EntityState.Unchanged:continue;case $data.EntityState.Added:e.insertAll||(e.insertAll=[]);e.insertAll.push(n);break;case $data.EntityState.Modified:e.updateAll||(e.updateAll=[]);e.updateAll.push(n);break;case $data.EntityState.Deleted:e.removeAll||
(e.removeAll=[]);e.removeAll.push(n);break;default:Guard.raise(new Exception("Not supported Entity state"))}}this._saveCollections(b,h)}else b.success(0)},save_getInitData:function(b,a){b.physicalData=this.context._storageModel.getStorageModel(b.data.getType()).PhysicalType.convertTo(b.data,a);var c={};b.physicalData.getType().memberDefinitions.asArray().forEach(function(a){if(a.kind==$data.MemberTypes.navProperty||a.kind==$data.MemberTypes.complexProperty||a.kind==$data.MemberTypes.property&&!a.notMapped)Container.resolveType(a.type)===
$data.Array&&a.kind===$data.MemberTypes.property&&b.physicalData[a.name]?c[a.name]=JSON.parse(JSON.stringify(b.physicalData[a.name])):c[a.computed?"_id":a.name]=b.physicalData[a.name]},this);return c},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.ObjectID,$data.Object],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},notEqual:{mapTo:"$ne",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression]},equalTyped:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},notEqualTyped:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThan:{mapTo:"$gt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThanOrEqual:{mapTo:"$gte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},lessThan:{mapTo:"$lt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},
lessThenOrEqual:{mapTo:"$lte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},or:{mapTo:"$or",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},and:{mapTo:"$and",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},"in":{mapTo:"$in",allowedIn:[$data.Expressions.FilterExpression]}}},supportedUnaryOperators:{value:{not:{mapTo:"$nor"}}},supportedFieldOperations:{value:{contains:{dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"substring",
dataType:"string"}]},startsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]}},enumerable:!0,writable:!0},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},take:{},skip:{},orderBy:{},
orderByDescending:{},first:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},"$data.Date":function(b){return b?new Date(b):b},"$data.String":function(b){return b},"$data.Boolean":function(b){return b},"$data.Blob":function(b){return b},"$data.Object":function(b){return void 0===b?new $data.Object:b},"$data.Array":function(b){return void 0===b?new $data.Array:b},"$data.ObjectID":function(b){return b?(new Buffer(b.toString(),
"ascii")).toString("base64"):b}},toDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},"$data.Date":function(b){return b},"$data.String":function(b){return b},"$data.Boolean":function(b){if("string"===typeof b)switch(b){case "true":case "true":case "TRUE":case "yes":case "Yes":case "YES":return!0;default:return!1}return null===b||void 0===b?null:!!b},"$data.Blob":function(b){return b},"$data.Object":function(b){return b},"$data.Array":function(b){return b},"$data.ObjectID":function(b){return b&&
"string"===typeof b?new $data.mongoDBDriver.ObjectID.createFromHexString((new Buffer(b,"base64")).toString("ascii")):b}}}}},{isSupported:{get:function(){return!$data.mongoDBDriver?!1:!0},set:function(){}}});$data.storageProviders.mongoDB.mongoDBProvider.isSupported&&$data.StorageProviderBase.registerProvider("mongoDB",$data.storageProviders.mongoDB.mongoDBProvider);
