// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.storageProviders.InMemory.InMemoryProvider",$data.StorageProviderBase,null,{constructor:function(a,b){this.context=b;this.providerConfiguration=$data.typeSystem.extend({source:null},a)},initializeStore:function(a){a=$data.typeSystem.createCallbackSetting(a);this.providerConfiguration.source=this.providerConfiguration.source||{};for(var b=Object.keys(this.context._entitySetReferences),c=0;c<b.length;c++){var e=this.context._entitySetReferences[b[c]];if(this.providerConfiguration.source[e.name])for(var d=
this.providerConfiguration.source[e.name],f=0;f<d.length;f++)d[f]instanceof e.elementType||Guard.raise(new Exception("Invalid element in source: '"+b[c]));else this.providerConfiguration.source[e.name]=[]}a.success(this.context)},executeQuery:function(a,b){var b=$data.typeSystem.createCallbackSetting(b),c;try{c=this._compile(a)}catch(e){b.error(e);return}var d=[].concat(this.providerConfiguration.source[a.context.getEntitySetFromElementType(a.defaultType).name]||[]);c.$filter&&!c.$every&&(d=d.filter(c.$filter));
c.$map&&(d=d.map(c.$map));void 0!==c.$take&&void 0!==c.$skip?d=d.slice(c.$skip,c.$skip+c.$take):void 0!==c.$take&&d.length>c.$take?d=d.slice(0,c.$take):c.$skip&&(d=d.slice(c.$skip,d.length));if(c.$order&&0<c.$order.length){c.$order.reverse();for(var f=0,g=c.$order.length;f<g;f++)c.$order[f].ASC?d.sort(function(a,b){return c.$order[f](a)>c.$order[f](b)}):d.sort(function(a,b){return c.$order[f](a)<c.$order[f](b)})}c.$some&&(d=[0<d.length]);c.$length&&(d=[d.length]);a.rawDataList=d;b.success(a)},_compile:function(a){return(new $data.storageProviders.InMemory.InMemoryCompiler(this)).compile(a)},
saveChanges:function(a,b){for(var c=0;c<b.length;c++){var e=b[c];switch(e.data.entityState){case $data.EntityState.Added:this.providerConfiguration.source[e.entitySet.name].push(e.data);break;case $data.EntityState.Deleted:var d=this.providerConfiguration.source[e.entitySet.name].indexOf(e.data);this.providerConfiguration.source[e.entitySet.name].splice(d,1)}}a.success()},getTraceString:function(a){return this._compile(a)},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,
$data.Boolean,$data.Date,$data.Object],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:" == ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqual:{mapTo:" != ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},equalTyped:{mapTo:" === ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqualTyped:{mapTo:" !== ",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThan:{mapTo:" > ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThanOrEqual:{mapTo:" >= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThan:{mapTo:" < ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThenOrEqual:{mapTo:" <= ",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},or:{mapTo:" || ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},and:{mapTo:" && ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},"in":{mapTo:".indexOf(",allowedIn:[$data.Expressions.FilterExpression],rightValue:") > -1",reverse:!0}}},supportedUnaryOperators:{value:{}},supportedFieldOperations:{value:{},enumerable:!0,
writable:!0},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},some:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},"$data.Date":function(a){return a?new Date(parseInt(a.substr(6))):void 0},"$data.String":function(a){return a},"$data.Boolean":function(a){return a},"$data.Blob":function(a){return a},"$data.Object":function(a){return void 0===
a?new $data.Object:JSON.parse(a)},"$data.Array":function(a){return void 0===a?new $data.Array:JSON.parse(a)}},toDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return 0==a%1?a:a+"m"},"$data.Date":function(a){return a?"datetime'"+a.toISOString()+"'":null},"$data.String":function(a){return"'"+a.replace(/'/g,"''")+"'"},"$data.Boolean":function(a){return a?"true":"false"},"$data.Blob":function(a){return a},"$data.Object":function(a){return JSON.stringify(a)},"$data.Array":function(a){return JSON.stringify(a)}}}}},
null);$data.StorageProviderBase.registerProvider("InMemory",$data.storageProviders.InMemory.InMemoryProvider);
$C("$data.storageProviders.InMemory.InMemoryCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a){var b={urlText:""};this.Visit(a.expression,b);var a={},c;for(c in b)0==c.indexOf("$")&&(a[c]=b[c]);return a},VisitOrderExpression:function(a,b){this.Visit(a.source,b);b.data="";b.lambda="";Container.createInMemoryFunctionCompiler(this.provider).compile(a.selector,b);b.$order=b.$order||[];var c=new Function(b.lambda,"return "+b.data+";");
c.ASC="OrderBy"==a.nodeType;b.$order.push(c);b.data="";b.lambda=""},VisitIncludeExpression:function(a,b){this.Visit(a.source,b);b.$include=b.$include||[];0>b.$include.indexOf(a.selector.value)&&b.$include.push(a.selector.value)},VisitPagingExpression:function(a,b){this.Visit(a.source,b);b["$"+a.nodeType.toLowerCase()]=a.amount.value},VisitProjectionExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$map")},VisitFilterExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$filter")},VisitSomeExpression:function(a,
b){this.defaultFunctionCompiler(a,b,"$some")},VisitEveryExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$every")},VisitCountExpression:function(a,b){this.Visit(a.source,b);b.$length=!0},VisitServiceOperationExpression:function(a,b){b.$serviceOperation={name:a.cfg.serviceName,params:a.params}},defaultFunctionCompiler:function(a,b,c){this.Visit(a.source,b);b.data="";b.lambda="";Container.createInMemoryFunctionCompiler(this.provider).compile(a.selector,b);b[c]=new Function(b.lambda,"return "+
b.data+";");b.data="";b.lambda=""}},{});
$C("$data.storageProviders.InMemory.InMemoryFunctionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b)},VisitUnaryExpression:function(a,b){b.data+=a.resolution.mapTo;b.data+="(";this.Visit(a.operand,b);b.data+=")"},VisitSimpleBinaryExpression:function(a,b){a.resolution.reverse?(b.data+="(",this.Visit(a.right,b),b.data+=a.resolution.mapTo,this.Visit(a.left,
b),a.resolution.rightValue&&(b.data+=a.resolution.rightValue)):(b.data+="(",this.Visit(a.left,b),b.data+=a.resolution.mapTo,this.Visit(a.right,b));b.data+=")"},VisitConstantExpression:function(a,b){var c=Container.resolveType(a.type),c=Container.resolveName(c);b.data+=this.provider.fieldConverter.toDb[c](a.value)},VisitMemberInfoExpression:function(a,b){b.data+=a.memberName},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b);b.data+="."},VisitEntityExpression:function(a,
b){b.data+=a.selector.lambda+".";b.lambda=a.selector.lambda;this.Visit(a.source,b)},VisitEntitySetExpression:function(){},VisitObjectLiteralExpression:function(a,b){b.data+="{ ";for(var c=0;c<a.members.length;c++){var e=a.members[c];0<c&&(b.data+=", ");this.Visit(e,b)}b.data+=" }"},VisitObjectFieldExpression:function(a,b){b.data+=a.fieldName+": ";this.Visit(a.expression,b)}});
