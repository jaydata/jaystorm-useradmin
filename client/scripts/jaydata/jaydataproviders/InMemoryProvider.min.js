// JayData 1.2.3
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.storageProviders.InMemory.InMemoryProvider",$data.StorageProviderBase,null,{constructor:function(a,b){this.context=b;this.providerConfiguration=$data.typeSystem.extend({source:null,persistentData:!1,localStoreName:"JayData_InMemory_Provider",databaseName:"JayData_InMemory_Provider"},a);"JayData_InMemory_Provider"===this.providerConfiguration.databaseName&&(this.providerConfiguration.databaseName=this.providerConfiguration.localStoreName)},initializeStore:function(a){var a=$data.typeSystem.createCallbackSetting(a),
b=[],c;for(c in this.context._entitySetReferences)b.push(this.context._entitySetReferences[c].collectionName);var e=null;if(this.providerConfiguration.persistentData&&window.localStorage)var d=this,e=JSON.parse(window.localStorage.getItem(this.providerConfiguration.databaseName||"JayData_InMemory_Provider"),function(a,c){return-1<b.indexOf(a)&&c.map?c.map(function(b){return new d.context[a].createNew(b)}):c});e=e||this.providerConfiguration.source||{};this.providerConfiguration.source={inmemory_sequence:{}};
for(var f=0;f<this.context._storageModel.length;f++){var g=this.context._storageModel[f];this.providerConfiguration.source[g.ItemName]=[];var h=g.LogicalType.memberDefinitions.getKeyProperties().filter(function(a){return a.computed});1<h.length&&Guard.raise(new Exception("More than one computed field not supported in "+g.ItemName+" entity set."));var j=!1;1===h.length&&(c=Container.resolveType(h[0].type),c===$data.Integer?(this.providerConfiguration.source.inmemory_sequence[g.ItemName]=0,j=!0):c!==
$data.Guid&&Guard.raise(new Exception("Not supported key field type. Computed pk field type are $data.Integer or $data.Guid!","ComputedKeyFieldError")));if(e[g.ItemName])for(c=0;c<e[g.ItemName].length;c++){var i=e[g.ItemName][c];if(i instanceof g.LogicalType){if(j){var k=i[h[0].name];k>this.providerConfiguration.source.inmemory_sequence[g.ItemName]&&(this.providerConfiguration.source.inmemory_sequence[g.ItemName]=k)}this.providerConfiguration.source[g.ItemName].push(i)}else Guard.raise(new Exception("Invalid element in source: "+
g.ItemName))}}a.success(this.context)},executeQuery:function(a,b){var b=$data.typeSystem.createCallbackSetting(b),c;try{c=this._compile(a)}catch(e){b.error(e);return}var d=[].concat(this.providerConfiguration.source[a.context.getEntitySetFromElementType(a.defaultType).collectionName]||[]);c.$filter&&!c.$every&&(d=d.filter(c.$filter));c.$map&&(d=d.map(c.$map));void 0!==c.$take&&void 0!==c.$skip?d=d.slice(c.$skip,c.$skip+c.$take):void 0!==c.$take&&d.length>c.$take?d=d.slice(0,c.$take):c.$skip&&(d=d.slice(c.$skip,
d.length));if(c.$order&&0<c.$order.length){c.$order.reverse();for(var f=0,g=c.$order.length;f<g;f++)c.$order[f].ASC?d.sort(function(a,b){var d=c.$order[f](a),e=c.$order[f](b);return d===e?0:d>e?1:-1}):d.sort(function(a,b){var d=c.$order[f](a),e=c.$order[f](b);return d===e?0:d<e?1:-1})}c.$some&&(d=[0<d.length]);c.$length&&(d=[d.length]);a.rawDataList=d;b.success(a)},_compile:function(a){return(new $data.storageProviders.InMemory.InMemoryCompiler(this)).compile(a)},saveChanges:function(a,b){for(var c=
0;c<b.length;c++){var e=b[c];switch(e.data.entityState){case $data.EntityState.Added:this._save_add_processPk(e);this.providerConfiguration.source[e.entitySet.collectionName].push(e.data);break;case $data.EntityState.Deleted:var d=this.providerConfiguration.source[e.entitySet.name],f=this._save_getEntity(e,d),e=d.indexOf(f);d.splice(e,1);break;case $data.EntityState.Modified:if(e.data.changedProperties&&0<e.data.changedProperties.length){d=this.providerConfiguration.source[e.entitySet.name];f=this._save_getEntity(e,
d);for(d=0;d<e.data.changedProperties.length;d++){var g=e.data.changedProperties[d];!g.key&&-1<e.entitySet.elementType.memberDefinitions.getPublicMappedPropertyNames().indexOf(g.name)&&(f[g.name]=e.data[g.name])}}}}this.providerConfiguration.persistentData&&window.localStorage&&(localStorageData=window.localStorage.setItem(this.providerConfiguration.databaseName||"JayData_InMemory_Provider",JSON.stringify(this.providerConfiguration.source)));a.success()},_save_add_processPk:function(a){var b=a.entitySet.elementType.memberDefinitions.getKeyProperties();
if(1===b.length&&b[0].computed){var b=b[0],c=Container.resolveType(b.type);c===$data.Guid?a.data[b.name]=$data.Guid.NewGuid():c===$data.Integer?(c=this.providerConfiguration.source.inmemory_sequence[a.entitySet.collectionName],a.data[b.name]=c+1,this.providerConfiguration.source.inmemory_sequence[a.entitySet.collectionName]=c+1):Guard.raise(new Exception("Not supported data type!"))}else for(c=0;c<b.length;c++)(null===a.data[b[c].name]||void 0===a.data[b[c].name])&&Guard.raise(new Exception("Key field must set value! Key field name without value: "+
b[c].name))},_save_getEntity:function(a,b){var c=a.entitySet.elementType.memberDefinitions.getKeyProperties();entities=b.filter(function(b){for(var d=!0,f=0;f<c.length;f++)d=d&&b[c[f].name]===a.data[c[f].name];return d});1<entities&&Guard.raise(new Exception("Inconsistent storage!"));return entities[0]},getTraceString:function(a){return this._compile(a)},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.Object,$data.Guid],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:" == ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqual:{mapTo:" != ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},equalTyped:{mapTo:" === ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqualTyped:{mapTo:" !== ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThan:{mapTo:" > ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThanOrEqual:{mapTo:" >= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThan:{mapTo:" < ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThenOrEqual:{mapTo:" <= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},or:{mapTo:" || ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},and:{mapTo:" && ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},"in":{mapTo:".indexOf(",allowedIn:[$data.Expressions.FilterExpression],rightValue:") > -1",reverse:!0}}},supportedUnaryOperators:{value:{not:{mapTo:"!"}}},supportedFieldOperations:{value:{contains:{mapTo:"$data.StringFunctions.contains(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",
dataType:"string"},{name:"strFragment",dataType:"string"}]},startsWith:{mapTo:"$data.StringFunctions.startsWith(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{mapTo:"$data.StringFunctions.endsWith(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},length:{dataType:"number",propertyFunction:!0},substr:{mapTo:"substr(",rightValue:")",
dataType:"string",parameters:[{name:"startFrom",dataType:"number"},{name:"length",dataType:"number"}],propertyFunction:!0},toLowerCase:{dataType:"string",mapTo:"toLowerCase()",propertyFunction:!0},toUpperCase:{dataType:"string",mapTo:"toUpperCase()",propertyFunction:!0},trim:{dataType:$data.String,mapTo:"trim()",propertyFunction:!0},ltrim:{dataType:$data.String,mapTo:"trimLeft()",propertyFunction:!0},rtrim:{dataType:$data.String,mapTo:"trimRight()",propertyFunction:!0}},enumerable:!0,writable:!0},
supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},some:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return a},"$data.Date":function(a){return a?new Date(parseInt(a.substr(6))):void 0},"$data.String":function(a){return a},"$data.Boolean":function(a){return a},"$data.Blob":function(a){return a},"$data.Object":function(a){return void 0===
a?new $data.Object:JSON.parse(a)},"$data.Array":function(a){return void 0===a?new $data.Array:JSON.parse(a)},"$data.Guid":function(a){return"string"===typeof a?$data.parseGuid(a):a}},toDb:{"$data.Integer":function(a){return a},"$data.Number":function(a){return 0==a%1?a:a+"m"},"$data.Date":function(a){return a?"datetime'"+a.toISOString()+"'":null},"$data.String":function(a){return"'"+a.replace(/'/g,"''")+"'"},"$data.Boolean":function(a){return a?"true":"false"},"$data.Blob":function(a){return a},"$data.Object":function(a){return JSON.stringify(a)},
"$data.Array":function(a){return JSON.stringify(a)},"$data.Guid":function(a){return a}}}}},null);$C("$data.storageProviders.InMemory.LocalStorageProvider",$data.storageProviders.InMemory.InMemoryProvider,null,{constructor:function(){this.providerConfiguration.persistentData=!0}},null);$data.StorageProviderBase.registerProvider("InMemory",$data.storageProviders.InMemory.InMemoryProvider);$data.StorageProviderBase.registerProvider("LocalStore",$data.storageProviders.InMemory.LocalStorageProvider);
$C("$data.storageProviders.InMemory.InMemoryCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a){var b={urlText:""};this.Visit(a.expression,b);var a={},c;for(c in b)0==c.indexOf("$")&&(a[c]=b[c]);return a},VisitOrderExpression:function(a,b){this.Visit(a.source,b);b.data="";b.lambda="";Container.createInMemoryFunctionCompiler(this.provider).compile(a.selector,b);b.$order=b.$order||[];var c=new Function(b.lambda,"return "+b.data+";");
c.ASC="OrderBy"==a.nodeType;b.$order.push(c);b.data="";b.lambda=""},VisitIncludeExpression:function(a,b){this.Visit(a.source,b);b.$include=b.$include||[];0>b.$include.indexOf(a.selector.value)&&b.$include.push(a.selector.value)},VisitPagingExpression:function(a,b){this.Visit(a.source,b);b["$"+a.nodeType.toLowerCase()]=a.amount.value},VisitProjectionExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$map")},VisitFilterExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$filter")},VisitSomeExpression:function(a,
b){this.defaultFunctionCompiler(a,b,"$some")},VisitEveryExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$every")},VisitCountExpression:function(a,b){this.Visit(a.source,b);b.$length=!0},VisitServiceOperationExpression:function(a,b){b.$serviceOperation={name:a.cfg.serviceName,params:a.params}},defaultFunctionCompiler:function(a,b,c){this.Visit(a.source,b);b.data="";b.lambda="";Container.createInMemoryFunctionCompiler(this.provider).compile(a.selector,b);b[c]=new Function(b.lambda,"return "+
b.data+";");b.data="";b.lambda=""}},{});
$C("$data.storageProviders.InMemory.InMemoryFunctionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b)},VisitUnaryExpression:function(a,b){b.data+=a.resolution.mapTo;b.data+="(";this.Visit(a.operand,b);b.data+=")"},VisitSimpleBinaryExpression:function(a,b){a.resolution.reverse?(b.data+="(",this.Visit(a.right,b),b.data+=a.resolution.mapTo,this.Visit(a.left,
b),a.resolution.rightValue&&(b.data+=a.resolution.rightValue)):(b.data+="(",this.Visit(a.left,b),b.data+=a.resolution.mapTo,this.Visit(a.right,b));b.data+=")"},VisitConstantExpression:function(a,b){var c=Container.resolveType(a.type),c=Container.resolveName(c);b.data+=this.provider.fieldConverter.toDb[c](a.value)},VisitMemberInfoExpression:function(a,b){b.data+=a.memberName},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b);b.data+="."},VisitEntityExpression:function(a,
b){b.data+=a.selector.lambda+".";b.lambda=a.selector.lambda;this.Visit(a.source,b)},VisitEntitySetExpression:function(){},VisitObjectLiteralExpression:function(a,b){b.data+="{ ";for(var c=0;c<a.members.length;c++){var e=a.members[c];0<c&&(b.data+=", ");this.Visit(e,b)}b.data+=" }"},VisitObjectFieldExpression:function(a,b){b.data+=a.fieldName+": ";this.Visit(a.expression,b)},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);
var c=a.operation.memberDefinition;c.propertyFunction&&(this.Visit(a.source,b),b.data+=".");b.data+=c.mapTo||c.name;var e=0;(c.parameters||[]).map(function(b){return b.name==="@expression"?a.source:a.parameters[e++]}).forEach(function(a,c){if(a){if(c>0)b.data=b.data+",";this.Visit(a,b)}},this);b.data+=c.rightValue||""}});
