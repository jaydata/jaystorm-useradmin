// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.storageProviders.oData.oDataProvider",$data.StorageProviderBase,null,{constructor:function(b,a){"undefined"===typeof OData&&Guard.raise(new Exception("datajs is required","Not Found!"));this.SqlCommands=[];this.context=a;this.providerConfiguration=$data.typeSystem.extend({dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,oDataServiceHost:"/odata.svc",serviceUrl:"",maxDataServiceVersion:"2.0",user:null,password:null},b);this.context&&this.context._buildDbType_generateConvertToFunction&&
this.buildDbType_generateConvertToFunction&&(this.context._buildDbType_generateConvertToFunction=this.buildDbType_generateConvertToFunction);this.context&&this.context._buildDbType_modifyInstanceDefinition&&this.buildDbType_modifyInstanceDefinition&&(this.context._buildDbType_modifyInstanceDefinition=this.buildDbType_modifyInstanceDefinition)},initializeStore:function(b){b=$data.typeSystem.createCallbackSetting(b);switch(this.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.DropAllExistingTables:var a=
this;if(this.providerConfiguration.serviceUrl){var c=[{requestUri:a.providerConfiguration.serviceUrl+"/Delete",method:"POST"},function(){console.log("RESET oData database");b.success(a.context)},function(){b.success(a.context)}];this.providerConfiguration.user&&(c[0].user=this.providerConfiguration.user,c[0].password=this.providerConfiguration.password||"");this.context.prepareRequest.call(this,c);OData.request.apply(this,c)}else b.success(a.context);break;default:b.success(this.context)}},buildDbType_generateConvertToFunction:function(b,
a){return function(c,e){var d=new b.PhysicalType;d.entityState=c.entityState;b.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a){d[a.name]=c[a.name]},this);b.Associations&&b.Associations.forEach(function(b){if("*"==b.FromMultiplicity&&"0..1"==b.ToMultiplicity||"0..1"==b.FromMultiplicity&&"1"==b.ToMultiplicity||"$$unbound"==b.FromMultiplicity){var f=c[b.FromPropertyName];if(null!==f&&void 0!==f)if(f instanceof $data.Array)d[b.FromPropertyName]=d[b.FromPropertyName]||[],
f.forEach(function(a){a=e.indexOf(a);0>a&&Guard.raise("Dependency graph error");d[b.FromPropertyName].push({__metadata:{uri:"$"+(a+1)}})},this);else if(f.entityState===$data.EntityState.Modified){var h=a._storageModel.getStorageModel(f.getType()).TableName,i="(";f.getType().memberDefinitions.getKeyProperties().forEach(function(a,b){0<b&&(i+=",");i+=f[a.name]},this);i+=")";d[b.FromPropertyName]={__metadata:{uri:h+i}}}else h=e.indexOf(f),0>h&&Guard.raise("Dependency graph error"),d[b.FromPropertyName]=
{__metadata:{uri:"$"+(h+1)}}}},this);b.ComplexTypes&&b.ComplexTypes.forEach(function(a){d[a.FromPropertyName]=c[a.FromPropertyName]},this);return d}},executeQuery:function(b,a){var a=$data.typeSystem.createCallbackSetting(a),c;try{c=this._compile(b)}catch(e){a.error(e);return}c=[{requestUri:this.providerConfiguration.oDataServiceHost+c.queryText,headers:{MaxDataServiceVersion:this.providerConfiguration.maxDataServiceVersion}},function(c,e){c||(c=JSON.parse(e.body));a.success&&(b.rawDataList="string"===
typeof c?[{cnt:c}]:c,a.success(b))},function(b,c,e){a.error(e)}];this.providerConfiguration.user&&(c[0].user=this.providerConfiguration.user,c[0].password=this.providerConfiguration.password||"");this.context.prepareRequest.call(this,c);OData.request.apply(this,c)},_compile:function(b){return(new $data.storageProviders.oData.oDataCompiler).compile(b)},saveChanges:function(b,a){0<a.length?this.saveInternal(this.buildIndependentBlocks(a),0,b):b.success(0)},saveInternal:function(b,a,c){batchRequests=
[];convertedItem=[];for(a=0;a<b.length;a++)for(var e=0;e<b[a].length;e++){convertedItem.push(b[a][e].data);var d={};d.headers={"Content-Id":convertedItem.length};switch(b[a][e].data.entityState){case $data.EntityState.Unchanged:continue;case $data.EntityState.Added:d.method="POST";d.requestUri=b[a][e].entitySet.name;d.data=this.save_getInitData(b[a][e],convertedItem);break;case $data.EntityState.Modified:d.method="MERGE";d.requestUri=b[a][e].entitySet.name;d.requestUri+="("+this.getEntityKeysValue(b[a][e])+
")";this.save_addConcurrencyHeader(b[a][e],d.headers);d.data=this.save_getInitData(b[a][e],convertedItem);break;case $data.EntityState.Deleted:d.method="DELETE";d.requestUri=b[a][e].entitySet.name;d.requestUri+="("+this.getEntityKeysValue(b[a][e])+")";this.save_addConcurrencyHeader(b[a][e],d.headers);break;default:Guard.raise(new Exception("Not supported Entity state"))}batchRequests.push(d)}b=[{requestUri:this.providerConfiguration.oDataServiceHost+"/$batch",method:"POST",data:{__batchRequests:[{__changeRequests:batchRequests}]}},
function(a,b){if(202==b.statusCode){for(var d=a.__batchResponses[0].__changeResponses,e=0;e<d.length;e++){var j=convertedItem[e];if(204==d[e].statusCode){if(d[e].headers.ETag){var k=j.getType().memberDefinitions.getPublicMappedProperties().filter(function(a){return a.concurrencyMode===$data.ConcurrencyMode.Fixed});k&&k[0]&&(j[k[0].name]=d[e].headers.ETag)}}else j.getType().memberDefinitions.getPublicMappedProperties().forEach(function(a){a.computed&&(j[a.name]=a.concurrencyMode===$data.ConcurrencyMode.Fixed?
d[e].headers.ETag:d[e].data[a.name])},this)}c.success&&c.success(convertedItem.length)}else c.error(b)},c.error,OData.batchHandler];this.providerConfiguration.user&&(b[0].user=this.providerConfiguration.user,b[0].password=this.providerConfiguration.password||"");this.context.prepareRequest.call(this,b);OData.request.apply(this,b)},save_getInitData:function(b,a){b.physicalData=this.context._storageModel.getStorageModel(b.data.getType()).PhysicalType.convertTo(b.data,a);var c={};b.physicalData.getType().memberDefinitions.asArray().forEach(function(a){if(a.kind==
$data.MemberTypes.navProperty||a.kind==$data.MemberTypes.complexProperty||a.kind==$data.MemberTypes.property&&!a.notMapped)c[a.name]=b.physicalData[a.name]},this);return c},save_addConcurrencyHeader:function(b,a){var c=b.data.getType().memberDefinitions.getPublicMappedProperties().filter(function(a){return a.concurrencyMode===$data.ConcurrencyMode.Fixed});c&&c[0]&&(a["If-Match"]=b.data[c[0].name],b.data[c[0].name]="")},getTraceString:function(b){this._compile(b);return b},supportedDataTypes:{value:[$data.Integer,
$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:"eq",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqual:{mapTo:"ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},equalTyped:{mapTo:"eq",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqualTyped:{mapTo:"ne",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThan:{mapTo:"gt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThanOrEqual:{mapTo:"ge",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThan:{mapTo:"lt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThenOrEqual:{mapTo:"le",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},or:{mapTo:"or",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},and:{mapTo:"and",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},add:{mapTo:"add",dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},divide:{mapTo:"div",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},
multiply:{mapTo:"mul",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},subtract:{mapTo:"sub",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},modulo:{mapTo:"mod",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},"in":{mapTo:"in",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]}}},supportedUnaryOperators:{value:{not:{mapTo:"not"}}},supportedFieldOperations:{value:{contains:{mapTo:"substringof",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"substring",dataType:"string"},{name:"@expression"}]},startsWith:{mapTo:"startswith",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{mapTo:"endswith",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],
parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},length:{dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],parameters:[{name:"@expression",dataType:"string"}]},indexOf:{dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],mapTo:"indexof",baseIndex:1,parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},replace:{dataType:"string",
allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFrom",dataType:"string"},{name:"strTo",dataType:"string"}]},substr:{mapTo:"substring",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"},{name:"startFrom",dataType:"number"},{name:"length",dataType:"number",optional:"true"}]},toLowerCase:{mapTo:"tolower",dataType:"string",
allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"}]},toUpperCase:{mapTo:"toupper",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"}]},trim:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"}]},concat:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},day:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},hour:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},minute:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",
dataType:"date"}]},month:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},second:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},year:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},round:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],
parameters:[{name:"@expression",dataType:"date"}]},floor:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},ceiling:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]}},enumerable:!0,writable:!0},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},some:{invokable:!1,allowedIn:[$data.Expressions.FilterExpression],
parameters:[{name:"filter",dataType:"$data.Queryable"}],mapTo:"any",frameType:$data.Expressions.SomeExpression},every:{invokable:!1,allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"filter",dataType:"$data.Queryable"}],mapTo:"all",frameType:$data.Expressions.EveryExpression},take:{},skip:{},orderBy:{},orderByDescending:{},first:{},include:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},"$data.Date":function(b){return b?
new Date(parseInt(b.substr(6))):void 0},"$data.String":function(b){return b},"$data.Boolean":function(b){return b},"$data.Blob":function(b){return b},"$data.Object":function(b){return void 0===b?new $data.Object:"string"===typeof b?JSON.parse(b):b},"$data.Array":function(b){return void 0===b?new $data.Array:b instanceof $data.Array?b:JSON.parse(b)}},toDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return 0==b%1?b:b+"m"},"$data.Date":function(b){return b?"datetime'"+b.toISOString()+
"'":null},"$data.String":function(b){return"'"+b.replace(/'/g,"''")+"'"},"$data.Boolean":function(b){return b?"true":"false"},"$data.Blob":function(b){return b},"$data.Object":function(b){return JSON.stringify(b)},"$data.Array":function(b){return JSON.stringify(b)}}}},getEntityKeysValue:function(b){for(var a=[],c=void 0,e=b.entitySet.createNew.memberDefinitions.asArray(),d=0,g=e.length;d<g;d++){var f=e[d];if(f.key){c=b.data[f.name];switch(f.dataType){case "Edm.Guid":c="guid'"+c+"'";break;case "Edm.Binary":c=
"binary'"+c+"'";break;case "Edm.Byte":c="0123456789ABCDEF"[d>>4&15]+"0123456789ABCDEF"[d&15];break;case "Edm.DateTime":c="datetime'"+c.toISOString()+"'";break;case "Edm.Decimal":c+="M";break;case "Edm.Single":c+="f";break;case "Edm.Int64":c+="L";break;case "Edm.String":case "string":c="'"+c+"'"}a.push(f.name+"="+c)}}return 1<a.length?a.join(","):c}},null);$data.StorageProviderBase.registerProvider("oData",$data.storageProviders.oData.oDataProvider);
$C("$data.storageProviders.oData.oDataCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.context={};this.provider={};this.mainEntitySet=this.includes=null},compile:function(b){this.provider=b.context.storageProvider;this.context=b.context;this.mainEntitySet=b.context.getEntitySetFromElementType(b.defaultType);var a={urlText:""};this.Visit(b.expression,a);b.modelBinderConfig={};Container.createModelBinderConfigCompiler(b,this.includes,!0).Visit(b.expression);var c=
a.urlText,e=!1,d;for(d in a)"urlText"!=d&&"actionPack"!=d&&"data"!=d&&"lambda"!=d&&""!=a[d]&&(c=e?c+"&":c+"?",e=!0,c="$urlParams"!=d?c+(d+"="+a[d]):c+a[d]);b.queryText=c;return{queryText:c,params:[]}},VisitOrderExpression:function(b,a){this.Visit(b.source,a);Container.createoDataOrderCompiler(this.provider).compile(b,a)},VisitPagingExpression:function(b,a){this.Visit(b.source,a);Container.createoDataPagingCompiler().compile(b,a)},VisitIncludeExpression:function(b,a){this.Visit(b.source,a);if(!a.$select){a.$expand=
a.$expand?a.$expand+",":"";a.$expand+=b.selector.value.replace(/\./g,"/");this.includes=this.includes||[];for(var c=b.selector.value.split("."),e=null,d=this.mainEntitySet.entityContext._storageModel.getStorageModel(this.mainEntitySet.createNew),g=0;g<c.length;g++)e=e?e+("."+c[g]):c[g],(d=d.Associations[c[g]])?this.includes.some(function(a){return a.name==e},this)||this.includes.push({name:e,type:d.ToType}):Guard.raise(new Exception("The given include path is invalid: "+b.selector.value+", invalid point: "+
e)),d=this.mainEntitySet.entityContext._storageModel.getStorageModel(d.ToType)}},VisitProjectionExpression:function(b,a){this.Visit(b.source,a);Container.createoDataProjectionCompiler(this.context).compile(b,a)},VisitFilterExpression:function(b,a){this.Visit(b.source,a);var c=Container.createoDataWhereCompiler(this.provider);a.data="";c.compile(b.selector,a);a.$filter=a.data;a.data=""},VisitEntitySetExpression:function(b,a){a.urlText+="/"+b.instance.tableName;if(b.params)for(var c=0;c<b.params.length;c++)this.Visit(b.params[c],
a)},VisitServiceOperationExpression:function(b,a){a.urlText+="/"+b.cfg.serviceName;if(b.params)for(var c=0;c<b.params.length;c++)this.Visit(b.params[c],a)},VisitConstantExpression:function(b,a){a.$urlParams=a.$urlParams?a.$urlParams+"&":"";var c=Container.getTypeName(b.value);a.$urlParams+=b.name+"="+this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(c))](b.value)},VisitCountExpression:function(b,a){this.Visit(b.source,a);a.urlText+="/$count"}},{});
$C("$data.storageProviders.oData.oDataWhereCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a){this.provider=b;this.lambdaPrefix=a},compile:function(b,a){this.Visit(b,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitUnaryExpression:function(b,a){a.data+=b.resolution.mapTo;a.data+="(";this.Visit(b.operand,a);a.data+=")"},VisitSimpleBinaryExpression:function(b,a){a.data+="(";if("in"==b.nodeType){Guard.requireType("expression.right",b.type,
$data.Expressions.ConstantExpression);var c=b.right.value;!c instanceof Array&&Guard.raise(new Exception("Right to the 'in' operator must be an array value"));var e=null,d={mapTo:"or",dataType:"boolean",name:"or"},g={mapTo:"eq",dataType:"boolean",name:"equal"};c.forEach(function(a){a=Container.createConstantExpression(a);a=Container.createSimpleBinaryExpression(b.left,a,$data.Expressions.ExpressionType.Equal,"==","boolean",g);e=e?Container.createSimpleBinaryExpression(e,a,$data.Expressions.ExpressionType.Or,
"||","boolean",d):a});c=a.data;a.data="";this.Visit(e,a);a.data=c+a.data.replace(/\(/g,"").replace(/\)/g,"")}else this.Visit(b.left,a),a.data+=" ",a.data+=b.resolution.mapTo,a.data+=" ",this.Visit(b.right,a);a.data+=")"},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){a.data+=b.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(b,a){a.data+=b.memberName},VisitQueryParameterExpression:function(b,
a){a.data+=this.provider.fieldConverter.toDb[b.type](b.value)},VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition;a.data+=c.mapTo||c.name;a.data+="(";var e=0;(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[e++]}).forEach(function(b,c){0<c&&(a.data+=",");this.Visit(b,a)},this);a.data+=")"},VisitConstantExpression:function(b,
a){var c=Container.getTypeName(b.value);a.data+=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(c))](b.value)},VisitEntityExpression:function(b,a){this.Visit(b.source,a);this.lambdaPrefix&&b.selector.lambda&&(a.lambda=b.selector.lambda,a.data+=b.selector.lambda+"/")},VisitEntitySetExpression:function(b,a){this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.selector,a),a.data+="/")},VisitFrameOperationExpression:function(b,
a){this.Visit(b.source,a);Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition;a.data+=c.mapTo||c.name;a.data+="(";for(var e=0,d=(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[e++]}),g=0;g<d.length;g++){var f=d[g];if(f&&f.value instanceof $data.Queryable){var h=new c.frameType(f.value.expression),f=Container.createQueryExpressionCreator(f.value.entityContext).Visit(h),
h={data:""};(new $data.storageProviders.oData.oDataWhereCompiler(this.provider,!0)).compile(f,h);a.data+=h.lambda+": "+h.data}}a.data+=")"}});
$C("$data.storageProviders.oData.oDataOrderCompiler",$data.storageProviders.oData.oDataWhereCompiler,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitOrderExpression:function(b,a){var c={data:""};this.Visit(b.selector,c);a.$orderby=a.$orderby?a.$orderby+",":"";a.$orderby+=c.data+(b.nodeType==$data.Expressions.ExpressionType.OrderByDescending?" desc":"")},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitEntityFieldExpression:function(b,
a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a);a.data+="/"},VisitEntitySetExpression:function(b,a){b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.source,a),this.Visit(b.selector,a))},VisitAssociationInfoExpression:function(b,a){a.data+=b.associationInfo.FromPropertyName+"/"},VisitEntityExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitMemberInfoExpression:function(b,
a){a.data+=b.memberName}});
$C("$data.storageProviders.oData.oDataPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitPagingExpression:function(b,a){var c={data:""};this.Visit(b.amount,c);switch(b.nodeType){case $data.Expressions.ExpressionType.Skip:a.$skip=c.data;break;case $data.Expressions.ExpressionType.Take:a.$top=c.data;break;default:Guard.raise("Not supported nodeType")}},VisitConstantExpression:function(b,a){a.data+=b.value}});
$C("$data.storageProviders.oData.oDataProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b){this.entityContext=b;this.hasObjectLiteral=!1;this.ObjectLiteralPath="";this.modelBinderMapping=[]},compile:function(b,a){this.Visit(b,a)},VisitProjectionExpression:function(b,a){this.mapping=a.data="";this.Visit(b.selector,a);a.$select=a.$select?a.$select+",":"";a.$select+=a.data;a.data=""},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a);b.expression instanceof
$data.Expressions.EntityExpression&&(a.$expand=a.$expand?a.$expand+",":"",a.$expand+=this.mapping.replace(/\./g,"/"));var c=this.mapping.split(".");c.pop();0<c.length&&(a.$expand=a.$expand?a.$expand+",":"",a.$expand+=c.join("/"))},VisitObjectLiteralExpression:function(b,a){var c=this.ObjectLiteralPath;this.hasObjectLiteral=!0;b.members.forEach(function(c,d){this.Visit(c,a);d<b.members.length-1&&(a.data+=",");this.mapping=""},this);this.ObjectLiteralPath=c},VisitObjectFieldExpression:function(b,a){this.ObjectLiteralPath=
this.ObjectLiteralPath?this.ObjectLiteralPath+("."+b.fieldName):b.fieldName;this.Visit(b.expression,a);if(b.expression instanceof $data.Expressions.EntityExpression)a.$expand=a.$expand?a.$expand+",":"",a.$expand+=this.mapping.replace(/\./g,"/");else{var c=this.mapping.split(".");c.pop();0<c.length&&(a.$expand=a.$expand?a.$expand+",":"",a.$expand+=c.join("/"))}},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,
a);this.Visit(b.selector,a)},VisitEntityExpression:function(b,a){this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){b.source instanceof $data.Expressions.EntityExpression&&this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){a.data&&0<a.data.length&&","!=a.data[a.data.length-1]&&(a.data+="/");a.data+=b.associationInfo.FromPropertyName;this.mapping&&0<this.mapping.length&&(this.mapping+=
".");this.mapping+=b.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(b,a){a.data&&0<a.data.length&&","!=a.data[a.data.length-1]&&(a.data+="/");a.data+=b.memberName;this.mapping&&0<this.mapping.length&&(this.mapping+=".");this.mapping+=b.memberName},VisitConstantExpression:function(b,a){a.data=a.data.slice(0,a.data.length-1)}});
