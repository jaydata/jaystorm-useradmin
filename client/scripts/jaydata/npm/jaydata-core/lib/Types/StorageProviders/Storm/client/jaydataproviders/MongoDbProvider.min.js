// JayData 1.1.1
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki
//
// More info: http://jaydata.org
$C("$data.modelBinder.mongoDBModelBinderConfigCompiler",$data.modelBinder.ModelBinderConfigCompiler,null,{_addPropertyToModelBinderConfig:function(b,a){var c=this._query.context._storageModel.getStorageModel(b);b.memberDefinitions?b.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(!c||c&&!c.Associations[b.name]&&!c.ComplexTypes[b.name])!c&&0>this._query.context.storageProvider.supportedDataTypes.indexOf(Container.resolveType(b.dataType))?(a.selectModelBinderProperty(b.name),a.modelBinderConfig.$type=
Container.resolveType(b.dataType),a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.name+".results","json:"+b.name]:"json:"+b.name,this._addPropertyToModelBinderConfig(Container.resolveType(b.dataType),a),a.popModelBinderProperty()):(b.key&&a.addKeyField(b.computed?"_id":b.name),a.modelBinderConfig[b.name]=b.concurrencyMode===$data.ConcurrencyMode.Fixed?{$selector:"json:__metadata",$source:"etag"}:b.computed?"_id":b.name)},this):(a._binderConfig.$item={},a.modelBinderConfig=a._binderConfig.$item);
c&&this._addComplexTypeProperties(c.ComplexTypes,a)},VisitMemberInfoExpression:function(b,a){a.modelBinderConfig.$type=b.memberDefinition.type;b.memberDefinition.storageModel&&b.memberName in b.memberDefinition.storageModel.ComplexTypes?this._addPropertyToModelBinderConfig(Container.resolveType(b.memberDefinition.type),a):a.modelBinderConfig.$source=b.memberDefinition.computed?"_id":b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){},compile:function(b,a){this.Visit(b,a)},VisitProjectionExpression:function(b,a){this.Visit(b.selector,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitObjectLiteralExpression:function(b,a){this.hasObjectLiteral=!0;b.members.forEach(function(b){this.Visit(b,a)},this)},VisitObjectFieldExpression:function(b,a){this.Visit(b.expression,a)},
VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityExpression:function(b,a){this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){b.source instanceof $data.Expressions.EntityExpression&&this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(){},VisitMemberInfoExpression:function(b,
a){a.options.fields||(a.options.fields={_id:1});a.options.fields[b.memberName]||(a.options.fields[b.memberName]=1)},VisitConstantExpression:function(){}});
$C("$data.storageProviders.mongoDB.mongoDBWhereCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a){this.provider=b;this.lambdaPrefix=a},compile:function(b,a){this.Visit(b,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitUnaryExpression:function(b,a){a.unary=b.nodeType;this.Visit(b.operand,a)},VisitSimpleBinaryExpression:function(b,a){a.cursor||(a.query={},a.cursor=a.query);var c=a.cursor;switch(b.nodeType){case $data.Expressions.ExpressionType.Or:if(a.cursor instanceof
Array){var e={$or:[]};a.cursor.push(e);a.cursor=e.$or}else a.cursor.$or=[],a.cursor=a.cursor.$or;this.Visit(b.left,a);this.Visit(b.right,a);a.cursor=c;break;case $data.Expressions.ExpressionType.And:a.cursor instanceof Array?(e={$and:[]},a.cursor.push(e),a.cursor=e.$and):(a.cursor.$and=[],a.cursor=a.cursor.$and);this.Visit(b.left,a);this.Visit(b.right,a);a.cursor=c;break;case $data.Expressions.ExpressionType.Equal:case $data.Expressions.ExpressionType.EqualTyped:this.Visit(b.left,a);this.Visit(b.right,
a);a.queryField=a.field;a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;a.entityType?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(valueType))](c));a.value=c;a.cursor instanceof Array?(c={},c[a.queryField]=a.value,a.cursor.push(c)):
a.cursor[a.queryField]=a.value;break;case $data.Expressions.ExpressionType.In:this.Visit(b.left,a);this.Visit(b.right,a);a.queryField=a.field;a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;if(c instanceof Array)for(e=0;e<c.length;e++)a.entityType?c[e]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.field).type))](c[e]):a.valueType&&(c[e]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(valueType))](c[e]));
a.value=c;a.cursor instanceof Array?(c={},c[a.queryField]={},c[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?"$nin":b.resolution.mapTo]=a.value,a.cursor.push(c)):(a.cursor[a.queryField]={},a.cursor[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?"$nin":b.resolution.mapTo]=a.value);a.unary===$data.Expressions.ExpressionType.Not&&(a.unary=void 0);break;default:(this.Visit(b.left,a),this.Visit(b.right,a),a.queryField=a.field,a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&
(delete a.query[a.field],a.queryField="_id"),c=a.value,a.entityType?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(valueType))](c)),a.value=c,a.cursor instanceof Array)?(c={},c[a.queryField]={},c[a.queryField][b.resolution.mapTo]=a.value,a.cursor.push(c)):(a.cursor[a.queryField]={},a.cursor[a.queryField][b.resolution.mapTo]=
a.value)}},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){a.data+=b.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(b,a){a.field=b.memberName},VisitQueryParameterExpression:function(b,a){a.data+=this.provider.fieldConverter.toDb[b.type](b.value)},VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);this.Visit(b.source.selector,
a);var c=b.operation.memberDefinition,e=c.mapTo||c.name,g=0;(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[g++]}).forEach(function(b){this.Visit(b,a)},this);a.query[a.field]||(a.query[a.field]={});switch(e){case "contains":a.query[a.field].$regex=a.value;break;case "startsWith":a.query[a.field].$regex="^"+a.value;break;case "endsWith":a.query[a.field].$regex=a.value+"$"}},VisitConstantExpression:function(b,a){var c=Container.getTypeName(b.value);
a.valueType=c;a.value=b.value},VisitEntityExpression:function(b,a){a.entityType=b.entityType;this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.selector,a),a.data+="/")},VisitFrameOperationExpression:function(b,a){this.Visit(b.source,a);Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition;a.data+=c.mapTo||c.name;
a.data+="(";for(var e=0,g=(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[e++]}),d=0;d<g.length;d++){var f=g[d];if(f.value instanceof $data.Queryable){var h=new c.frameType(f.value.expression),f=(new $data.Expressions.QueryExpressionCreator(f.value.entityContext)).Visit(h),h={data:""};(new $data.storageProviders.mongoDB.mongoDBWhereCompiler(this.provider,!0)).compile(f,h);a.data+=h.lambda+": "+h.data}}a.data+=")"}});
$C("$data.storageProviders.mongoDB.mongoDBOrderCompiler",$data.storageProviders.mongoDB.mongoDBWhereCompiler,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitOrderExpression:function(b,a){var c={data:""};this.Visit(b.selector,c);a.options.sort||(a.options.sort={});a.options.sort[c.data]=b.nodeType==$data.Expressions.ExpressionType.OrderByDescending?-1:1},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitEntityFieldExpression:function(b,
a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntitySetExpression:function(b,a){b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.source,a),this.Visit(b.selector,a))},VisitAssociationInfoExpression:function(){},VisitEntityExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitMemberInfoExpression:function(b,a){a.data+=b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitPagingExpression:function(b,a){var c={data:0};this.Visit(b.amount,c);switch(b.nodeType){case $data.Expressions.ExpressionType.Skip:a.options.skip=c.data;break;case $data.Expressions.ExpressionType.Take:a.options.limit=c.data;break;default:Guard.raise("Not supported nodeType")}},VisitConstantExpression:function(b,
a){a.data+=b.value}});
$C("$data.storageProviders.mongoDB.mongoDBCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.context={};this.provider={};this.mainEntitySet=this.includes=null},compile:function(b){this.provider=b.context.storageProvider;this.context=b.context;this.mainEntitySet=b.context.getEntitySetFromElementType(b.defaultType);b.find={query:{},options:{}};b.modelBinderConfig={};(new $data.modelBinder.mongoDBModelBinderConfigCompiler(b,this.includes,!1)).Visit(b.expression);this.Visit(b.expression,
b.find);delete b.find.field;delete b.find.value;delete b.find.data;delete b.find.stack;delete b.find.or;return b},VisitOrderExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBOrderCompiler(this.provider)).compile(b,a)},VisitPagingExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBPagingCompiler).compile(b,a)},VisitFilterExpression:function(b,a){this.Visit(b.source,a);var c=new $data.storageProviders.mongoDB.mongoDBWhereCompiler(this.provider);
a.data="";c.compile(b.selector,a)},VisitProjectionExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBProjectionCompiler(this.context)).compile(b,a)}});
$C("$data.storageProviders.mongoDB.mongoDBProvider",$data.StorageProviderBase,null,{constructor:function(b,a){this.driver=$data.mongoDBDriver;this.context=a;this.providerConfiguration=$data.typeSystem.extend({dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,address:"127.0.0.1",port:27017,serverOptions:{},databaseName:"test"},b)},_getServer:function(){return this.providerConfiguration.slave&&this.providerConfiguration.slave.address&&this.providerConfiguration.slave.port?new this.driver.ReplSetServers([new this.driver.Server(this.providerConfiguration.address,
this.providerConfiguration.port,this.providerConfiguration.serverOptions),new this.driver.Server(this.providerConfiguration.slave.address,this.providerConfiguration.slave.port,this.providerConfiguration.slave.serverOptions||{})]):this.driver.Server(this.providerConfiguration.address,this.providerConfiguration.port,this.providerConfiguration.serverOptions)},initializeStore:function(b){var a=this,b=$data.typeSystem.createCallbackSetting(b);switch(this.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.DropAllExistingTables:(new this.driver.Db(this.providerConfiguration.databaseName,
this._getServer(),{})).open(function(c,e){c&&b.error(c);var g=0,d;for(d in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(d)&&g++;for(d in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(d)&&e.dropCollection(a.context._entitySetReferences[d].tableName,function(){0==--g&&(b.success(a.context),e.close())})});break;default:b.success(this.context)}},executeQuery:function(b,a){var c=this,a=$data.typeSystem.createCallbackSetting(a);this.entitySet=
b.context.getEntitySetFromElementType(b.defaultType);(new $data.storageProviders.mongoDB.mongoDBCompiler).compile(b);(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{})).open(function(e,g){e&&a.error(e);var d=new c.driver.Collection(g,c.entitySet.tableName),f=b.find,h=function(e,d){e&&a.error(e);b.rawDataList=d instanceof Array?d:[{cnt:d}];b.context=c.context;a.success(b);g.close()};switch(b.expression.nodeType){case $data.Expressions.ExpressionType.Count:d.find(f.query,
f.options).count(h);break;default:d.find(f.query,f.options).toArray(h)}})},_saveCollections:function(b,a){var c=this,e=0,g=0,d=function(a){0==--g&&a()},f=function(a,d,f){for(var i=[],k=0;k<d.insertAll.length;k++){for(var g=d.insertAll[k],l=Container.resolveType(g.type).memberDefinitions.getPublicMappedProperties(),j=0;j<l.length;j++){var m=l[j];m.computed||(g.data[m.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(m.type))](g.data[m.name]))}i.push(g.data)}f.insert(i,{safe:!0},
function(g,j){g&&b.error(g);for(var i=0;i<j.length;i++)for(var k=j[i],l=d.insertAll[i],m=Container.resolveType(l.type).memberDefinitions.getPublicMappedProperties(),o=0;o<m.length;o++){var p=m[o];l.entity[p.name]=c.fieldConverter.fromDb[Container.resolveName(Container.resolveType(p.type))](k[p.computed?"_id":p.name])}e+=j.length;d.removeAll&&d.removeAll.length?n(a,d,f):d.updateAll&&d.updateAll.length?h(a,d,f):(b.success(e),a.close())})},h=function(a,f,h){g=f.updateAll.length;for(var i=0;i<f.updateAll.length;i++){for(var k=
f.updateAll[i],o={},l=Container.resolveType(k.type).memberDefinitions.getKeyProperties(),j=0;j<l.length;j++){var m=l[j];o[m.computed?"_id":m.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(m.type))](k.entity[m.name])}l={};m=Container.resolveType(k.type).memberDefinitions.getPublicMappedProperties();for(j=0;j<m.length;j++){var n=m[j];n.computed||(l[n.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(n.type))](k.entity[n.name]))}h.update(o,{$set:l},{safe:!0},
function(c){c&&b.error(c);e++;d(function(){b.success(e);a.close()})})}},n=function(a,f,n){g=f.removeAll.length;for(var i=0;i<f.removeAll.length;i++){for(var k=f.removeAll[i],o=Container.resolveType(k.type).memberDefinitions.getKeyProperties(),l=0;l<o.length;l++){var j=o[l];k.data[j.computed?"_id":j.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(j.type))](k.entity[j.name])}o=Container.resolveType(k.type).memberDefinitions.getPublicMappedProperties();for(l=0;l<o.length;l++)j=
o[l],j.computed||(k.data[j.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(j.type))](k.data[j.name]));n.remove(k.data,{safe:!0},function(c,g){c&&b.error(c);e+=g;d(function(){f.updateAll&&f.updateAll.length?h(a,f,n):(b.success(e),a.close())})})}};(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{})).open(function(e,d){e&&b.error(e);for(var g in a)if(a.hasOwnProperty(g)){var i=a[g],k=new c.driver.Collection(d,g);i.insertAll&&i.insertAll.length?f(d,
i,k):i.removeAll&&i.removeAll.length?n(d,i,k):i.updateAll&&i.updateAll.length?h(d,i,k):(b.success(0),d.close())}})},saveChanges:function(b,a){if(a.length){for(var c=this.buildIndependentBlocks(a),e=[],g={},d=0;d<c.length;d++)for(var f=0;f<c[d].length;f++){e.push(c[d][f].data);var h=g[c[d][f].entitySet.name];h||(h={},g[c[d][f].entitySet.name]=h);var n={entity:c[d][f].data,data:this.save_getInitData(c[d][f],e),type:Container.resolveName(c[d][f].data.getType())};switch(c[d][f].data.entityState){case $data.EntityState.Unchanged:continue;
case $data.EntityState.Added:h.insertAll||(h.insertAll=[]);h.insertAll.push(n);break;case $data.EntityState.Modified:h.updateAll||(h.updateAll=[]);h.updateAll.push(n);break;case $data.EntityState.Deleted:h.removeAll||(h.removeAll=[]);h.removeAll.push(n);break;default:Guard.raise(new Exception("Not supported Entity state"))}}this._saveCollections(b,g)}else b.success(0)},save_getInitData:function(b,a){b.physicalData=this.context._storageModel.getStorageModel(b.data.getType()).PhysicalType.convertTo(b.data,
a);var c={};b.physicalData.getType().memberDefinitions.asArray().forEach(function(a){if(a.kind==$data.MemberTypes.navProperty||a.kind==$data.MemberTypes.complexProperty||a.kind==$data.MemberTypes.property&&!a.notMapped)c[a.computed?"_id":a.name]=b.physicalData[a.name]},this);return c},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.ObjectID],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},
notEqual:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},equalTyped:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},notEqualTyped:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThan:{mapTo:"$gt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThanOrEqual:{mapTo:"$gte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},lessThan:{mapTo:"$lt",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression]},lessThenOrEqual:{mapTo:"$lte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},or:{mapTo:"$or",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},and:{mapTo:"$and",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},"in":{mapTo:"$in",allowedIn:[$data.Expressions.FilterExpression]}}},supportedUnaryOperators:{value:{not:{mapTo:"$nor"}}},supportedFieldOperations:{value:{contains:{dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression],
parameters:[{name:"substring",dataType:"string"}]},startsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]}},enumerable:!0,writable:!0},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},
take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},fieldConverter:{value:{fromDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},"$data.Date":function(b){return b?new Date(b):b},"$data.String":function(b){return b},"$data.Boolean":function(b){return b},"$data.Blob":function(b){return b},"$data.Object":function(b){return void 0===b?new $data.Object:JSON.parse(b)},"$data.Array":function(b){return void 0===b?new $data.Array:JSON.parse(b)},
"$data.ObjectID":function(b){return b?(new Buffer(b.toString(),"ascii")).toString("base64"):b}},toDb:{"$data.Integer":function(b){return b},"$data.Number":function(b){return b},"$data.Date":function(b){return b},"$data.String":function(b){return b},"$data.Boolean":function(b){return"string"===typeof b?"true"===b?!0:!1:!!b},"$data.Blob":function(b){return b},"$data.Object":function(b){return JSON.stringify(b)},"$data.Array":function(b){return JSON.stringify(b)},"$data.ObjectID":function(b){return b&&
"string"===typeof b?new $data.mongoDBDriver.ObjectID.createFromHexString((new Buffer(b,"base64")).toString("ascii")):b}}}}},{isSupported:{get:function(){return!$data.mongoDBDriver?!1:!0},set:function(){}}});$data.storageProviders.mongoDB.mongoDBProvider.isSupported&&$data.StorageProviderBase.registerProvider("mongoDB",$data.storageProviders.mongoDB.mongoDBProvider);
