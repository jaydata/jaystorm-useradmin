<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <title>JayStorm Admin</title>
        
        <link href="styles/bootstrap.min.css" rel="stylesheet" />
        <link href="styles/style.css" rel="stylesheet" />
        <link href="styles/fileuploader.css" rel="stylesheet" />

        <script src="/scripts/jquery-1.7.2.min.js"></script>
        <script src="/scripts/fileuploader.js"></script>
        <script src="scripts/bootstrap.min.js"></script>
        <script src="scripts/datajs-1.0.3-patched.js"></script>
        <script type="text/javascript" src="scripts/q.js"></script>
        <script src="/scripts/jaytracer.js"></script>
        <script src="/scripts/jaydata/jaydata.js"></script>
        
        <script src="scripts/jaydata/jaydataproviders/oDataProvider.js"></script>
        <script src="scripts/knockout-latest.js"></script>
        <script type="text/javascript" src="scripts/jaydata/jaydatamodules/qDeferred.js"></script>
        <script src="scripts/jaygrid-table-template.js"></script>
        <script src="scripts/jaygrid.js"></script>
        <script src="scripts/jay-property-editor.js"></script>
        
        <script src="scripts/jaydata/jaydatamodules/knockout.js"></script>
        <script src="scripts/JayStormClient/service-app-base.js"></script>
        <script src="scripts/JayStormClient/users-groups.js"></script>
        <script src="scripts/JayStormClient/data-manager.js"></script>
        <script src="scripts/JayStormClient/schema-manager.js"></script>
        <script src="scripts/JayStormClient/service-manager.js"></script>
        <script src="scripts/JayStormClient/security-manager.js"></script>
        <script src="scripts/JayStormClient/access-manager.js"></script>
        <script src="scripts/JayStormClient/staticfile-manager.js"></script>
        <script src="scripts/JayStormClient/deployment-manager.js"></script>
        <script src="scripts/application.js"></script>


        <script src="scripts/codemirror/lib/codemirror.js" type="text/javascript"></script>
        <link rel="stylesheet" href="scripts/codemirror/lib/codemirror.css" type="text/css">
        <script src="scripts/codemirror/mode/javascript/javascript.js" type="text/javascript"></script>
        
        <script src="scripts/codemirror/lib/util/simple-hint.js" type="text/javascript"></script>
        <link rel="stylesheet" href="scripts/codemirror/lib/util/simple-hint.css" type="text/css">
        
        <script src="scripts/codemirror/lib/util/javascript-hint.js" type="text/javascript"></script>
        
        <script src="scripts/codemirror/lib/util/searchcursor.js" type="text/javascript"></script>
        <script src="scripts/codemirror/lib/util/match-highlighter.js" type="text/javascript"></script>
        <script src="scripts/codemirror/lib/util/runmode.js" type="text/javascript"></script>
        
        <link rel="stylesheet" href="scripts/codemirror/theme/night.css" type="text/css">
        <link rel="stylesheet" href="scripts/codemirror/theme/ambiance.css" type="text/css">
        
        <script src="scripts/jshint.js" type="text/javascript"></script>
        
        <script src="scripts/codemirror.js"></script>
        <script src="scripts/iscroll.js"></script>
                
        <script src="scripts/inflection.js"></script>
        <script type="text/javascript">
            $("li#servicesScreen div#ServiceManagerUI table.jay-data-grid tbody tr td:first-child a").live('click', function (e) {
                e.preventDefault();
                window.open($(this).attr("href"));
            });

            function is_touch_device() {
                return !!('ontouchstart' in window);
            }

            $("ul.nav > li > a").live('click', function () {
                var $parent = $(this).parent();

                $parent.parent().find("li.active").removeClass("active");
                $parent.addClass("active");
            });

            var hScroll = null, vScrolls = [], currentId;
            function loaded() {

                // ISCROLL
                var screens = document.getElementById('screens'),
                    screenWidth = $(window).innerWidth(),
                    screenHeight = $(window).innerHeight(),
                    screenItems = screens.children.length,
                    scroller = document.getElementById('scroller'),
                    wrapper = document.getElementById('wrapper');

                for (var i = 0; i < screenItems; i++) {
                    currentId = "screen-" + (i + 1);
                    screens.children[i].style.width = screenWidth + 'px';
                    screens.children[i].querySelector("div.inwrapper").setAttribute("id", currentId);

                    if (is_touch_device()) {
                        // VERTICAL SCROLL
                        vScrolls.push(new iScroll(currentId, {
                            checkDOMChanges: true,
                            hScroll: false,
                            hScrollbar: false,
                            vScroll: true,
                            vScrollbar: true,
                            lockDirection: true
                        }));
                    }
                }

                // ISCOLL HORIZONTAL CONTAINER
                wrapper.style.width = screenWidth + 'px';
                scroller.style.width = (screenItems * screenWidth) + 'px';

                // DESTROY PREVIUOS ISCROLL
                if (hScroll != null) {
                    hScroll.refresh();
                    console.dir(hScroll.pagesX);
                } else {
                    // HORIZONTAL SCROLL
                    hScroll = new iScroll('wrapper', {
                        checkDOMChanges: false,
                        //snap: 'li',
                        momentum: false,
                        hScroll: true,
                        hScrollbar: false,
                        vScroll: false,
                        vScrollbar: false,
                        lockDirection: true
                        /*onBeforeScrollEnd: function () {
                            //console.log('horizontal scroll - BeforeScrollEnd');
                        },
                        onScrollEnd: function () {
                            //console.log('horizontal scroll - ScrollEnd');
                        }*/
                    });
                }

                if (!is_touch_device()) {
                    hScroll.disable();
                }
            }

            document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
            document.addEventListener('DOMContentLoaded', loaded, false);

            function OnResize() {
                loaded();
                hScroll.scrollToPage($(".navbar .nav > li.active > a:first").attr("id"), 0);
            }

            var resizeTimer;
            $(window).resize(function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(OnResize, 100);
            });

            function slideclick(e, element) {
                e.preventDefault();
                document.getElementById("welcome").style.display = "none";
                var id = element.getAttribute("id");
                $("ul.nav > li > a[id='" + id + "']").trigger("click");
                hScroll.scrollToPage(id, 200);
            }

            $(".sub-navbar ul.nav li a").live("click", function () {
                var welcome = document.getElementById("welcome"),
                    id = $(this).attr("id");

                welcome.style.display = "none";
                hScroll.scrollToPage(id, 200);
            });

            $(function () {
                // MENU ITEMS
                var menuItems = document.body.querySelectorAll("ul.nav li a"),
                    welcome = document.getElementById("welcome");

                for (var i = 0; i < menuItems.length; i++) {
                    menuItems[i].addEventListener("click", function () {
                        var scrollTo = parseInt(this.getAttribute("id"));
                        welcome.style.display = "none";
                        hScroll.scrollToPage(scrollTo, 200);

                        console.log('click');
                    }, false);
                }
            });
        </script>
    </head>
<body>
    <!-- HEADER -->
    <div id="AppUI">
            <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="brand" href="/">JayStorm Admin</a>

                    <!-- INFO: add class="btn btn-info" to <a> for button style -->
                    <ul class="nav" data-bind="visible: currentApplication, foreach:menuItems">
                        <li><a href="#" data-bind="visible: $root.navigationVisible, click: $root.show, text: title, attr: { id: $index, class: cssclass }"></a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="storm-header">
            <div class="container">
                <div data-bind="if :authorization">
                    <form class="form-inline">
                        <label>Application Selector:</label>
                        <select data-bind="options: applications, 
                                            value: currentApplication, 
                                            optionsText: 'title',
                                            optionsCaption:'Select App To Manage'"></select>

                        <div class="navbar sub-navbar iblock fright">
                            <ul class="nav" data-bind="visible: currentApplication, foreach: submenuItems">
                                <li><a href="#" data-bind="visible: $root.navigationVisible, click: $root.show, text: title, attr: { id: id, class: cssclass }"></a></li>
                            </ul>
                        </div>

<!--                        <label>App Url:</label>
                        <input type="text" data-bind="value: applicationToAdd" /> <input type="button" data-bind="click: addApp" value="Add" class="btn btn-info" />

                        <input type="button" data-bind="click: launchCurrentApplication" value="Press me to get fucked" />-->

                        <div id="launchResult" data-bind="text:launchResult"></div>
                    </form>
                </div>
                <div data-bind="ifnot: authorization">
                    <p style="color: #fff;">Collecting apps and getting authorization. Please wait...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- HEADER -->

    <!-- WELCOME SCREEN -->
    <div id="welcome">
        <div class="container" data-bind="if :authorization">
            <ul id="feature-list-left" class="feature left">
                <li>
                    <div class="icon schema">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);" id="0" href="#">Schemas</a></h2>
                        <p>Manage the schema of your tables, add, edit columns, change field types</p>
                    </div>
                </li>
                <li>
                   <div class="icon service">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);" id="1" href="#">Service manager</a></h2>
                        <p>Publish your databases or JavaScript API via OData</p>
                    </div>
                </li>
                <li>
                    <div class="icon security">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);" id="2" href="#">Security</a></h2>
                        <p>Security manager provides fine-grained access control configuration to your entity sets and services. Assign the available actions for each group</p>
                    </div>
                </li>
                <li>
                    <div class="icon access">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);" id="3" href="#">Access control / Firewall</a></h2>
                        <p>Control the accessiblity of your app by allow IPs, ports, anonymous visitors, customize request origins</p>
                    </div>
                </li>
            </ul>
            <ul id="feature-list-right" class="feature right">
                <li>
                    <div class="icon file">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);"  id="4" href="#">File manager</a></h2>
                        <p>Upload the server-side JavaScript code or static files and we deploy them to all your compute units</p>
                    </div>
                </li>
                <li>
                    <div class="icon user">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);" id="5" href="#">Users</a></h2>
                        <p>Manage your users and security groups of your app</p>
                    </div>
                </li>
                <li>
                    <div class="icon access">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);" id="6" href="#">Publish</a></h2>
                        <p>Here you can implement all modifications within your configuration onto all the dedicated virtual servers of the application environment.</p>
                    </div>
                </li>
                <li>
                    <div class="icon data">&nbsp;</div>
                    <div class="item-content">
                        <h2><a onclick="slideclick(event, this);" id="7" href="#">Data manager</a></h2>
                        <p>Data manager provides front-end to CRUD your all tables in your databases. Editing your ApplicationDb to customize the hebavior of our app. </p>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <!-- WELCOME SCREEN -->

    <!-- ISCROLL CONTAINER -->
    <div id="wrapper" class="container first">
        <div id="scroller">
            
            <div id="output"></div>

            <script type="text/html" id="foobar">
                <table class="table"></table>
            </script>

            <ul id="screens">
                <li id="schemaScreen">
                    <div class="inwrapper container">
                        <div class="inscroller">
                            <div id="SchemaManagerUI" data-bind="if: visible">

                                <script type="text/html" id="insideEditor">
                                    <div>
                                        <h4 style="display:inline">Add or remove fields</h4>
                                        <a href="#" style="float:right" data-bind="click: closeControlBox">Close</a>
                                        <div data-bind="with: selectedEntity">
                                            Table item name: <span data-bind="text: Name"></span>, Full JavaScript class name: <span data-bind="text: FullName"></span>, EntityID: <span data-bind="text: EntityID"></span>
                                        </div>
                                        <div data-bind="jayGrid: {
                                                    source: $root.createContext().EntityFields,
                                                    beforeSave: beforeSaveField,
                                                    showSort: false, showRemoveAllCommand: false, showNewCommandTop: false,
                                                    discriminatorColumn:'EntityID',
                                                    afterAddNew: $root.afterAddNewEntityField,
                                                    typeTemplates: $root.typeTemplates,
                                                    elementTypes: $root.elementTypes,
                                                    defaultValues: { 'DatabaseID' : $root.currentDatabaseID },
                                                    discriminatorValue:$data.data.owner.ElementTypeID(),
                                                    fields:[{name: 'Index','$width':'25px', '$displayName':'#', '$editable':false}, 
                                                            { name: 'Name', 'hint': 'Field name'},
                                                            'TypeTemplate',
                                                            'ElementType','Required', 'Nullable']}">

                                                <div data-name-template="TypeTemplate-editor">
                                                    <div data-bind="text: console.log($root)"></div>
                                                    <select data-bind="options:$root.typeTemplates, optionsText:'Name', optionsValue: 'Name',
                                                            value: value,
                                                            optionsCaption: value() ? undefined : 'Select'"></select>
                                                </div>
                                                <div data-name-template="ElementType-editor">
                                                <div data-bind="if: owner.TypeTemplate() === 'Array'">
                                                <select data-bind="options:$root.elementTypes,
                                                        optionsText:'Name',
                                                        optionsValue: 'TypeName',
                                                        value: value,
                                                        optionsCaption: value() ? undefined :  'Select...'"></select>
                                                    </div>
                                                </div>
                                        </div>
                                        <a href="#" data-bind="click: closeControlBox">Close</a>

                                    </div>
                                </script>
                                
                                <script type="text/html" id="eventHandlerCell">
                                    <a href="#" data-bind="click: $data.showControls.bind({}, 'eventHandlerCodeEditor', EventHandlerCodeEditorModel, { eventHandler: $data })">
                                        Edit code
                                    </a>
                                </script>
                                
                                <script type="text/html" id="eventHandlerCodeEditor">
                                    <span>Event handler source</span>
                                    <a href="#" style="float:right" data-bind="click: closeControlBox">Close</a>
                                    <div data-bind="attr: { id: 'handler-code-editor-' + ko.utils.unwrapObservable($data.data.rowIndex) }"></div>
                                    <div data-bind="if: $data.error().length, attr: { id: 'handler-code-error-' + ko.utils.unwrapObservable($data.data.rowIndex) }">
                                        <ul data-bind="foreach: $data.error">
                                            <li data-bind="if: $data">
                                                <span class="CodeMirror-error-pos" data-bind="text: 'line ' + $data.line + ' col ' + $data.character"></span>
                                                <span class="CodeMirror-error-reason" data-bind="text: $data.reason"></span>
                                                <pre class="CodeMirror-error-code" data-bind="text: $data.evidence"></pre>
                                            </li>
                                        </ul>
                                    </div>
                                    <a href="#" data-bind="click: closeControlBox">Close</a>
                                </script>
                                
                                <script type="text/html" id="eventHandlersEditor">
                                    <div>
                                        <h4 style="display:inline">Add or remove events</h4>
                                        <a href="#" style="float:right" data-bind="click: closeControlBox">Close</a>
                                        <div data-bind="with: selectedEntitySet">
                                            Table item name: <span data-bind="text: Name"></span>, Full JavaScript class name: <span data-bind="text: console.log('fdfjkdshfjkdshkfhdskjhfkdshfhksdhfkjdhksja', $data)"></span>
                                        </div>
                                        <div data-bind="jayGrid: {
                                                    source: $root.createContext().EventHandlers,
                                                    beforeSave: beforeSaveHandler,
                                                    showSort: false, showRemoveAllCommand: false, showNewCommandTop: false,
                                                    defaultValues: { 'DatabaseID' : $root.currentDatabaseID },
                                                    discriminatorColumn: 'EntitySetID',
                                                    discriminatorValue: $data.data.owner.EntitySetID(),
                                                    fields:[{ name: 'Type', 'hint': 'Event type'},
                                                            { name: 'Event handler', isVirtual: true, type:'string', '$width':'200px', '$template':'eventHandlerCell'},]}">
                                                            
                                                <div data-name-template="Type-editor">
                                                <select data-bind="options: $root.eventTypes,
                                                        optionsText: 'name',
                                                        optionsValue: 'type',
                                                        value: value,
                                                        optionsCaption: value() ? undefined :  'Select...'"></select>
                                                </div>
                                        </div>
                                        <a href="#" data-bind="click: closeControlBox">Close</a>

                                    </div>
                                </script>
                                
                                <script type="text/html" id="editFieldsCell">
                                    <div>
<!--                                        <div data-bind="ifnot: owner.EntitySetID()">
                                            Save table to edit fields
                                        </div>-->
                                        <div data-bind="if: owner.EntitySetID()">
                                            <a href="#" data-bind="click: $data.showControls.bind({},'insideEditor',FieldsEditorModel, 
                                                                            { entitySet : $data, factory: $root.contextFactory, currentDB: $root.currentDatabase })">
                                                    Manage fields
                                     
                                            </a>
                                            <a href="#" data-bind="click: $data.showControls.bind({},'eventHandlersEditor', EventHandlersEditorModel, 
                                                                            { entitySet : $data, factory: $root.contextFactory, currentDB: $root.currentDatabase })">
                                                    Manage events
                                     
                                            </a>
                                        </div>
                                        <div data-bind="if: owner.HasChanges()">(unpublished changes)</div>

                                    </div>
                                   
                                </script>

                                <h1>Manage Database Schemas</h1>
                                <div class="alert alert-info fade in">
                                    <button type="button" class="close" data-dismiss="alert">&#120;</button>
                                    <p>Here you can administer the schema of the default Application database you received with your application as well as the schema of the queryable database power-up. You can <b>create database tables </b>and <b>define entities</b>. Select the database you wish to edit then click Create new table, than add/edit/delete table fields.</p>
                                    <p>When adding a new field, you can choose from the following types: text-based, numeric, UTC Date, Image and Geography. You can set the relations between tables at the Reference field.<br /></p>
                                   <p>Manage events: here you can subscribe for entity events and provide your custom code (with JavaScript syntax) you want to run. You can individually set the triggers you want to run before and after CRUD operations.</p>
                                </div>

                               <h4 style="float:left">Select database schema to edit:</h4>
<!--                                <select data-bind="options: databases, optionsCaption: 'Select database',
                                                    optionsText: 'Name',
                                                    value: $root.currentDatabase"></select>-->

                                <ul class="nav nav-tabs" data-bind="foreach:databases">
                                    <li><a href="#" data-bind="text:Name,click: $root.currentDatabase.bind($data)"></a></li>
                                </ul>

                                <div data-bind="if: currentDatabase">
                                    <!-- ko if: currentDatabase().HasChanges -->
                                    <div class="alert alert-danger fright iblock"  style="max-width:600px">
                                        <button type="button" class="close" data-dismiss="alert">&#120;</button>
                                        <p><strong>Attention!</strong> This database schema has changed. You need to publish these changes before they take effect.</p>
                                    </div>
                                    <!-- /ko -->

                                    <h2>Database schema: <span data-bind="text: currentDatabase().Name"> </span></h2>
                                    <div data-bind="if: IsApplicationDB">
                                        <div class="alert alert-danger fright iblock" style="float: none;">
                                            <button type="button" class="close" data-dismiss="alert">&#120;</button>
                                            <p><strong>Attention!</strong> The ApplicationDB contains all the meta information about your JayStorm JavaScript application and in trained hands is a powerful tool to create ultra dynamic and flexible data applications. Used on the wrong way however can easily render your system unoperational!</p>
                                        </div>
                                    </div>
                                    <h3>List of tables</h3>

                                    <!-- ko if:tableItemsPresent() && (tableItems().length == 0) -->
                                    <div class="alert alert-warning"  >
                                        <button type="button" class="close" data-dismiss="alert">&#120;</button>
                                        <p><strong>Attention!</strong> This database does not have any tables yet. Create a new table to add fields and server event handlers</p>
                                    </div>
                                    <!-- /ko -->


                                    <div data-bind="jayGrid: {
                                                newCommandCaption: 'Create new table',
                                                items: tableItems,
                                                showRemoveAllCommand: false,
                                                itemsReceived: tableListReceived,
                                                source: context().EntitySets,
                                                fields: [{name: 'Name', '$width':'200px', 'hint':'Tablename', '$displayName': 'Table name'}, 
                                                         { name: 'Table fields', isVirtual: true, type:'string', '$width':'200px', '$template':'editFieldsCell'}, 
                                                        'Published'],
                                                discriminatorColumn: 'DatabaseID',
                                                beforeSave: beforeDatabaseSave,
                                                discriminatorValue: currentDatabaseID,
                                                pageSize: eSetsPageSize},
                                                visible: currentDatabase">

                                        <script type="text/html" data-name-template="Name-display">
                                            <h5 data-bind="text: value"></h5>
                                        </script>
                                    </div>
                                        
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li id="servicesScreen">
                    <div class="inwrapper container">
                        <div class="inscroller">
                            <div id="ServiceManagerUI" data-bind="if: visible">
                            <h1>Manage Services</h1>
                            <div class="alert alert-info fade in">
                                <button type="button" class="close" data-dismiss="alert">&#120;</button>
                                <p>You can manage your application services here, that is the data endpoint of your app. <br />
                                 You can crearte two types of services:
                                    <ul><li>
                                        JavaScript API service - you can add the services of your choices to the oData endpoint, using your JavaScript code
                                        </li>
                                        <li>
                                        JavaScript Data service - you can publish the selected database and you have the option to add further services to the oData endpoint
                                        </li>
                                    </ul>
                                    </p>
                            </div>

                <div id="svcGrid" data-bind="jayGrid: { source: context().Services,
                                                        context: context,
                                                        fields: [
                                                            {name:'Name', $width:'300px'},
                                                            {name: 'ServiceType', $width:'200px'},
                                                            {name: 'DatabaseID', $displayName: 'Backing database', $width:'300px'},
                                                            'ServiceSource'
                                                        ],
                                                        defaultValues: { 'ServiceSourceType': 'script'},
                                                        beforeSave: function(){ $root.editingSource(false); },
                                                        allDatabases: allDatabases,
                                                        databaseSet: context().Databases}">

                    <!--, dbs: databases, databases: context().Databases-->
                    <!--currentApplication-->
                    <script type="text/html" data-name-template="Name-display">
                        <b><div data-bind="{text: value}"></div></b>
                        
                        <a data-bind="{text: $root.application.currentApplication().url + '/' + value(), attr: {target: '_blank', href: $root.application.currentApplication().url + value()}}"></a>
                    </script>
                    <script type="text/html" data-name-template="ServiceType-editor">
                        <select data-bind="options: ['JavaScript Data Service','JavaScript API Service'], value: value"></select>
                    </script>

                    <script type="text/html" data-name-template="ServiceType-display">
                        <div data-bind="text: value() ? value() : 'JavaScript Data Service'" />
                    </script>

                    <script type="text/html" data-name-template="DatabaseID-editor">
                        <div data-bind='if: owner.ServiceType() !== "JavaScript API Service"'>
                            <a href='#' class='btn' data-bind='click: function(){ value(null); }'>Clear</a>
                            <select data-bind="options: $root.allDatabases,
                                        optionsValue: 'DatabaseID', optionsText: 'Name', value: $parent[name],
                                        optionsCaption: 'Select...',
                                        optionsCaptionValue: null"></select>
                        </div>
                    </script>

                    <script type="text/html" data-name-template="DatabaseID-display">
                        <span data-bind="readValue: { source: $root.databaseSet, key: $parent[name], field: 'Name' }"></span>
                    </script>

                    <script type="text/html" data-name-template="Sets-editor">
                        <a href="#" data-bind="click: $root.selectService.bind({}, $parent)">#</a>
                    </script>
                
                    <script type="text/html" data-name-template="ServiceSourceType-editor">
                        <select data-bind="options: $root.serviceSourceTypes,
                                    optionsValue: 'type', optionsText: 'name', value: value,
                                    optionsCaption: 'Select...' "></select>
                    </script>
                
                    <script type="text/html" data-name-template="ServiceSourceType-display">
                        <span data-bind="text: ($root.serviceSourceTypes().filter(function(it){ return it.type == value() })[0] || { name: '-' }).name"></span>
                    </script>
                
                    <script type="text/html" data-name-template="ServiceSource-editor">
<!--                        <a href='#' class='btn' data-bind='visible: !!$data.ServiceID, click: function(){ $root.editSource(owner, value, $root.error); }, visible: owner.ServiceSourceType() == "script"'>Edit Source</a>-->
                    </script>
                
                    <script type="text/html" data-name-template="ServiceSource-display">
<!--                        <pre data-bind="visible: owner.ServiceSourceType() == 'script' && value(), attr: { id: 'Service-' + ko.utils.unwrapObservable(rowIndex), codemirror: (function(){ if (value()) $root.codeHighlight('Service-' + ko.utils.unwrapObservable(rowIndex), value); })() }"></pre>-->
                        <a href='#' class='btn' data-bind='visible: !$data.ServiceID, click: function(){ $root.editSource(owner, value, $root.error); }, visible: owner.ServiceSourceType() == "script"'>Edit Source</a>
                    </script>
                </div>
            
                <div data-bind="if: editingSource">
                    <h2>Edit source</h2>

                    <div id="service-codemirror">
                    </div>
                    <div id="Div1" data-bind="if: error().length">
                        <ul data-bind="foreach: error">
                            <li data-bind="if: $data">
                                <span class="CodeMirror-error-pos" data-bind="text: 'line ' + $data.line + ' col ' + $data.character"></span>
                                <span class="CodeMirror-error-reason" data-bind="text: $data.reason"></span>
                                <pre class="CodeMirror-error-code" data-bind="text: $data.evidence"></pre>
                            </li>
                        </ul>
                    </div>
                </div>

                <div data-bind="if: selectedService">
                    <div id="entitySets" data-bind="jayGrid: {
                                                            source: context().EntitySetPublications,
                                                            context: context,
                                                            fields: 'EntitySetID'
                                                            discriminatorColumn: 'ServiceID',
                                                            discriminatorValue: selectedService().ServiceID,
                                                            allDatabases: allDatabases,
                                                            databaseSet: context().Databases}">

                        <script type="text/html" data-name-template="Publish-display">
                            <span data-bind="text: $root.checkBoxStates().length"></span>
                            <input type="checkbox"
                                   data-bind="click: $root.check,
                                              checked: $root.checkBoxStates().length < 1" />
                        </script>

                        <!--, dbs: databases, databases: context().Databases-->
                        <script type="text/html" data-name-template="DatabaseID-editor">
                            <select data-bind="options: $root.allDatabases,
                                        optionsValue: 'DatabaseID', optionsText: 'Name', value: $parent[name],
                                        optionsCaption: 'Select...' "></select>
                        </script>

                        <script type="text/html" data-name-template="DatabaseID-display">
                            <span data-bind="text: $parent[name]" />:
                            <span data-bind="readValue: { source: $root.databaseSet, key: $parent[name], field: 'Name' }"></span>
                        </script>
                    </div>
                </div>
            </div>
                        </div>
                    </div>
                </li>
                <li class="securityScreen">
                    <div class="inwrapper container">
                        <div class="inscroller">
                            <div id="SecurityManagerUI" data-bind="if: visible && context">
                <h1>Manage Security</h1>
               <div class="alert alert-info fade in">
                    <button type="button" class="close" data-dismiss="alert">&#120;</button>
                    <p>You can assign permissions to security groups for each database table. <br /> You can manage permissions for the following actions: Read, Delete, Update, Create, Delete in a batch, Manage. Manage permissions actions provide security empowering.</p>
                </div>
            
                <h4>Add new permission</h4>
                <form class="form-inline" data-bind="submit: addPermission">
                    <select class="input-medium" data-bind="options: databases, optionsText:'Name', value: selectedDatabase, optionsCaption:'All databases'"></select>
                    <select class="input-medium" data-bind="options: tables, optionsText:'Name',  value: selectedTable, optionsCaption:'All tables'"></select>
                    <select class="input-medium" data-bind="options: groups, optionsText:'Name',  value: selectedGroup, optionsCaption:'All groups'"></select>

                    <span class="iblock actions" data-bind="foreach: tablePermissions">
                        <label data-bind="text: name, attr: { for: name }"></label><input type="checkbox" data-bind="checked: value, attr: { id: name }" />
                    </span>

                    <input class="btn btn-info" type="submit" value="Add permission" />
                </form>

                <h4>List of active permissions</h4>

                <div data-bind="jayGrid: {source: context().Permissions,
                                                showNewCommandBottom: false,
                                                showNewCommandTop: false,
                                               fields: ['DatabaseID', 'EntitySetID','GroupID','Read','Create','Update','Delete','DeleteBatch'],
                                              refresher: $root.rf }">

                    <script type="text/html" data-name-template="DatabaseID-display">
                        <span data-bind="readValue: { source: $root.context().Databases, key: value, field: 'Name' }"></span>
                    </script>
                    <script type="text/html" data-name-template="EntitySetID-display">
                        <span data-bind="readValue: { source: $root.context().EntitySets, key: value, field: 'Name' }"></span>
                    </script>
                    <script type="text/html" data-name-template="GroupID-display">
                        <span data-bind="readValue: { source: $root.context().Groups, key: value, field: 'Name' }"></span>
                    </script>
                    <script type="text/html" data-name-template="DatabaseID-editor">
                        <span data-bind="readValue: { source: $root.context().Databases, key: value, field: 'Name' }"></span>
                    </script>
                    <script type="text/html" data-name-template="EntitySetID-editor">
                        <span data-bind="readValue: { source: $root.context().EntitySets, key: value, field: 'Name' }"></span>
                    </script>
                    <script type="text/html" data-name-template="GroupID-editor">
                        <span data-bind="readValue: { source: $root.context().Groups, key: value, field: 'Name' }"></span>
                    </script>
                </div>
            </div>
                        </div>
                    </div>
                </li>
                <li class="accessScreen">
                    <div class="inwrapper container">
                        <div class="inscroller">
            <div id="AccessManagerUI" data-bind="if: visible && context">
                <h1>Access control</h1>
                
                <div class="alert alert-danger" style="float: none;" data-bind="visible: isfreeapp">
                    <p><strong>Attention!</strong> This is a JayStorm Open application. Your access settings will not be deployed and have no effects.</p>
                    <p>To use these settings create a JayStorm Business application on <a href="https://dashboard.jaystack.com" target="_blank">https://dashboard.jaystack.com</a>.</p>
                </div>
                
                <div class="alert alert-info fade in">
                    <button type="button" class="close" data-dismiss="alert">&#120;</button>
                    <p>Ingress securitiy - you can define here your application access rule. You can define custom request headers to avoid cross-origin issues. Publish or unpublish your service endpoints and control rules (whether or not it is published as well as access control).</p>
                </div>

                <h4>Control who can access your system</h4>
                <h4>Application Rules</h4>
                <div data-bind="jayGrid: { fields: [ { name: 'Index', '$width':'40px' },
                                                     { name: 'RuleType', '$options':['Allow','Deny'] },
                                                     'SourceAddress','Port', 'PortEnd'], 
                                                     defaultValues: { Index : function() { return this.items().length; } },
                                                     filter: 'it.ObjectID == null',
                                                     beforeSave: beforeSave,
                                                     source: context().IngressIPRules }">

                </div>
                <div data-bind="jayGrid: { fields: ['SourceOrigin'],filter: 'it.ObjectID == null',
                                        beforeSave: beforeSave,
                                        source: context().IngressOriginRules }">
                </div>
                <h4>Default service rules</h4> 
                <div id="svcAccessGrid" data-bind="jayGrid: { showNewCommand: false, showRemoveAllCommand: false,
                                fields: ['Name','Published', 'AllowAnonymous','AllowAllIPs','AllowAllOrigins','UseDefaultPort','UseSSL'],
                                showNewCommandBottom: false,
                                showNewCommandTop: false,
                                deleteCommand: false,
                                beforeSave: beforeSave,
                                source: context().Services }">

                </div>

                <h4>Addition service rules</h4>
                <div id="ingressIP" data-bind="jayGrid: { fields: ['Name', 'ObjectID','Port','SSL'], 
                                                source: context().IngressIPRules, filter: 'it.ObjectID != null',
                                                beforeSave: beforeSave,
                                                defaultValues: { 'SourceAddress': '*'}, }">

                    <script type="text/html" data-name-template="ObjectID-editor">
                        <select data-bind="options: $root.context().Services.toKoArray(), value: value, 
                                            optionsText:'Name', optionsValue:'ServiceID' "></select>
                    </script>
                    <script type="text/html" data-name-template="ObjectID-display">
                        <span data-bind="readValue: { source: $root.context().Services, key: value, field: 'Name' }"></span>
                    </script>

                    <script type="text/html" data-name-template="Port-editor">
                        <input type='number' \
                            data-bind='value: Model.Value, attr: { required: metadata.required }, css: { verror: owner.ValidationErrors }' />
                        <br />
                        <div class="validation-msg" data-bind="visible: Model.Value() < 1024">
                            <p class="first">Invalid rule</p>
                            <p class="second">Please specify ports above 1024!</p>
                        </div>
                    </script>
                    <script type="text/html" data-name-template="Port-display">
                        <span data-bind='text: value'></span>
                        <br />
                        <div class="validation-msg" data-bind="visible: Model.Value() < 1024">
                            <p class="first">Invalid rule</p>
                            <p class="second">Please specify ports above 1024!</p>
                        </div>
                    </script>
                </div>
                <div id="ingressOrigin" data-bind="jayGrid: { fields: ['Name', 'ObjectID', 'SourceOrigin'], 
                                                beforeSave: beforeSave,
                                                source: context().IngressOriginRules, filter: 'it.ObjectID != null' }">


                    <script type="text/html" data-name-template="ObjectID-editor">
                        <select data-bind="options: $root.context().Services.toKoArray(), value: value, 
                                            optionsText:'Name', optionsValue:'ServiceID' "></select>
                    </script>
                    <script type="text/html" data-name-template="ObjectID-display">
                        <span data-bind="readValue: { source: $root.context().Services, key: value, field: 'Name' }"></span>
                    </script>
                </div>
            </div>
                        </div>
                    </div>
                </li>
                <li class="filesScreen">
                    <div class="inwrapper container">
                        <div class="inscroller">
                            <div id="StaticFileUI" data-bind="if: visible">
                               <h1>Manage static files</h1>
                               
                               <div class="alert alert-danger" style="float: none;" data-bind="if: isfreeapp">
                                    <p><strong>Attention!</strong> This is a JayStorm Open application. Your file upload will fail.</p>
                                    <p>To use static files create a JayStorm Business application on <a href="https://dashboard.jaystack.com" target="_blank">https://dashboard.jaystack.com</a>.</p>
                                </div>
                                
                               <div class="alert alert-info fade in">
                                    <button type="button" class="close" data-dismiss="alert">&#120;</button>
                                    <p>Here you can upload all static files and JavaScript resources to the file repository. You can find this useful when developing your hybrid mobile application or web application as well. <br />
                                    <b>Use drag and drop!</b> Drag the zip to the window to start download. We will deploy all files within your zip onto your dedicated virtual server. Upload all resources in one instance! You can empty your repository by clicking the Clear all button.</p>
                                </div>

                                <div  class="part">
                                    <h4 class="subtitle">Static file upload (zip) </h4>
                                    <form id="deletefile1" action="removeFile" action="post" >
                                        <input type="hidden" value="1"/>
                                        <input type="button" data-bind="click:removeStaticFiles" value="Clear all files" class="btn btn-danger"/>
                                    </form>
                                    <form id="fileUpload1" action="fileUpload" action="post">
                                        <div id="file-uploader1">
                                            <noscript>
                                                <p>Please enable JavaScript to use file uploader.</p>
                                                <!-- or put a simple form for upload here -->
                                            </noscript>
                                        </div>
                                        <div class="qq-upload-extra-drop-area1 btn btn-danger">Drop files here too</div>
                                    </form>
                                </div>
                                <!--<div  class="part">
                                    <h4 class="subtitle">Javascript upload (zip) </h4>
                                    <form id="deletefile2" action="removeFile" action="post">
                                        <input type="hidden" value="2"/>
                                        <input type="button" data-bind="click:removeJsFiles" value="Clear all files" class="btn btn-danger"/>
                                    </form>
                                    <form id="fileUpload2" action="fileUpload" action="post">

                                        <div id="file-uploader2">
                                            <noscript>
                                                <p>Please enable JavaScript to use file uploader.</p>-->
                                                <!-- or put a simple form for upload here -->
                              <!--              </noscript>
                                        </div>
                                        <div class="qq-upload-extra-drop-area2 btn btn-info">Drop files here too</div>
                                    </form>
                                </div>-->
                            </div>
                        </div>
                    </div>
                </li>
                <li id="usersScreen">
                 <!--   <div class="todo-list">
                        <h3>Todo list</h3>
                        <dl>
                            <dd>todo item 1</dd>
                            <dd>todo item 2</dd>
                            <dd>todo item 3</dd>
                        </dl>
                    </div>-->

                    <div class="inwrapper container">
                        <div class="inscroller">
                            
                            <div id="UserManagerUI" data-bind="if: visible">
                                <script type="text/html" id="GroupArrayEditor">
                                <div>
                                    <ul class="resetlist" data-bind="foreach: Groups">
                                        <li>
                                            <input type="checkbox" data-bind="checked: selected, attr: { id: Name }"/>
                                            <label data-bind="text: Name, attr: { for: Name }"></label>
                                        </li>
                                    </ul>
                                    <a href="#" data-bind="click: closeControlBox">close</a>
                                </div>
                            </script>

                                <script type="text/html" id="setPasswordUI">
                                <form data-bind="submit: savePassword">
                                    <div class="fields">
                                        <label>
                                            Password:
                                            <br />
                                            <input type="password" required data-bind="value: password"/>
                                        </label>
                                        <br />
                                        <label>
                                            Retype:
                                            <br />
                                            <input type="password" required data-bind="value: rePassword"/>
                                        </label>
                                        <br />
                                        <span class="alert-danger" data-bind="text: validation"></span>
                                    </div>
                                    <input class="btn btn-info" type="submit" />
                                </form>
                                <a href="#" data-bind="click: close">close</a>
                            </script>

                <!--<div class="alert alert-danger fright iblock">
                    <button type="button" class="close" data-dismiss="alert">&#120;</button>
                    <p><strong>Attention!</strong> Refresh the page to see the changes!</p>
                </div>-->
                <h1>Manage Users</h1>
                <div class="alert alert-info fade in">
                    <button type="button" class="close" data-dismiss="alert">&#120;</button>
                    <p>Here you can create users or user groups for your application as well as assign users to groups, reset user passwords and disable users.</p>
                </div>

                <div data-bind="if: Users">
                    <h4>Manage users</h4>

                    <div data-bind="jayGrid: { source: Users, itemExtender: extendUserItem,
                                                fields: ['Login', 'FirstName','LastName','Password','Enabled','Groups'] }">

                        <script type="text/html" data-name-template="Password-display">
                            ******
                        </script>
                        <script type="text/html" data-name-template="Password-editor">
                            <a href="#" data-bind="click: $data.showControls.bind({}, 'setPasswordUI', SetPasswordModel, { user: owner, app: $data, root: $root })">Reset password</a>
                        </script>

                        <script type="text/html" data-name-template="Groups-editor">
                            <div data-bind="foreach: value">
                                <span data-bind="readValue: { source: $root.context().Groups, key: $data, field: 'Name' }"></span>
                            </div>
                            <a href="#" 
                                data-bind="click: $data.showControls.bind({},'GroupArrayEditor', 
                                GroupEditor, { meta: $data, entity: owner, value: value, context: $root.context })">Click me!</a>
                        </script>

                        <script type="text/html" data-name-template="Groups-display">
                            <div data-bind="foreach: value">
                                <span data-bind="readValue: { source: $root.context().Groups, key: $data, field: 'Name' }"></span>
                            </div>
                        </script>
                    </div>

                </div>
                <div data-bind="if: Groups">
                    <h4>Manage groups</h4>
                    <div data-bind="jayGrid: {  source: Groups, items: allGroups }"></div>
                </div>
            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="inwrapper container">
                        <div class="inscroller">
                            <div id="DeploymentUI" data-bind="if: visible">
                                <h1>Application Publish</h1>
                                <div class="alert alert-info fade in">
                                    <button type="button" class="close" data-dismiss="alert">x</button>
                                    <p>Here you can implement all modifications within your configuration onto all the dedicated virtual servers of the application environment.</p>
                                </div>
                                <div data-bind="if: hasChanges" style="margin-bottom: 20px">
                                    <h3>Changed ApplicationDB items</h3>
                                    <div data-bind="foreach: changedObjects">
                                        <div data-bind="if: Items().length > 0">
                                            <h4 data-bind="text: CollectionName"></h4>
                                            <ul data-bind="foreach: Items">
                                                <!-- ko if: _wrappedType.memberDefinitions.getMember('Name') -->
                                                <li><span data-bind="text: Name"></span></li>
                                                <!-- /ko -->
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div data-bind="if: appContext">
                                    <input type="button" data-bind="click: launch, attr: { disabled: launchDisabled }" value="Deploy changes and restart services" class="btn btn-info btn-deploy">

                                    <h3 data-bind="if: launchInit">Collecting changed data, please wait...</h3>
                                    <h3 data-bind="if: launching">Publish in progress, please wait...</h3>
                                    <h3 data-bind="if: launchingDone">Publish done!</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li id="dataScreen">
                    <div class="inwrapper">
                        <div class="inscroller">
                            <div id="DataManagerUI" data-bind="if: visible">
                                <div class="alert alert-info fade in">
                                    <button type="button" class="close" data-dismiss="alert">&#120;</button>
                                    <p>Data manager has been opened in a separate window!</p>
                                </div>


                            </div>

                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <!-- ISCROLL CONTAINER -->
</body>
</html>
