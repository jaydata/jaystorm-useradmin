<html>
    <head>
        <script src="/scripts/jquery-1.7.2.min.js"></script>
        <script src="scripts/datajs-1.0.3.js"></script>
        <script src="/scripts/jaydata/jaydata.js"></script>
        <script src="scripts/jaydata/jaydataproviders/oDataProvider.js"></script>
        <script src="/scripts/JaySvcUtil.js"></script>
        <script src="scripts/knockout-2.1.0.debug.js"></script>
            <script src="scripts/jaygrid.js"></script>
        <script src="scripts/jaydata/jaydatamodules/knockout.js"></script>
        <script src="scripts/application.js"></script>
        <script type="text/javascript">

            $(function() {

                function loadUserManagerUI(context) {
                    var newGroupModel = new ViewModels.NewGroup(context);
                    ko.applyBindings(newGroupModel,document.getElementById('addGroupUI') )

                    var manageGroupsModel = new ManageGroupsModel(context, newGroupModel);
                    ko.applyBindings(manageGroupsModel, document.getElementById("manageGroupsUI"));

                    var spModel = new SetPasswordModel(context);
                    ko.applyBindings(spModel, document.getElementById("changePasswordUI"));

                    var entityEditor = new ViewModels.EntityEditor(context);
                    ko.applyBindings(entityEditor, document.getElementById("editObjectUI"));

                    var manageUsersModel = new ManageUsersModel(context, spModel, manageGroupsModel, entityEditor);
                    ko.applyBindings(manageUsersModel, document.getElementById("adminUI"));

                };

                $data.MetadataLoader.xsltRepoUrl = '/scripts/';
                $data.MetadataLoader.load('/db/$metadata', function () {
                    var context = JayStormApplication.context;

                    context.top2Users = context.Users.take(2);
                    ko.applyBindings(context, document.getElementById("JayGridTests"));


                    loadUserManagerUI(context);
                });

            })
        </script>
    </head>
<body>
    <div id="output">
    </div>

    <script type="text/html" id="foobar">
        <table>

        </table>
    </script>



    <div id="JayGridTests">
        <div data-bind="jayGrid: Users">

        </div>
        <div data-bind="jayGrid: {source: Users, fields:['Id','login']}">

        </div>
        <div data-bind="jayGrid: {source: Users, fields:['Id','login']}, gridTemplate:'myGrid'">

        </div>

        <div data-bind="jayGrid: {source: top2Users, fields:['Id','login']}, gridTemplate:'myGrid'">

        </div>

    </div>

    <script type="text/html" id="myGrid">
        <table class='jay-data-grid' border='12'>
            <thead class='jay-data-grid-columns'>
                <tr class='jay-data-grid-columns-row' data-bind="foreach: columns">
                    <td data-bind='text: name'></td>
                </tr>
            </thead>
            <tbody data-bind="foreach: items">
                <tr  data-bind='foreach: $parent.columns'>
                    <td data-bind='text: $parent[name]'></td>
                </tr>
            </tbody>
        </table>
    </script>



    <div id="UserGroupAdminUI">
    <div id="manageGroupsUI">
        <table border="1">
            <thead>
            <tr data-bind="with: newGroupModel">
                <th>Name</th>
                <th><a href="#" data-bind="click: show">add group</a></th>
            </tr>
            </thead>
            <tbody data-bind="foreach: groups">
            <tr>
                <td data-bind="text: name"></td>
                <td> <a href="#" data-bind="click: $root.removeGroup">remove</a></td>
            </tr>
            </tbody>
        </table>
    </div>


    <div id="addGroupUI" data-bind="visible: visible"  style="border:1px solid #2dff4c">
        <title>Add group</title>
        <form data-bind="submit: createGroup">
            Name: <input data-bind="value: name" /><br />
            <input type="submit" value="Create Group"/>
            <input type="checkbox" data-bind="checked: closeOnCreate" /> Close when created
        </form>
    </div>

        <!--<script type="text/html" id="Edm.String">-->
            <!--<div data-bind="text: $data.m"  />-->
        <!--</script>-->



        <script type="text/html" id="Edm.String-editor">
            <input data-bind="value: value" />
        </script>

        <script type="text/html" id="Edm.Boolean-editor">
            <input type="checkbox" data-bind="checked: value" />
        </script>

        <script type="text/html" id="Edm.DateTime-editor">
            <input type="datetime" data-bind="value: value" />
        </script>

        <script type="text/html" id="debug">Debug: !<div data-bind="text: $data"></div>!</script>




        <div id="editObjectUI" data-bind="visible: visible">
            <form data-bind="submit: save">
                <fieldset data-bind="with: $root.object">
                    <div data-bind="foreach: getProperties()">
                        <div class="input-unit">
                            <div data-bind="text: name"></div>
                            <div data-bind="template: { name: type + '-editor' }"></div>
                        </div>
                    </div>
                    <input type="submit" value="Save"/>
                    <input type="button" value="Cancel" data-bind="click: $parent.cancelSave"/>
                </fieldset>
            </form>
        </div>

        <div id="adminUI">
        <div>
            <span>Users: <span data-bind="text: userCount"></span></span>
        </div>
        <table>
            <thead>
            <tr>
                <th>Login name</th>
                <th>Firstname</th>
                <th>Lastname</th>
                <th>Enabled</th>
                <th><a href="#" data-bind="click: $root.newUser">Add user</a></th>
            </tr>
            </thead>
            <tbody data-bind="foreach: userList">
            <tr>
                <td data-bind="text: login"></td>
                <td data-bind="text: $data['firstName']"></td>
                <td data-bind="text: lastName"></td>
                <td data-bind="text: enabled"></td>
                <td><a href="#" data-bind="text: 'Remove', click: $root.removeUser"></a>,
                    <a href="#" data-bind="text: 'SetPassword', click: $root.changePassword"></a>
                    <a href="#" data-bind="text: 'Edit', click: $root.editUser"></a>
                </td>
            </tr>
            </tbody>
        </table>

    </div>


    <div data-bind="visible: $root.user" id="changePasswordUI">
        <form data-bind="submit: changePassword">
            <div data-bind="with: $root.user">
                <span data-bind="text: login"></span> (Id: <span data-bind="text: Id"></span>)
            </div>
            <input type="password" data-bind="value: password" />
            <input type="password" data-bind="value: password2" />
            <input type="submit" value="Set Password"/>
            <div data-bind="text: progressText"></div>
        </form>
    </div>
    </div>

    <div id="DatabasesAdminUI">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th></th>
                </tr>
            </thead>
            <tbody data-bind="foreach:databases">
                <tr>
                    <td data-bind="text: name" />
                    <td><a href="#" data-bind="click: manage"></a></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="StringEditor">
        <input data-bind="$data" />
    </div>

    <div id="AddDatabase">

    </div>

</body>
</html>