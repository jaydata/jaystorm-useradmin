<html>
    <head>
        <script src="/scripts/jquery-1.7.2.min.js"></script>
        <script src="scripts/datajs-1.0.3.js"></script>
        <script src="/scripts/jaydata/jaydata.js"></script>
        <script src="scripts/jaydata/jaydataproviders/oDataProvider.js"></script>
        <script src="/scripts/JaySvcUtil.js"></script>
        <script src="scripts/knockout-2.1.0.debug.js"></script>
        <script src="scripts/jaygrid-table-template.js"></script>
        <script src="scripts/jaygrid.js"></script>
        <script src="scripts/jay-property-editor.js"></script>
        <script src="scripts/jaydata/jaydatamodules/knockout.js"></script>
        <script src="scripts/application.js"></script>
        <script type="text/javascript">

            $(function() {

                $data.MetadataLoader.load('/db', function (factory) {

                    var context = factory();


                   function userManagerModel(context) {
                        var self = this;

                        self.visible = ko.observable(false);


                        self.Users = context.Users;

                        self.Groups = context.Groups;

                        self.groups = ko.observableArray([]);

                        self.selectedObject = ko.observable();

                        self.selectObjectCommand = function(o) {
                            self.selectedObject(o);
                            self.propEditorVisible(true);
                        };

                        self.editObject = function(o) {
                            self.selectedObject(o);
                            self.propEditorVisible(true);
                        };
                        self.editObject.displayName = 'Edit';

                        this.propEditorVisible = ko.observable(false);

                        self.editObjectCommand = {
                            execute: function(o) {
                                self.selectedObject(o);
                                self.propEditorVisible(true);
                            },
                            displayName : 'Edit'
                        };

                        self.removeObjectCommand = {
                            execute: function(o) {
                                self.selectedObject(o);
                                self.propEditorVisible(true);
                            },
                            displayName : 'Remove'
                        };

                        self.saveObjectCommand = ko.observable({
                            method: function() { }
                        });

                        self.addNew = function(entitySet, model, event) {
                                var o = new entitySet.createNew().asKoObservable();
                                self.selectedObject(o);
                                self.propEditorVisible(true);
                                console.log(arguments);
                                self.saveObjectCommand({
                                            method: function() {
                                                entitySet.add(o);
                                                entitySet.entityContext.saveChanges( function() {
                                                   self.propEditorVisible(false);
                                                });
                                            }
                                        });
                        }

                        self.removeObject = function(o) {

                        }


                    }

                   function databaseManagerModel(context) {

                       var self = this;

                       self.context = context;

                       self.entitySets = function() {
                           var result = [];
                           for(var name in context) {
                            if (context[name] instanceof $data.EntitySet) {
                                result.push(context[name]);
                            }
                           }
                           return result;
                       };

                       self.selectSet = function(eSet) {
                           //self.order('');
                           self.EntitySets(eSet);
                       }

                       self.Databases = context.Databases;
                       self.selectedDatabase = ko.observable();

                       self.selectedDatabaseName = ko.computed( function() {
                           return this.selectedDatabase() ? this.selectedDatabase().Name() : '';
                       }, this);

                       self.esPageSize = ko.observable(30);


                       self.EntitySets = ko.observable();

                       self.Tables = ko.observableArray([]);
                       self.visible = ko.observable(false);
                       self.databaseEditorVisible = ko.observable(false);

                       self.saveObjectCommand = ko.observable({
                           method: function() { }
                       });



                       self.addNew = function(entitySet, model, event) {
                           var o = new entitySet.createNew();
                           if ("DatabaseName" in o) {
                               o.DatabaseName = self.selectedDatabaseName();
                           };

                           var o = o.asKoObservable();

                           self.selectedDatabase(o);
                           self.databaseEditorVisible(true);
                           console.log(arguments);
                           self.saveObjectCommand({
                               method: function() {
                                   entitySet.add(o);
                                   entitySet.entityContext.saveChanges( function() {
                                       self.databaseEditorVisible(false);
                                   });
                               }
                           });
                       };

                       self.selectDatabaseCommand = {
                           execute: function(o) {
                               self.selectedDatabase(o);
                           },
                           displayName: 'Select'

                       }



                   }

                    var userManagerModel = new userManagerModel(context);
                    var databaseManagerModel = new databaseManagerModel(context);

                    //ko.applyBindings(userManagerModel, document.getElementById("UserManagerUI"));
                    ko.applyBindings(databaseManagerModel, document.getElementById("DatabaseManagerUI"));

                    function MenuModel(items) {
                        var self = this;
                        self.items = items;

                        self.show = function(item) {
                            self.items.forEach( function(item) {
                                item.Model.visible(false);
                            });
                            item.Model.visible(true);
                        }
                    }

                    var items = [];
                    var sections = //[{ Title: 'Users and Groups', Model: userManagerModel },
                            [{ Title: 'Databases', Model: databaseManagerModel }];
                    ko.applyBindings(new MenuModel(sections), document.getElementById("MenuUI"));
                    //loadUserManagerUI(context);
                });

            })
        </script>
    </head>
<body>
    <div id="output">
    </div>

    <script type="text/html" id="foobar">
        <table>

        </table>
    </script>


    <ul id="MenuUI" data-bind="foreach:items">
        <li>
            <a href="#" data-bind="click: $root.show, text: Title"></a>
        </li>
    </ul>

    <div id="UserManagerUI" data-bind="visible: visible">


        <!--<div data-bind='jayGrid: Users' id='myUsers'>-->
            <!--loading...-->
        <!--</div>-->

        <div id="x345" data-bind="jayGrid: {source: Users, pageSize: 10,
                                            itemCommands: [ editObjectCommand, removeObjectCommand ]}">

        </div>
        <a href="#" data-bind="event: {click: addNew.bind($data, Users) }">click me</a>

        <div id="x123" data-bind="jayGrid: {source: Groups, itemStore: groups,
                               itemCommands: [ editObjectCommand, removeObjectCommand ]}">

        </div>
        <a href="#" data-bind="event: {click: addNew.bind($data, Groups) }">click me</a>

        <div data-bind="jayPropertyEditor: { objectToEdit: selectedObject, submitCommand: saveObjectCommand }, visible: propEditorVisible">
            !!!
        </div>
    </div>

    <div id="DatabaseManagerUI" data-bind="visible: visible">
        <!--<div id="x56" data-bind="jayGrid: {source: Databases, itemCommands: [ selectDatabaseCommand ]}">-->

        <!--</div>-->

        <div data-bind="jayPropertyEditor: { objectToEdit: selectedDatabase, submitCommand: saveObjectCommand },  visible: databaseEditorVisible">

        </div>


        <a href="#" data-bind="event: {click: addNew.bind($data, Databases) }">Add new db</a>

        <h1>Tables</h1>

        <h3 data-bind="with: selectedDatabase">
            <span data-bind="text: Name" />
        </h3>

        <h4 data-bind="text: selectedDatabaseName"></h4>

        <div data-bind="foreach: entitySets()">
            <a href="#"  data-bind="click: $root.selectSet, text: $data.collectionName"></a>
        </div>


        <div id="x567" data-bind="jayGrid: {
                        source: EntitySets,
                        pageSize: esPageSize,
                        discriminatorField: 'Database',
                        discriminatorValue: selectedDatabaseName}">

            <script type="text/html" data-type-template="Edm.String">
                <div style="background-color: silver" data-bind="text: $parent[name]"></div>
            </script>

            <script type="text/html" data-type-template="Edm.Boolean">
                <input type="checkbox" data-bind="checked: $parent[name]" disabled />
            </script>


            <script type="text/html" data-field-template="Roles">
                <div data-bind="text: $data"></div>
            </script>
        </div>

        <a href="#" data-bind="event: {click: addNew.bind($data, EntitySets) }">Add new db</a>

    </div>

</body>
</html>